<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>fuzz-in-pwn | ixout's blog</title><meta name="author" content="ixout"><meta name="copyright" content="ixout"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Scared">
<meta property="og:type" content="article">
<meta property="og:title" content="fuzz-in-pwn">
<meta property="og:url" content="https://ixout.github.io/posts/53981/index.html">
<meta property="og:site_name" content="ixout&#39;s blog">
<meta property="og:description" content="Scared">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/ixout/picture@main/img/865885b088167c2d2ec.png">
<meta property="article:published_time" content="2024-05-12T14:29:46.000Z">
<meta property="article:modified_time" content="2024-05-21T08:56:35.933Z">
<meta property="article:author" content="ixout">
<meta property="article:tag" content="fuzz">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/ixout/picture@main/img/865885b088167c2d2ec.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://ixout.github.io/posts/53981/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'fuzz-in-pwn',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-05-21 16:56:35'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/universe.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/js-heo@1.0.11/mainColor/heoMainColor.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/js-heo@1.0.11/poem/poem.css"><link rel="stylesheet" href="/css/footerb.css"><link rel="stylesheet" href="/css/bolang.css"><link rel="stylesheet" href="/css/jzbar.css"><link rel="stylesheet" href="/css/trans.css"><link rel="stylesheet" href="/css/gundongtiao.css"><link rel="stylesheet" href="/css/shubiao.css"><link rel="stylesheet" href="/css/fengche.css"><link rel="stylesheet" href="/css/alitubiao.css"><link rel="stylesheet" href="/css/fps.css"><span id="fps"></span><link rel="stylesheet" href="/css/yituliu.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="//at.alicdn.com/t/c/font_3930344_38rvofbfw64.css" media="defer" onload="this.media='all'"><svg aria-hidden="true" style="position:absolute; overflow:hidden; width:0; height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ixout's blog" type="application/atom+xml">
</head><body><div id="loading-box"><div class="pokeball-back"></div><div class="pokeball-loading"><div class="pokeball" id="pokeball-normal"></div><div class="pokeball" id="pokeball-great"></div><div class="pokeball" id="pokeball-ultra"></div><div class="pokeball" id="pokeball-master"></div><div class="pokeball" id="pokeball-safari"></div></div></div><script async="async">const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
document.getElementById('loading-box').addEventListener('click',()=> {preloader.endLoading()})
setTimeout(function(){preloader.endLoading();}, 7000);

if (false) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="/css/jzbar.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/touxiang.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">60</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">65</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-hanbao"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw iconfont icon-fenlei"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw iconfont icon-biaoqian"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw iconfont icon-youlian"></i><span> 友人帐</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-fantuan"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/ixout/picture@main/img/865885b088167c2d2ec.png')"><nav id="nav"><span id="blog-info"><a href="/" title="ixout's blog"><span class="site-name">ixout's blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-hanbao"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw iconfont icon-fenlei"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw iconfont icon-biaoqian"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw iconfont icon-youlian"></i><span> 友人帐</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-fantuan"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">fuzz-in-pwn</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-05-12T14:29:46.000Z" title="发表于 2024-05-12 22:29:46">2024-05-12</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-05-21T08:56:35.933Z" title="更新于 2024-05-21 16:56:35">2024-05-21</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/pwn/">pwn</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">5.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>24分钟</span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>在一些逆向难度较高的题目中,例如rust,go或cpp之类写就的题目,也许我们并不一定要花大量的时间去逆向搞懂程序到底是怎样的,漏洞又是怎么出现的</p>
<p>只需要找到稳定的触发漏洞的方法即可,那么在搞不清楚程序在干什么的情况下如何去找到漏洞,我们可以运用fuzz的思想,进行大量的测试,以此找到漏洞点</p>
<p>以几道题目为例学习一下思路</p>
<p><a target="_blank" rel="noopener" href="https://www.cjovi.icu/fuzzing/1589.html">BYTECTF2021-byteview - blog of chuj (cjovi.icu)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cjovi.icu/wp/1617.html">虎符网络安全赛道 2022-pwn-vdq-WP - blog of chuj (cjovi.icu)</a></p>
<p><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-273516.htm#msg_header_h1_2">从Fuzz到XCTF赛题-Pwn-看雪-安全社区|安全招聘|kanxue.com</a></p>
<p><a target="_blank" rel="noopener" href="https://kiprey.github.io/2021/09/protobuf_ctf_fuzz/">使用 protobuf &amp; AFLplusplus 进行简易 CTF 自动化 fuzz | Kiprey’s Blog</a></p>
<p>师傅们真是tql</p>
<h1 id="2022ACTF-treepwn"><a href="#2022ACTF-treepwn" class="headerlink" title="2022ACTF-treepwn"></a>2022ACTF-treepwn</h1><p>题目静态分析的话会有一大坨平衡树算法的代码</p>
<p>看得十分头大,不说要先学会相关数据结构,学会之后还要逆向分析出这个程序</p>
<p>着实有点难受了,这时候就可以使用模糊测试的思路进行漏洞挖掘</p>
<p>题目启动后是这样</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  [..                                                          </span><br><span class="line">  [..                                                          </span><br><span class="line">[.[. [.[. [...   [..       [..    [. [..  [..     [...[.. [..  </span><br><span class="line">  [..   [..    [.   [..  [.   [.. [.  [..  [..  .  [.. [..  [..</span><br><span class="line">  [..   [..   [..... [..[..... [..[.   [.. [.. [.  [.. [..  [..</span><br><span class="line">  [..   [..   [.        [.        [.. [..  [. [. [.[.. [..  [..</span><br><span class="line">   [.. [...     [....     [....   [..     [...    [...[...  [..</span><br><span class="line">                                  [..</span><br><span class="line">You can place some elements <span class="keyword">in</span> 0 - 4096 size square</span><br><span class="line"></span><br><span class="line">Choice Table</span><br><span class="line">[ 0 ] Place a element</span><br><span class="line">[ 1 ] Remove a element</span><br><span class="line">[ 2 ] Edit a element</span><br><span class="line">[ 3 ] Show a element</span><br><span class="line">[ 4 ] Query a element</span><br><span class="line">[ 5 ] Leave</span><br><span class="line">Your choice &gt; </span><br></pre></td></tr></table></figure>
<p>并且交互操作的逆向并不困难</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.os = <span class="string">&#x27;linux&#x27;</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cho</span>(<span class="params">num</span>):</span><br><span class="line">    r.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="built_in">str</span>(num))</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">x,y,name</span>):</span><br><span class="line">    cho(<span class="number">0</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;value: &quot;</span>,<span class="built_in">str</span>(x))</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;value: &quot;</span>,<span class="built_in">str</span>(y))</span><br><span class="line">    r.sendafter(<span class="string">&quot;new element name: &quot;</span>,name.ljust(<span class="number">0x20</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delet</span>(<span class="params">x,y</span>):</span><br><span class="line">    cho(<span class="number">1</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;want element x-coordinate value: &quot;</span>,<span class="built_in">str</span>(x))</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;want element y-coordinate value: &quot;</span>,<span class="built_in">str</span>(y))</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">x,y,name</span>):</span><br><span class="line">    cho(<span class="number">2</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;want element x-coordinate value: &quot;</span>,<span class="built_in">str</span>(x))</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;want element y-coordinate value: &quot;</span>,<span class="built_in">str</span>(y))</span><br><span class="line">    r.sendafter(<span class="string">&quot;name: &quot;</span>,name.ljust(<span class="number">0x20</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">x,y</span>):</span><br><span class="line">    cho(<span class="number">3</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&#x27;value&#x27;</span>,<span class="built_in">str</span>(x))</span><br><span class="line">    r.sendlineafter(<span class="string">&#x27;value&#x27;</span>,<span class="built_in">str</span>(y))</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">query</span>(<span class="params">a,b,c,d</span>):</span><br><span class="line">    cho(<span class="number">4</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;value: &quot;</span>,<span class="built_in">str</span>(a))</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;value: &quot;</span>,<span class="built_in">str</span>(b))</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;value: &quot;</span>,<span class="built_in">str</span>(c))</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;value: &quot;</span>,<span class="built_in">str</span>(d))</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fuzz</span>():</span><br><span class="line"> f=<span class="built_in">open</span>(<span class="string">&#x27;./log.txt&#x27;</span>,<span class="string">&#x27;w&#x27;</span>)</span><br><span class="line"> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x1000</span>):</span><br><span class="line">    <span class="keyword">if</span>(i%<span class="number">10</span>==<span class="number">0</span>):</span><br><span class="line">        a = randint(<span class="number">0</span>,<span class="number">8</span>)</span><br><span class="line">        b = randint(<span class="number">0</span>,<span class="number">8</span>)</span><br><span class="line">        add(a,b,<span class="built_in">str</span>(i)) </span><br><span class="line">        data0=r.recvuntil(<span class="string">&#x27;Choice Table&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;two many&#x27;</span> <span class="keyword">in</span> data0:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;aaa&#x27;</span>)</span><br><span class="line">            r.close()</span><br><span class="line">            <span class="keyword">break</span>           </span><br><span class="line">        f.write(<span class="string">&#x27; add(&#123;&#125;,&#123;&#125;,str(&#123;&#125;))\n&#x27;</span>.<span class="built_in">format</span>(a,b,i))</span><br><span class="line">    <span class="keyword">elif</span>(i%<span class="number">2</span>==<span class="number">0</span>):</span><br><span class="line">        a = randint(<span class="number">0</span>,<span class="number">8</span>)</span><br><span class="line">        b = randint(<span class="number">0</span>,<span class="number">8</span>)</span><br><span class="line">        delet(a,b)</span><br><span class="line">        data0=r.recvline()</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;not exists&#x27;</span> <span class="keyword">in</span> data0:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        f.write(<span class="string">&#x27; delet(&#123;&#125;,&#123;&#125;)\n&#x27;</span>.<span class="built_in">format</span>(a,b))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line"> f.close()</span><br><span class="line"> </span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>: </span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		r=process(<span class="string">&#x27;./treepwn&#x27;</span>)</span><br><span class="line">		fuzz()</span><br><span class="line">	<span class="keyword">except</span>:</span><br><span class="line">		<span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>之后通过分析log日志即可快速对点对应进行逆向分析</p>
<p>多跑几次就能出结果</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[DEBUG] Received 0x29 bytes:</span><br><span class="line">    <span class="string">&#x27;free(): double free detected in tcache 2\n&#x27;</span></span><br><span class="line">[*] Stopped process <span class="string">&#x27;./treepwn&#x27;</span> (pid 552537)</span><br></pre></td></tr></table></figure>
<h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><p>在进入下一题之前先安装一下环境</p>
<p>最主要的就是安装一下<a target="_blank" rel="noopener" href="https://github.com/thebabush/afl-libprotobuf-mutator">afl-libprotobuf-mutator</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/thebabush/afl-libprotobuf-mutator.git</span><br><span class="line"><span class="built_in">cd</span> afl-libprotobuf-mutator</span><br><span class="line">./build.sh</span><br></pre></td></tr></table></figure>
<p>这里有一个坑就是这个库有点久没维护了,导致其依赖的<a target="_blank" rel="noopener" href="https://github.com/google/libprotobuf-mutator">libprotobuf-mutator</a>已经迭代好几个版本了,如果直接安装会产生一大坨问题,例如C++标准不匹配,absl库依赖不对….</p>
<p>自己尝试了一下没能解决,于是认怂,选择安装旧版v1.0,就没有这些问题了</p>
<p>那么如何使用这个库?</p>
<p>首先需要我们根据题目的逆向分析,写出对应的proto文件<code>out.proto</code>,放置在<code>gen</code>目录</p>
<p>再配置afl-libprotobuf-mutator代码<code>mutator.cc</code>,放置在<code>src</code>目录</p>
<p>最后配置测试代码<code>dump.cc</code>,放置在<code>src</code>目录</p>
<p>之后执行<code>make</code>即可编译出三个对应文件</p>
<p>再然后执行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> AFL_CUSTOM_MUTATOR_ONLY=1</span><br><span class="line"><span class="built_in">export</span> AFL_CUSTOM_MUTATOR_LIBRARY=$(<span class="built_in">pwd</span>)/libmutator.so</span><br><span class="line"><span class="built_in">export</span> AFL_USE_QASAN=1</span><br></pre></td></tr></table></figure>
<p>即可开始Fuzz</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AFLplusplus/afl-fuzz -i input -o output -Q -- /pwd/binary</span><br></pre></td></tr></table></figure>
<p>更多可见README.md</p>
<h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><p>由于qemu-trace不支持内部 mmap 定向内存分配以及prctl 调用，会被直接 exit 掉，这样会出错,所以如果题目和这两个东西绑的比较深就用不了这种方法,当然可以通过patch掉相关代码以继续,但这样结果也就不甚准确了</p>
<h1 id="BYTECTF2021-byteview"><a href="#BYTECTF2021-byteview" class="headerlink" title="BYTECTF2021-byteview"></a>BYTECTF2021-byteview</h1><p>上一道题目,我们只是使用了fuzz的思路,但并没有真正的进行结构化fuzz</p>
<p>程序是C++写的,静态分析逆向的话较难看出漏洞</p>
<p>于是再次使用fuzz的思路去寻找漏洞</p>
<p>chuj师傅提供了两种方法</p>
<h2 id="利用AFLFUzz"><a href="#利用AFLFUzz" class="headerlink" title="利用AFLFUzz"></a>利用AFLFUzz</h2><p>首先根据题目的逆向写出对应的proto文件,只要有一个模板照着改改就是了</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto2&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> menuctf;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">New_content</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">required</span> <span class="type">int32</span> choice_id = <span class="number">1</span> [default = <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">required</span> <span class="type">int32</span> sum_of_datas = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">message </span><span class="title class_">data</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">required</span> <span class="type">int32</span> key = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">required</span> <span class="type">int32</span> size = <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">repeated</span> data datas = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">Edit_message</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">required</span> <span class="type">int32</span> choice_id = <span class="number">1</span> [default = <span class="number">2</span>];</span><br><span class="line">    <span class="keyword">required</span> <span class="type">int32</span> key = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">required</span> <span class="type">string</span> content = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">Show_message</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">required</span> <span class="type">int32</span> choice_id = <span class="number">1</span> [default = <span class="number">3</span>];</span><br><span class="line">    <span class="keyword">required</span> <span class="type">int32</span> key = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">Old_content</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">required</span> <span class="type">int32</span> choice_id = <span class="number">1</span> [default = <span class="number">4</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">Content_info</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">required</span> <span class="type">int32</span> choice_id = <span class="number">1</span> [default = <span class="number">5</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">Exit</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">required</span> <span class="type">int32</span> choice_id = <span class="number">1</span> [default = <span class="number">6</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">Choices</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">message </span><span class="title class_">Choice</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">oneof</span> all_choices</span><br><span class="line">        &#123;</span><br><span class="line">            New_content new_content = <span class="number">1</span>;</span><br><span class="line">            Edit_<span class="keyword">message </span><span class="title class_">edit_message</span> = <span class="number">2</span>;</span><br><span class="line">            Show_<span class="keyword">message </span><span class="title class_">show_message</span> = <span class="number">3</span>;</span><br><span class="line">            Old_content old_content = <span class="number">4</span>;</span><br><span class="line">            Content_info content_info = <span class="number">5</span>; </span><br><span class="line">            Exit exit = <span class="number">6</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">repeated</span> Choice choice = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于CTF题来说，大多都是直接从 stdin 中获取输入的<strong>文本数据</strong>。因此首先，我们需要编写 <code>Protobuf::Message</code> 转<strong>常规输入字符串</strong>的代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">ProtoToDataHelper</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">stringstream</span> &amp;out, <span class="type">const</span> google::protobuf::Message &amp;msg)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">const</span> google::protobuf::Descriptor *desc = msg.GetDescriptor();</span><br><span class="line">	<span class="type">const</span> google::protobuf::Reflection *refl = msg.GetReflection();</span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> <span class="type">unsigned</span> fields = desc-&gt;field_count();</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">unsigned</span> i = <span class="number">0</span>; i &lt; fields; ++i)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">const</span> google::protobuf::FieldDescriptor *field = desc-&gt;field(i);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (field-&gt;cpp_type() == google::protobuf::FieldDescriptor::CPPTYPE_MESSAGE)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (field-&gt;is_repeated())</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">// maybe choice list or data list</span></span><br><span class="line">				<span class="type">const</span> google::protobuf::RepeatedFieldRef&lt;google::protobuf::Message&gt; &amp;ptr = refl-&gt;GetRepeatedFieldRef&lt;google::protobuf::Message&gt;(msg, field);</span><br><span class="line">				<span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span> &amp;child : ptr)</span><br><span class="line">				&#123;</span><br><span class="line">					ProtoToDataHelper(out, child);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (refl-&gt;HasField(msg, field))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">// maybe one choice or one data</span></span><br><span class="line">				<span class="type">const</span> google::protobuf::Message &amp;child = refl-&gt;GetMessage(msg, field);</span><br><span class="line">				ProtoToDataHelper(out, child);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (field-&gt;cpp_type() ==</span><br><span class="line">				 google::protobuf::FieldDescriptor::CPPTYPE_INT32)</span><br><span class="line">		&#123;</span><br><span class="line">			out.width(<span class="number">8</span>);</span><br><span class="line">			out &lt;&lt; refl-&gt;GetInt32(msg, field);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (field-&gt;cpp_type() ==</span><br><span class="line">				 google::protobuf::FieldDescriptor::CPPTYPE_STRING)</span><br><span class="line">		&#123;</span><br><span class="line">			out &lt;&lt; refl-&gt;GetString(msg, field) &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">abort</span>();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数的主要功能是将protobuf消息的各个字段转换为字符串，并将其输出到一个字符串流中。它支持嵌套消息和重复字段。</p>
<p>由于目标程序使用 read 读入，所以最好填充满 read，所以这里在对 int32 进行输出的时候，设置了 8 的场宽，填充空格即可，因为程序使用 strtol 这类的函数，所以仍然可以正常输入,因为如果不这样的话,下一次的数据可能被同一个read读走</p>
<details class="folding-tag" cyan><summary> 更多关于此函数 </summary>
              <div class='content'>
              <p><strong>具体例子</strong></p><p>假设我们有以下 Protobuf 消息定义：</p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">Data</span> &#123;</span><br><span class="line">    <span class="type">int32</span> id = <span class="number">1</span>;</span><br><span class="line">    <span class="type">string</span> content = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">Container</span> &#123;</span><br><span class="line">    <span class="keyword">repeated</span> Data items = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们创建一个包含一些数据的 <code>Container</code> 对象：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Container container;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; ++i) &#123;</span><br><span class="line">    Data* data = container.<span class="built_in">add_items</span>();</span><br><span class="line">    data-&gt;<span class="built_in">set_id</span>(i);</span><br><span class="line">    data-&gt;<span class="built_in">set_content</span>(<span class="string">&quot;Content &quot;</span> + std::<span class="built_in">to_string</span>(i));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们调用 <code>ProtoToDataHelper</code> 函数处理这个对象：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">std::stringstream stream;</span><br><span class="line"><span class="built_in">ProtoToDataHelper</span>(stream, container);</span><br><span class="line">std::string result = stream.<span class="built_in">str</span>();</span><br></pre></td></tr></table></figure><p>我们来详细看一下 <code>ProtoToDataHelper</code> 函数的执行过程：</p><p><strong>执行步骤</strong></p><ol><li><strong>获取描述符和反射器</strong>：</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> google::protobuf::Descriptor *desc = msg.<span class="built_in">GetDescriptor</span>();</span><br><span class="line"><span class="type">const</span> google::protobuf::Reflection *refl = msg.<span class="built_in">GetReflection</span>();</span><br></pre></td></tr></table></figure><p>这两行代码获取 Protobuf 消息的描述符和反射器，用于遍历消息字段。</p><ol><li><strong>遍历所有字段</strong>：</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">unsigned</span> fields = desc-&gt;<span class="built_in">field_count</span>();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">unsigned</span> i = <span class="number">0</span>; i &lt; fields; ++i) &#123;</span><br><span class="line">    <span class="type">const</span> google::protobuf::FieldDescriptor *field = desc-&gt;<span class="built_in">field</span>(i);</span><br></pre></td></tr></table></figure><p>这段代码获取消息的字段数量，并逐个遍历每个字段。</p><ol><li><strong>处理嵌套消息</strong>：</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (field-&gt;<span class="built_in">cpp_type</span>() == google::protobuf::FieldDescriptor::CPPTYPE_MESSAGE) &#123;</span><br><span class="line">    <span class="keyword">if</span> (field-&gt;<span class="built_in">is_repeated</span>()) &#123;</span><br><span class="line">        <span class="type">const</span> google::protobuf::RepeatedFieldRef&lt;google::protobuf::Message&gt; &amp;ptr = refl-&gt;<span class="built_in">GetRepeatedFieldRef</span>&lt;google::protobuf::Message&gt;(msg, field);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span> &amp;child : ptr) &#123;</span><br><span class="line">            <span class="built_in">ProtoToDataHelper</span>(out, child);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (refl-&gt;<span class="built_in">HasField</span>(msg, field)) &#123;</span><br><span class="line">        <span class="type">const</span> google::protobuf::Message &amp;child = refl-&gt;<span class="built_in">GetMessage</span>(msg, field);</span><br><span class="line">        <span class="built_in">ProtoToDataHelper</span>(out, child);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果字段是嵌套消息且是重复的，函数递归地处理每个子消息。如果字段是单个嵌套消息，且已设置，递归处理这个子消息。</p><p>在我们的例子中，<code>container</code> 有一个重复的嵌套消息 <code>items</code>，所以它会递归处理每个 <code>Data</code> 消息。</p><ol><li><strong>处理其他类型字段</strong>：</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">else if (field-&gt;cpp_type() == google::protobuf::FieldDescriptor::CPPTYPE_INT32) &#123;</span><br><span class="line">    out.width(8);</span><br><span class="line">    out &lt;&lt; refl-&gt;GetInt32(msg, field);</span><br><span class="line">&#125; else if (field-&gt;cpp_type() == google::protobuf::FieldDescriptor::CPPTYPE_STRING) &#123;</span><br><span class="line">    out &lt;&lt; refl-&gt;GetString(msg, field) &lt;&lt; &quot;\n&quot;;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    abort();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果字段是 <code>int32</code> 类型，提取其值并写入 <code>stringstream</code>。如果字段是 <code>string</code> 类型，也提取其值并写入 <code>stringstream</code>。如果遇到其他类型的字段，则程序终止。</p><p><strong>示例输出</strong></p><p>对于上述示例数据，<code>ProtoToDataHelper</code> 函数会生成如下输出：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0Content 0</span><br><span class="line">1Content 1</span><br><span class="line">2Content 2</span><br></pre></td></tr></table></figure><p>解释一下：</p><ul><li><code>ProtoToDataHelper</code> 递归处理 <code>Container</code> 消息。</li><li>它发现 <code>items</code> 字段是一个重复的嵌套消息，依次处理每个 <code>Data</code> 消息。</li><li>对每个 <code>Data</code> 消息，提取 <code>id</code> 和 <code>content</code> 字段并写入 <code>stringstream</code>。</li></ul>
              </div>
            </details>
<p>所以，<code>ProtoToDataHelper</code> 函数的主要作用是遍历 Protobuf 消息，提取数据并以特定格式写入到 <code>stringstream</code>，方便后续处理或输出。</p>
<p>此外,<code>mutator.cc</code> 中还需要实现 AFLplusplus 需要的 API,所以我们需要针对mutator完善一些函数, <a target="_blank" rel="noopener" href="https://github.com/AFLplusplus/AFLplusplus/blob/dev/docs/custom_mutators.md">Custom Mutators in AFL++</a></p>
<ul>
<li><code>void *afl_custom_init(void *afl, unsigned int seed)</code>：在执行 custom mutate 前需要执行的初始化操作，这里只需初始化一下随机种子。</li>
<li><code>size_t afl_custom_fuzz(void *data, unsigned char *buf, size_t buf_size, unsigned char **out_buf, unsigned char *add_buf, size_t add_buf_size, size_t max_size)</code> ：变异逻辑，在该代码中编写自己的变异逻辑。</li>
<li><code>size_t afl_custom_post_process(void* data, uint8_t *buf, size_t buf_size, uint8_t **out_buf)</code>：将 protobuf::Message 格式的二进制数据转换成 target 可读的数据。</li>
<li><code>void afl_custom_deinit(void *data)</code>：变异完成后需要做的事情，目前没有什么事情需要在这里进行处理。</li>
<li><code>int32_t afl_custom_init_trim(void *data, uint8_t *buf, size_t buf_size)</code>：自定义 trim 逻辑的初始化。为了<strong>防止 trim 逻辑破坏 protobuf::Message 的二进制数据</strong>，影响正常的 Parse 过程，这里可以让该函数直接返回0，跳过每次的 trim 阶段。</li>
<li><code>size_t afl_custom_trim(void *data, uint8_t **out_buf)</code>：自定义 trim 逻辑。由于<code>afl_custom_init_trim</code>函数返回0，因此实际上该函数不会被调用，但我们仍然必须声明该函数以启用自定义 trim 逻辑。</li>
</ul>
<p>即</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">static</span> <span class="built_in">std</span>::default_random_engine engine_pro;</span><br><span class="line">	<span class="type">static</span> <span class="built_in">std</span>::uniform_int_distribution&lt;<span class="type">unsigned</span> <span class="type">int</span>&gt; <span class="title function_">dis</span><span class="params">(<span class="number">0</span>, UINT32_MAX)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">void</span> *<span class="title function_">afl_custom_init</span><span class="params">(<span class="type">void</span> *afl, <span class="type">unsigned</span> <span class="type">int</span> seed)</span></span><br><span class="line">	&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> unused(afl)</span></span><br><span class="line">		engine_pro.seed(seed);</span><br><span class="line">		<span class="keyword">return</span> nullptr;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">void</span> <span class="title function_">afl_custom_deinit</span><span class="params">(<span class="type">void</span> *data)</span></span><br><span class="line">	&#123;</span><br><span class="line">		assert(!data);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">size_t</span> <span class="title function_">afl_custom_fuzz</span><span class="params">(<span class="type">void</span> *data, <span class="type">unsigned</span> <span class="type">char</span> *buf, <span class="type">size_t</span> buf_size, <span class="type">unsigned</span> <span class="type">char</span> **out_buf,</span></span><br><span class="line"><span class="params">						   <span class="type">unsigned</span> <span class="type">char</span> *add_buf, <span class="type">size_t</span> add_buf_size, <span class="type">size_t</span> max_size)</span></span><br><span class="line">	&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> unused(data)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> unused(buf)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> unused(buf_size)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> unused(add_buf)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> unused(add_buf_size)</span></span><br><span class="line"></span><br><span class="line">		menuctf::Choices msg;</span><br><span class="line">		<span class="built_in">std</span>::random_device rd;</span><br><span class="line"></span><br><span class="line">		<span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">while</span> (i++ &lt; <span class="number">100</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (rd() % <span class="number">100</span> &gt; <span class="number">80</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				exit_choice(msg);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">switch</span> (rd() % <span class="number">5</span>)</span><br><span class="line">			&#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">				new_content(msg);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">				edit_message(msg);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">				show_message(msg);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">				old_content(msg);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">				content_info(msg);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="type">static</span> <span class="type">uint8_t</span> *saved_buf = nullptr;</span><br><span class="line"></span><br><span class="line">		assert(buf_size &lt;= max_size);</span><br><span class="line"></span><br><span class="line">		<span class="type">uint8_t</span> *new_buf = (<span class="type">uint8_t</span> *)<span class="built_in">realloc</span>((<span class="type">void</span> *)saved_buf, max_size);</span><br><span class="line">		saved_buf = new_buf;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">std</span>::<span class="built_in">string</span> serialize_data;</span><br><span class="line">		msg.SerializePartialToString(&amp;serialize_data);</span><br><span class="line">		<span class="built_in">memcpy</span>(new_buf, serialize_data.c_str(), msg.ByteSizeLong());</span><br><span class="line">		*out_buf = new_buf;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> msg.ByteSizeLong();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">size_t</span> <span class="title function_">afl_custom_post_process</span><span class="params">(<span class="type">void</span> *data, <span class="type">uint8_t</span> *buf, <span class="type">size_t</span> buf_size, <span class="type">uint8_t</span> **out_buf)</span></span><br><span class="line">	&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> unused(data)</span></span><br><span class="line">		<span class="comment">// new_data is never free&#x27;d by pre_save_handler</span></span><br><span class="line">		<span class="comment">// I prefer a slow but clearer implementation for now</span></span><br><span class="line"></span><br><span class="line">		<span class="type">static</span> <span class="type">uint8_t</span> *saved_buf = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">		menuctf::Choices msg;</span><br><span class="line">		<span class="built_in">std</span>::<span class="built_in">stringstream</span> stream;</span><br><span class="line">		<span class="comment">// 如果加载成功</span></span><br><span class="line">		<span class="keyword">if</span> (protobuf_mutator::libfuzzer::LoadProtoInput(<span class="literal">true</span>, buf, buf_size, &amp;msg))</span><br><span class="line">		&#123;</span><br><span class="line">			ProtoToDataHelper(stream, msg);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 如果加载失败，则返回 Exit Choice</span></span><br><span class="line">			<span class="comment">/// <span class="doctag">NOTE:</span> 错误的变异 + 错误的 trim 将会导致 post process 加载失败，尤其是 trim 逻辑。</span></span><br><span class="line">			<span class="comment">/// <span class="doctag">TODO:</span> 由于默认的 trim 会破坏样例，因此需要手动实现一个 trim，这里实现了一个空 trim，不进行任何操作</span></span><br><span class="line">			ProtoToDataHelper(stream, menuctf::Exit());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> str = stream.str();</span><br><span class="line"></span><br><span class="line">		<span class="type">uint8_t</span> *new_buf = (<span class="type">uint8_t</span> *)<span class="built_in">realloc</span>((<span class="type">void</span> *)saved_buf, str.size());</span><br><span class="line">		<span class="keyword">if</span> (!new_buf)</span><br><span class="line">		&#123;</span><br><span class="line">			*out_buf = buf;</span><br><span class="line">			<span class="keyword">return</span> buf_size;</span><br><span class="line">		&#125;</span><br><span class="line">		*out_buf = saved_buf = new_buf;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">memcpy</span>((<span class="type">void</span> *)new_buf, str.c_str(), str.size());</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> str.size();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">int32_t</span> <span class="title function_">afl_custom_init_trim</span><span class="params">(<span class="type">void</span> *data, <span class="type">uint8_t</span> *buf, <span class="type">size_t</span> buf_size)</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">/// <span class="doctag">NOTE:</span> disable trim</span></span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">size_t</span> <span class="title function_">afl_custom_trim</span><span class="params">(<span class="type">void</span> *data, <span class="type">uint8_t</span> **out_buf)</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">/// <span class="doctag">NOTE:</span> unreachable</span></span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中用到了不少protobuf的cpp接口,可以参考<a target="_blank" rel="noopener" href="https://protobuf.dev/reference/cpp/cpp-generated/#fields">https://protobuf.dev/reference/cpp/cpp-generated/#fields</a></p>
<p><code>afl_custom_post_process</code> 函数的主要作用是对 AFL变异后的输入数据进行后处理。它试图将变异后的输入数据转换为可读格式,利用前面提到的ProtoToDataHelper,并输出</p>
<p>然后是dumpcc的代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;libprotobuf-mutator/src/libfuzzer/libfuzzer_macro.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;gen/out.pb.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;mutator.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">inline</span> <span class="built_in">std</span>::<span class="built_in">string</span> <span class="title function_">slurp</span><span class="params">(<span class="type">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;path)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">ostringstream</span> buf;</span><br><span class="line">	<span class="built_in">std</span>::ifstream <span class="title function_">input</span><span class="params">(path.c_str())</span>;</span><br><span class="line">	buf &lt;&lt; input.rdbuf();</span><br><span class="line">	<span class="keyword">return</span> buf.str();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">void</span> *<span class="title function_">afl_custom_init</span><span class="params">(<span class="type">void</span> *afl, <span class="type">unsigned</span> <span class="type">int</span> seed)</span>;</span><br><span class="line">	<span class="type">size_t</span> <span class="title function_">afl_custom_fuzz</span><span class="params">(<span class="type">void</span> *data, <span class="type">unsigned</span> <span class="type">char</span> *buf, <span class="type">size_t</span> buf_size, <span class="type">unsigned</span> <span class="type">char</span> **out_buf,</span></span><br><span class="line"><span class="params">						   <span class="type">unsigned</span> <span class="type">char</span> *add_buf, <span class="type">size_t</span> add_buf_size, <span class="type">size_t</span> max_size)</span>;</span><br><span class="line">	<span class="type">size_t</span> <span class="title function_">afl_custom_post_process</span><span class="params">(<span class="type">void</span> *data, <span class="type">uint8_t</span> *buf, <span class="type">size_t</span> buf_size, <span class="type">uint8_t</span> **out_buf)</span>;</span><br><span class="line">	<span class="type">void</span> <span class="title function_">afl_custom_deinit</span><span class="params">(<span class="type">void</span> *data)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">	menuctf::Choices msg;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 测试变异逻辑</span></span><br><span class="line">	<span class="type">int</span> rand_fd;</span><br><span class="line">	<span class="keyword">if</span> ((rand_fd = open(<span class="string">&quot;/dev/random&quot;</span>, O_RDONLY)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">abort</span>();</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> seed;</span><br><span class="line">	read(rand_fd, &amp;seed, <span class="keyword">sizeof</span>(seed));</span><br><span class="line">	close(rand_fd);</span><br><span class="line"></span><br><span class="line">	<span class="type">void</span> *init_data = afl_custom_init(nullptr, seed);</span><br><span class="line">	<span class="keyword">if</span> (argc &gt; <span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">&quot;gen&quot;</span>))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="type">uint8_t</span> *out_buf = nullptr;</span><br><span class="line">			<span class="type">size_t</span> new_size = afl_custom_fuzz(nullptr, nullptr, <span class="number">0</span>,</span><br><span class="line">												&amp;out_buf, nullptr, <span class="number">0</span>, <span class="number">0x2000</span>);</span><br><span class="line">			<span class="type">uint8_t</span> *new_str = nullptr;</span><br><span class="line">			<span class="type">size_t</span> new_str_size = afl_custom_post_process(init_data, out_buf, new_size, &amp;new_str);</span><br><span class="line">			<span class="built_in">std</span>::<span class="built_in">string</span> <span class="title function_">new_str_str</span><span class="params">((<span class="type">char</span> *)new_str, new_str_size)</span>;</span><br><span class="line">			<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; new_str_str &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span></span><br><span class="line">						&lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">&quot;-d&quot;</span>) &amp;&amp; argc &gt; <span class="number">2</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">statbuf</span>;</span></span><br><span class="line">			stat(argv[<span class="number">2</span>], &amp;statbuf);</span><br><span class="line">			<span class="type">int</span> proto_size = statbuf.st_size;</span><br><span class="line"></span><br><span class="line">			<span class="type">char</span>* proto_buf = new <span class="type">char</span> [proto_size + <span class="number">1</span>];</span><br><span class="line">			</span><br><span class="line">			FILE* proto_fp = fopen(argv[<span class="number">2</span>], <span class="string">&quot;r&quot;</span>);</span><br><span class="line">			<span class="keyword">if</span> (!proto_fp) &#123; <span class="keyword">return</span> <span class="number">-1</span>; &#125;</span><br><span class="line">			fread(proto_buf, proto_size, <span class="number">1</span>, proto_fp);</span><br><span class="line"></span><br><span class="line">			menuctf::Choices msg;</span><br><span class="line">			<span class="built_in">std</span>::<span class="built_in">stringstream</span> stream;</span><br><span class="line">			<span class="comment">// 如果加载成功</span></span><br><span class="line">			<span class="keyword">if</span> (protobuf_mutator::libfuzzer::LoadProtoInput(<span class="literal">true</span>, (<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *) proto_buf, proto_size, &amp;msg))</span><br><span class="line">			&#123;</span><br><span class="line">				ProtoToDataHelper(stream, msg);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; stream.str();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="type">uint8_t</span> *out_buf = nullptr;</span><br><span class="line">			<span class="type">size_t</span> new_size = afl_custom_fuzz(nullptr, nullptr, <span class="number">0</span>,</span><br><span class="line">												&amp;out_buf, nullptr, <span class="number">0</span>, <span class="number">0x2000</span>);</span><br><span class="line">			<span class="type">uint8_t</span> *new_str = nullptr;</span><br><span class="line">			<span class="type">size_t</span> new_str_size = afl_custom_post_process(init_data, out_buf, new_size, &amp;new_str);</span><br><span class="line">			<span class="built_in">std</span>::<span class="built_in">string</span> <span class="title function_">new_str_str</span><span class="params">((<span class="type">char</span> *)new_str, new_str_size)</span>;</span><br><span class="line">			<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; i &lt;&lt; <span class="string">&quot; =============== &quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">			<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; new_str_str &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span></span><br><span class="line">						&lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	afl_custom_deinit(init_data);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// std::cout &lt;&lt; &quot;msg DebugString: &quot; &lt;&lt; msg.DebugString() &lt;&lt; std::endl;</span></span><br><span class="line"><span class="comment">//	std::stringstream stream;</span></span><br><span class="line"><span class="comment">//	ProtoToDataHelper(stream, msg);</span></span><br><span class="line"><span class="comment">//	std::cout &lt;&lt; stream.str() &lt;&lt; std::endl;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我滴读写代码能力太差了,这几段代码理解的有点困难 orz,得找个时候认真看研究一下afl和protobuf了</p>
<p>之后做一些准备工作就可以开始fuzz了</p>
<p>input 文件夹需要自己新建，input 里面用 dumper 随便生成一个语料即可</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">afl-fuzz -i input -o output -Q -- ./byteview</span><br></pre></td></tr></table></figure>
<p>之后不一会就可以看到出现了crash,tql</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/ixout/picture@main/img/2024-05-19_220452.png" alt=""></p>
<p>然后chuj大佬提到了产出的crash需要进行dumper -d转为可读形式</p>
<p>但试了一下不知道为什么没有输出,反而直接将crash作为输入能够导致崩溃,且看了一下与dumper gen生成的poc好像是一个形式,恩,对protobuf还不是很熟悉,先这样吧</p>
<p>作为输入测试,可以看到在too many后崩了,之后顺着这个分析应该就行了</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">choice:</span><br><span class="line">how many data <span class="keyword">do</span> you want to add:</span><br><span class="line">too many!</span><br><span class="line">//-----------------//</span><br><span class="line">1. new content</span><br><span class="line">2. edit message</span><br><span class="line">3. show message</span><br><span class="line">4. old content</span><br><span class="line">5. content info</span><br><span class="line">6. <span class="built_in">exit</span></span><br><span class="line">choice:</span><br><span class="line"></span><br><span class="line">Program received signal SIGSEGV, Segmentation fault.</span><br><span class="line">0x0000555555562010 <span class="keyword">in</span> ?? ()</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">─────────────────────[ REGISTERS / show-flags off / show-compact-regs off ]─────────────────────</span><br><span class="line">*RAX  0x555555562010 ◂— 0x0</span><br><span class="line">*RBX  0x7fffffffdb28 —▸ 0x555555574260 ◂— 0x0</span><br><span class="line">*RCX  0x55555555a140 ◂— 0xffffd6f0ffffd518</span><br><span class="line">*RDX  0x555555558dc0 (content::<span class="built_in">set</span>()) ◂— endbr64 </span><br><span class="line">*RDI  0x5555555741d0 —▸ 0x555555574280 ◂— 0x0</span><br><span class="line"> RSI  0x0</span><br><span class="line">*R8   0x555555574260 ◂— 0x0</span><br><span class="line"> R9   0x0</span><br><span class="line">*R10  0x7ffff7d5eac0 (_nl_C_LC_CTYPE_toupper+512) ◂— 0x100000000</span><br><span class="line">*R11  0x7ffff7d5f3c0 (_nl_C_LC_CTYPE_class+256) ◂— 0x2000200020002</span><br><span class="line">*R12  0x7fffffffdb30 ◂— <span class="string">&#x27;   2    &#x27;</span></span><br><span class="line">*R13  0x555555573eb0 —▸ 0x5555555741d0 —▸ 0x555555574280 ◂— 0x0</span><br><span class="line">*R14  0x7fffffffdb28 —▸ 0x555555574260 ◂— 0x0</span><br><span class="line">*R15  0xffffffff0000</span><br><span class="line">*RBP  0x5555555741d0 —▸ 0x555555574280 ◂— 0x0</span><br><span class="line">*RSP  0x7fffffffda88 —▸ 0x555555557f45 (task_handle(std::unique_ptr&lt;page_hander, std::default_delete&lt;page_hander&gt; &gt;)+3749) ◂— <span class="built_in">test</span> al, al</span><br><span class="line">*RIP  0x555555562010 ◂— 0x0</span><br><span class="line">──────────────────────────────[ DISASM / x86-64 / <span class="built_in">set</span> <span class="built_in">emulate</span> on ]──────────────────────────────</span><br><span class="line"> ► 0x555555562010    add    byte ptr [rax], al</span><br><span class="line">    ↓</span><br><span class="line">   0x555555562010   add    byte ptr [rax], al</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">xxd <span class="built_in">id</span>\:000000\,sig\:11\,src\:000000\,time\:1804\,execs\:69\,op\:quick\,pos\:8 </span><br><span class="line">00000000: 2020 2020 2020 2031 8720 2036 2020 2020         1.  6    </span><br><span class="line">00000010: 2020 2030 2020 2020 2020 3631 2020 2020     0      61    </span><br><span class="line">00000020: 2020 2031 2020 2020 2031 3937 2020 2020     1     197    </span><br><span class="line">00000030: 2020 2032 2020 2020 2031 3332 2020 2020     2     132    </span><br><span class="line">00000040: 2020 2033 2020 2020 2020 3839 2020 2020     3      89    </span><br><span class="line">00000050: 2020 2034 2020 2020 2031 3831 2020 2020     4     181    </span><br><span class="line">00000060: 2020 2035 2020 2020 2031 3230 2020 2020     5     120    </span><br><span class="line">00000070: 2020 2036                                   6</span><br></pre></td></tr></table></figure>
<h2 id="非标准fuzz"><a href="#非标准fuzz" class="headerlink" title="非标准fuzz"></a>非标准fuzz</h2><p>只需要一个能随机生成语料的引擎，然后一直把语料喂给目标就可以了，所以只要一个简单的 shell 脚本就可以了</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">while</span> ((<span class="number">1</span>))</span><br><span class="line"><span class="keyword">do</span> </span><br><span class="line">    ./dumper gen &gt; poc</span><br><span class="line">    <span class="built_in">cat</span> poc | ./byteview</span><br><span class="line">    <span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">break</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p>不过这个没有用 qasan，找不出 UAF 这样可能不会 crash 的洞，可以使用 qasan 可能会更快的发现</p>
<p>大佬的总结</p>
<blockquote>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li><p>如果要用 qasan，直接用 AFLplusplus 的 qemu-mode 起可能会更方便</p>
</li>
<li><p>如果要使用真正的 AFLplusplus + protobuf 实现基于覆盖率的结构化感知 fuzz，那么在实现</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">afl_custom_fuzz</span><br></pre></td></tr></table></figure>
<p>时可以用 libprotobuf-mutator 提供的变异器对输入的数据（序列化的 protobuf）进行变异，然后通过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">afl_custom_post_process</span><br></pre></td></tr></table></figure>
<p>筛选变异的数据，对于可以反序列化的数据反序列化并格式化为目标程序可以接受的输入。对于 byteview 这题，由于 new_content 中的 datas 的个数与 sum_of_datas 有关，其实也可以在这里筛选正确的变异结果。注意这种情况下需要提供正确的语料，可以用 dumper 输出序列化的 protobuf 来构造语料。</p>
<ul>
<li>对于这种方法，我个人认为并不高效，我个人不太信任 libprotobuf-mutator 的变异效果。不过如果尝试对 byteview 这题进行这样的测试，有可能会发现效率非常高，也可能会发现效率非常低。为什么会出现这种结果？因为这种情况下是基于语料库进行变异的，语料库的质量决定了 fuzz 的速度，而实际上随机生成一个语料，还是有比较高的概率产生可以让目标程序直接 crash，或者稍微变异一下就 crash 的语料的（也就是很容易就产出超高质量的语料）。</li>
</ul>
</li>
<li><p>关于 <code>AFL_CUSTOM_MUTATOR_ONLY</code> 的设置与否，如果不设置该变量，用户提供的变异器只会在 havoc 阶段（undetermined mutate 的第一个阶段）前进行一次变异，其余情况会由 AFL 进行变异，我觉得由 AFL 直接对序列化的数据进行变异，可能会变异出无意义的数据，应当全权交给 libprotobuf-mutator 来变异，所以感觉还是需要设置的。</p>
</li>
</ul>
<h3 id="不足与改进"><a href="#不足与改进" class="headerlink" title="不足与改进"></a>不足与改进</h3><p>如前文所述，这种 fuzz 方式（也就是用 qasan + 结构化随机输入）非常适合找出 CTF 传统堆题由申请释放触发的 UAF 等漏洞的 poc。不足主要在于</p>
<ul>
<li>如果目标程序使用了 read 等对输入要求较高的读取函数时（即对非法输入的鲁棒性较差），需要多花点时间对输入进行格式化，避免非法输入导致程序爆炸</li>
<li>对于触发条件比较微妙的漏洞可能会比较难以发现。</li>
<li>适配工作比较多，会浪费很多时间</li>
</ul>
<p>所以其实，这种 fuzz 方法最适合的就是漏洞本身很简单，但是程序比较难以分析的题目。这种题没做出来会在赛后给选手很大的心理伤害，在赛时无路可走了，也不妨尝试乱 fuzz 一下，也可以少点遗憾。</p>
<p>如果要改进，我个人的想法有如下：</p>
<ul>
<li>使用 libprotobuf-mutator 进行变异，并且自己重写 mutator 方法，实现对变异更精确的控制</li>
<li>真正与 AFL 整合，也就是提供给 AFL 进行变异的语料应当是反序列化的数据，这样可以利用 AFL 提供的变异算法，可能可以达到更高的覆盖率，也许可以发现一些比较“subtle”的洞。然后我们在 havoc 阶段前进行结构化的变异，指导 AFL 生成高度结构化的输入。不过如果让 AFL 进行变异，可能需要目标程序有较高的鲁棒性（毕竟 ctf 题不是工业程序，乱输一气程序会炸并不影响选手拿不到 flag）。</li>
<li>关于溢出类型的洞，可以对变异器的 size 要进行变异，生成可能会超过 buf 的 string，从修改的角度来看这其实没啥难度，这里没这么做，主要原因是目标程序鲁棒性较差，并且分析的时候也看得出来是不会有溢出的。换句话说，如果有溢出的洞，ctf 中一般是能直接看出来的，那也没必要去搞什么 fuzz，花里胡哨的没必要，有这个适配的时间估计硬看也能看出来了。不过对于 realworld 的东西，感觉不妨一试。</li>
</ul>
</blockquote>
<h1 id="虎符安全2022-vdq"><a href="#虎符安全2022-vdq" class="headerlink" title="虎符安全2022-vdq"></a>虎符安全2022-vdq</h1><p>rust语言写的程序,静态分析应该也是很难的</p>
<p>说实话怎么交互都需要研究半天,不过好在没有去除符号,结合调试以及gpt的话至少能整明白交互方式(没有rust基础依然不是很容易orz)</p>
<p>一些rust方法可以参考<a target="_blank" rel="noopener" href="https://rustwiki.org/zh-CN/std/">std - Rust (rustwiki.org)</a></p>
<p>在<code>vdq::get_opr_lst</code>中有一个循环不停的读取行,每一次会判断是否以<code>$</code>符号开始</p>
<p>如果是的话则结束读取,不是的话则累积到一个字符串中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">v8 = <span class="string">&quot;$Cached notes:\nArchive note []\nAppend with message : \nRemoved note [&quot;</span>;</span><br><span class="line">v9 = <span class="number">1LL</span>;<span class="comment">//指定字符串比较长度</span></span><br><span class="line">v5.data_ptr = (u8 *)v6;</span><br><span class="line">v5.length = (usize)v15;</span><br><span class="line"><span class="keyword">if</span> ( core::str::_$LT$impl$u20$str$GT$::starts_with::he12bd255c6661204(v5, *(_str *)&amp;v8) )</span><br><span class="line">&#123;</span><br><span class="line">  core::ptr::drop_in_place::h651d4c9afc9ff69a(&amp;v26);</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后就进入反序列化环节<code>serde_json::de::from_str::h2ed086b1a84205ca(&amp;v29, v12);</code></p>
<p>这里看不出什么,但程序之后的运行就取决于这个函数的返回结果,所以进入看看,因为是反序列化的函数所以内容稍微有一点复杂</p>
<p>不过可以看到其返回值</p>
<p><code>return (core::result::Result&lt;alloc::vec::Vec&lt;vdq::Operation&gt;,serde_json::error::Error&gt; *)read.delegate.slice.data_ptr;</code></p>
<p>在ida的local_types中找到了vdq::Operation的定义,这是一个枚举类型</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">FFFFFFFF ; <span class="class"><span class="keyword">enum</span> <span class="title">vdq</span>:</span>:Operation, copyof_397, width <span class="number">1</span> byte</span><br><span class="line">FFFFFFFF vdq::Operation::Add  = <span class="number">0</span></span><br><span class="line">FFFFFFFF vdq::Operation::Remove  = <span class="number">1</span></span><br><span class="line">FFFFFFFF vdq::Operation::Append  = <span class="number">2</span></span><br><span class="line">FFFFFFFF vdq::Operation::Archive  = <span class="number">3</span></span><br><span class="line">FFFFFFFF vdq::Operation::View  = <span class="number">4</span></span><br></pre></td></tr></table></figure>
<p>所以我们需要一次性输入所有的操作,类似这样</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span><span class="string">&quot;Add&quot;</span><span class="punctuation">,</span><span class="string">&quot;Remove&quot;</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>
<p>然后再起一行输入<code>$</code></p>
<p>采用如下fuzz</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># fuzz.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="keyword">while</span> ((<span class="number">1</span>))</span><br><span class="line"><span class="keyword">do</span> </span><br><span class="line">    python ./vdq_input_gen.py &gt; poc</span><br><span class="line">    <span class="built_in">cat</span> poc | ./vdq</span><br><span class="line">    <span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">break</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vdq_input_gen.py</span></span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">operations = <span class="string">&quot;[&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Add</span>():</span><br><span class="line">    <span class="keyword">global</span> operations</span><br><span class="line">    operations += <span class="string">&quot;\&quot;Add\&quot;, &quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Remove</span>():</span><br><span class="line">    <span class="keyword">global</span> operations</span><br><span class="line">    operations += <span class="string">&quot;\&quot;Remove\&quot;, &quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Append</span>():</span><br><span class="line">    <span class="keyword">global</span> operations</span><br><span class="line">    operations += <span class="string">&quot;\&quot;Append\&quot;, &quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">View</span>():</span><br><span class="line">    <span class="keyword">global</span> operations</span><br><span class="line">    operations += <span class="string">&quot;\&quot;View\&quot;, &quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Archive</span>():</span><br><span class="line">    <span class="keyword">global</span> operations</span><br><span class="line">    operations += <span class="string">&quot;\&quot;Archive\&quot;, &quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DoOperations</span>():</span><br><span class="line">    <span class="built_in">print</span>(operations[:-<span class="number">2</span>] + <span class="string">&quot;]&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;$&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DoAdd</span>(<span class="params">message</span>):</span><br><span class="line">    <span class="built_in">print</span>(message)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DoAppend</span>(<span class="params">message</span>):</span><br><span class="line">    <span class="built_in">print</span>(message)</span><br><span class="line"></span><br><span class="line">total_ops = random.randint(<span class="number">1</span>, <span class="number">100</span>)</span><br><span class="line">total_adds = <span class="number">0</span></span><br><span class="line">total_append = <span class="number">0</span></span><br><span class="line">total_remove = <span class="number">0</span></span><br><span class="line">total_message = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(total_ops):</span><br><span class="line">    op = random.randint(<span class="number">0</span>, <span class="number">4</span>)</span><br><span class="line">    <span class="keyword">if</span> op == <span class="number">0</span>:</span><br><span class="line">        total_message += <span class="number">1</span></span><br><span class="line">        total_adds += <span class="number">1</span></span><br><span class="line">        Add()</span><br><span class="line">    <span class="keyword">elif</span> op == <span class="number">1</span>:</span><br><span class="line">        total_adds -= <span class="number">1</span></span><br><span class="line">        Remove()</span><br><span class="line">    <span class="keyword">elif</span> op == <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">if</span> total_adds &gt; <span class="number">0</span>:</span><br><span class="line">            total_append += <span class="number">1</span></span><br><span class="line">            total_message += <span class="number">1</span></span><br><span class="line">            Append()</span><br><span class="line">        Append()</span><br><span class="line">    <span class="keyword">elif</span> op == <span class="number">3</span>:</span><br><span class="line">        total_adds = <span class="number">0</span></span><br><span class="line">        total_append = <span class="number">0</span></span><br><span class="line">        total_remove = <span class="number">0</span></span><br><span class="line">        Archive()</span><br><span class="line">    <span class="keyword">elif</span> op == <span class="number">4</span>:</span><br><span class="line">        View()</span><br><span class="line">DoOperations()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(total_message):</span><br><span class="line">    DoAdd(<span class="string">&#x27;&#x27;</span>.join(random.sample(string.ascii_letters + string.digits, random.randint(<span class="number">1</span>, <span class="number">40</span>))))</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>fuzz-in-pwn</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="https://ixout.github.io/posts/53981/">https://ixout.github.io/posts/53981/</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>作者</h><div class="post-copyright-cc-info"><h>ixout</h></div></div><div class="post-copyright-c"><h>发布于</h><div class="post-copyright-cc-info"><h>2024-05-12</h></div></div><div class="post-copyright-u"><h>更新于</h><div class="post-copyright-cc-info"><h>2024-05-21</h></div></div><div class="post-copyright-c"><h>许可协议</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/fuzz/">fuzz</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/ixout/picture@main/img/865885b088167c2d2ec.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/22716/" title="2024ciscn华东南pwn"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/ixout/picture@main/img/676eab85f89e48508a.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">2024ciscn华东南pwn</div></div></a></div><div class="next-post pull-right"><a href="/posts/2980/" title="几道iotpwn题目复现"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/ixout/picture@main/img/8373377e69c3499d90.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">几道iotpwn题目复现</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-author"><div class="item-headline"><i class="fa-solid fa-circle-user"></i><span>Author</span></div><div class="author-main-content"><div class="author-check-content"><label class="author-info" for="author-info">     <input id="author-info" type="checkbox" name="author-info"/><div class="author-avatar"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/touxiang.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-name">ixout</div></label></div><div class="author-switch-content"><input class="switch-content" type="radio" name="switch-content" value="description"/><label class="author-description-box">      <div class="author-description"><font color="#e66b6d">十八线业余选手</font></div></label><input class="switch-content" type="radio" name="switch-content" value="social" checked="checked"/><label class="author-social-box"><a class="card-author-button" target="_blank" rel="noopener" href="https://github.com/ixout"><i class="iconfont icon-github"></i><span>Follow Me With Github</span></a><div class="social-icons"><a class="social-icon" href="https://github.com/ixout" target="_blank" title="Github"><i class="fa-brands fa-github"></i></a><a class="social-icon" href="/1425430423" target="_blank" title="QQ"><i class="fa-brands fa-qq"></i></a></div></label><input class="switch-content" type="radio" name="switch-content" value="site-data"/><label class="author-data-box"><div class="site-data"><a class="data-item" href="/archives/"><div class="data-name">文章</div><div class="data-length">60</div></a><a class="data-item" href="/tags/"><div class="data-name">标签</div><div class="data-length">65</div></a><a class="data-item" href="/categories/"><div class="data-name">分类</div><div class="data-length">5</div></a></div></label></div></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>告示牌</span></div><div class="announcement_content"><font color="＃00CED1">(º﹃º)阿巴阿巴阿巴......</font></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#2022ACTF-treepwn"><span class="toc-number">1.</span> <span class="toc-text">2022ACTF-treepwn</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-number">2.</span> <span class="toc-text">环境准备</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F"><span class="toc-number">2.1.</span> <span class="toc-text">注意</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#BYTECTF2021-byteview"><span class="toc-number">3.</span> <span class="toc-text">BYTECTF2021-byteview</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8AFLFUzz"><span class="toc-number">3.1.</span> <span class="toc-text">利用AFLFUzz</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%9E%E6%A0%87%E5%87%86fuzz"><span class="toc-number">3.2.</span> <span class="toc-text">非标准fuzz</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">3.2.1.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E8%B6%B3%E4%B8%8E%E6%94%B9%E8%BF%9B"><span class="toc-number">3.2.2.</span> <span class="toc-text">不足与改进</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%99%8E%E7%AC%A6%E5%AE%89%E5%85%A82022-vdq"><span class="toc-number">4.</span> <span class="toc-text">虎符安全2022-vdq</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2024 By ixout</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><a class="icon-V hidden" onclick="switchNightMode()" title="浅色和深色模式转换"><svg width="25" height="25" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button><button id="go-down" type="button" title="直达底部" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"></div><canvas id="universe"></canvas><script defer src="/js/universe.js"></script><script defer src="/js/cursor.js"></script><script async src="/js/fps.js"></script><script async src="/js/title.js"></script><script src="/js/sun_moon.js" async></script><script async src="//at.alicdn.com/t/c/font_3930344_38rvofbfw64.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="true"></script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="false" data-text="富强,民主,文明,和谐,自由,平等,公正,法治,爱国,敬业,诚信,友善" data-fontsize="20px" data-random="false" async="async"></script></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div><!-- hexo injector body_end start --><script async src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><!-- hexo injector body_end end --></body></html>